<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pr√Ñperty</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body, #root { height: 100%; width: 100%; overflow: hidden; }
  body {
    font-family: 'DM Sans', system-ui, sans-serif;
    background: #06060b;
    -webkit-font-smoothing: antialiased;
  }
  h1,h2,h3,h4,h5,h6 { font-family: 'Sora', system-ui, sans-serif; }
  input, select { font-family: 'DM Sans', system-ui, sans-serif; }
  .form-input:focus { border-color: rgba(212,168,83,0.5) !important; outline: none; }

  @keyframes slideUp { from { opacity:0; transform:translateY(24px); } to { opacity:1; transform:translateY(0); } }
  @keyframes slideRight { from { opacity:0; transform:translateX(-24px); } to { opacity:1; transform:translateX(0); } }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  @keyframes scanLine { 0%,100% { top:8%; } 50% { top:88%; } }
  @keyframes pulse { 0%,100% { opacity:0.4; } 50% { opacity:0.8; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes spinReverse { to { transform: rotate(-360deg); } }
  @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

  .anim-up { animation: slideUp 0.5s ease-out both; }
  .anim-right { animation: slideRight 0.5s ease-out both; }
  .anim-fade { animation: fadeIn 0.4s ease-out both; }

  .scroll-hide::-webkit-scrollbar { display: none; }
  .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }

  .glass { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(16px); }
  .glass-hover:hover { background: rgba(255,255,255,0.08); }

  .gradient-amber { background: linear-gradient(135deg, #d4a853, #b8860b); }
  .gradient-dark { background: linear-gradient(180deg, #0a0a0f 0%, #0d0d14 50%, #0a0a0f 100%); }

  .text-gold { color: #d4a853; }
  .text-muted { color: #64748b; }
  .text-dim { color: #475569; }
  .bg-gold { background-color: #d4a853; }

  .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  select option { background: #1e293b; color: white; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ‚îÄ‚îÄ Supabase Client ‚îÄ‚îÄ */
const SUPABASE_URL = 'https://tzasuddushojjurbzqfe.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YXN1ZGR1c2hvamp1cmJ6cWZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjU1MTUsImV4cCI6MjA4NjE0MTUxNX0.vKGMXcTkddpCwzH-zRPPzbVNWCvx5UNHNxdtvFZNZIM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ‚îÄ‚îÄ Supabase Sync Helpers ‚îÄ‚îÄ */
const syncProfile = async (profile) => {
  if (!profile || !profile.email) return null;
  try {
    // Check if profile exists by email
    const { data: existing } = await supabase.from('profiles').select('id').eq('email', profile.email).single();
    if (existing) {
      await supabase.from('profiles').update({ name: profile.name }).eq('id', existing.id);
      return existing.id;
    } else {
      const { data: created } = await supabase.from('profiles').insert({ name: profile.name, email: profile.email }).select('id').single();
      await logEvent(created?.id, 'user_signup', { name: profile.name });
      return created?.id || null;
    }
  } catch(e) { console.log('Sync profile error:', e); return null; }
};

const syncItem = async (item, userId) => {
  if (!userId) return;
  try {
    const row = {
      id: item.id, user_id: userId, name: item.name, brand: item.brand || '', model: item.model || '',
      category: item.category || 'Other', condition: item.condition || 'Good',
      cost: item.cost || 0, asking: item.asking || 0, value: item.value || 0,
      earnings: item.earnings || null, emoji: item.emoji || 'üì¶', notes: item.notes || '',
      date_purchased: item.datePurchased || null, date_sold: item.dateSold || null,
      photos: JSON.stringify(item.photos || []), comps: JSON.stringify(item.comps || []),
      price_history: JSON.stringify(item.priceHistory || []),
    };
    await supabase.from('items').upsert(row, { onConflict: 'id' });
  } catch(e) { console.log('Sync item error:', e); }
};

const syncDeleteItem = async (itemId) => {
  try { await supabase.from('items').delete().eq('id', itemId); } catch(e) { console.log('Delete sync error:', e); }
};

const syncAllItems = async (items, userId) => {
  if (!userId || items.length === 0) return;
  try {
    const rows = items.map(item => ({
      id: item.id, user_id: userId, name: item.name, brand: item.brand || '', model: item.model || '',
      category: item.category || 'Other', condition: item.condition || 'Good',
      cost: item.cost || 0, asking: item.asking || 0, value: item.value || 0,
      earnings: item.earnings || null, emoji: item.emoji || 'üì¶', notes: item.notes || '',
      date_purchased: item.datePurchased || null, date_sold: item.dateSold || null,
      photos: JSON.stringify(item.photos || []), comps: JSON.stringify(item.comps || []),
      price_history: JSON.stringify(item.priceHistory || []),
    }));
    await supabase.from('items').upsert(rows, { onConflict: 'id' });
  } catch(e) { console.log('Bulk sync error:', e); }
};

const logEvent = async (userId, eventType, metadata = {}) => {
  try {
    await supabase.from('analytics_events').insert({ user_id: userId, event_type: eventType, metadata });
  } catch(e) { console.log('Event log error:', e); }
};

/* ‚îÄ‚îÄ Discover / Community Search Helpers ‚îÄ‚îÄ */
const searchCommunityItems = async (query, category = 'All') => {
  try {
    let q = supabase.from('items').select('name, brand, model, category, condition, cost, asking, value, earnings, emoji, comps, date_sold, created_at');
    if (query && query.trim()) {
      q = q.or(`name.ilike.%${query}%,brand.ilike.%${query}%,model.ilike.%${query}%`);
    }
    if (category && category !== 'All') q = q.eq('category', category);
    q = q.order('created_at', { ascending: false }).limit(100);
    const { data, error } = await q;
    if (error) throw error;
    return (data || []).map(it => ({
      ...it,
      comps: typeof it.comps === 'string' ? JSON.parse(it.comps) : (it.comps || []),
    }));
  } catch(e) { console.log('Community search error:', e); return []; }
};

const fetchCommunityComps = async (itemName, itemBrand) => {
  try {
    const terms = [itemName, itemBrand].filter(Boolean);
    if (terms.length === 0) return [];
    let q = supabase.from('items').select('name, brand, comps, value, earnings');
    q = q.or(terms.map(t => `name.ilike.%${t}%`).join(','));
    q = q.limit(50);
    const { data, error } = await q;
    if (error) throw error;
    const allComps = [];
    (data || []).forEach(it => {
      const comps = typeof it.comps === 'string' ? JSON.parse(it.comps) : (it.comps || []);
      comps.forEach(c => {
        if (c.price > 0) allComps.push({ ...c, fromItem: it.name, fromBrand: it.brand });
      });
    });
    // Dedupe by title+price
    const seen = new Set();
    return allComps.filter(c => {
      const key = (c.title + c.price).toLowerCase();
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  } catch(e) { console.log('Community comps error:', e); return []; }
};

/* ‚îÄ‚îÄ Inline SVG Icons ‚îÄ‚îÄ */
const Icon = ({d, size=20, color="currentColor", strokeWidth=2}) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round">
    <path d={d}/>
  </svg>
);

const Icons = {
  Home: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
  Camera: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>,
  Search: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  Bell: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>,
  User: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  ArrowLeft: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
  Grid: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
  List: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
  TrendUp: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
  TrendDown: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
  ChevronRight: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
  Plus: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Upload: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></svg>,
  Filter: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
  Shield: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
  Download: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
  Help: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  LogOut: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
  Share: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
  Refresh: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>,
  Edit: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>,
  Zap: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
  Package: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
  Dollar: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>,
  BarChart: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>,
  Clock: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  Info: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
  Trash2: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
  AlertTriangle: ({size=20,color="currentColor"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
};

/* ‚îÄ‚îÄ Data ‚îÄ‚îÄ */
const priceHistory = [
  {m:'Sep',v:1270},{m:'Oct',v:1285},{m:'Nov',v:1310},{m:'Dec',v:1350},{m:'Jan',v:1385},{m:'Feb',v:1420}
];


/* ‚îÄ‚îÄ Mini Chart Component ‚îÄ‚îÄ */
const PriceChart = ({ data, width=320, height=160 }) => {
  const vals = data.map(d => d.v);
  const min = Math.min(...vals) - 20;
  const max = Math.max(...vals) + 20;
  const range = max - min;
  const pad = { top:12, right:12, bottom:28, left:48 };
  const cw = width - pad.left - pad.right;
  const ch = height - pad.top - pad.bottom;

  const pts = data.map((d, i) => ({
    x: pad.left + (i / (data.length - 1)) * cw,
    y: pad.top + ch - ((d.v - min) / range) * ch,
  }));

  const linePath = pts.map((p,i) => `${i===0?'M':'L'}${p.x},${p.y}`).join(' ');
  const areaPath = linePath + ` L${pts[pts.length-1].x},${pad.top+ch} L${pts[0].x},${pad.top+ch} Z`;

  return (
    <svg width="100%" viewBox={`0 0 ${width} ${height}`} style={{display:'block'}}>
      <defs>
        <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stopColor="#d4a853" stopOpacity="0.3"/>
          <stop offset="100%" stopColor="#d4a853" stopOpacity="0"/>
        </linearGradient>
      </defs>
      {/* Grid lines */}
      {[0,0.25,0.5,0.75,1].map((pct,i) => {
        const y = pad.top + ch * (1 - pct);
        const val = Math.round(min + range * pct);
        return <g key={i}>
          <line x1={pad.left} y1={y} x2={width-pad.right} y2={y} stroke="rgba(255,255,255,0.06)" strokeWidth="1"/>
          <text x={pad.left-8} y={y+4} fill="#64748b" fontSize="10" textAnchor="end" fontFamily="DM Sans">${val}</text>
        </g>;
      })}
      {/* X labels */}
      {data.map((d,i) => (
        <text key={i} x={pts[i].x} y={height-6} fill="#64748b" fontSize="10" textAnchor="middle" fontFamily="DM Sans">{d.m}</text>
      ))}
      {/* Area + Line */}
      <path d={areaPath} fill="url(#areaGrad)"/>
      <path d={linePath} fill="none" stroke="#d4a853" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
      {/* Dots */}
      {pts.map((p,i) => <circle key={i} cx={p.x} cy={p.y} r="4" fill="#0a0a0f" stroke="#d4a853" strokeWidth="2"/>)}
    </svg>
  );
};

/* ‚îÄ‚îÄ Stable components (defined outside App to prevent unmount/remount on re-render) ‚îÄ‚îÄ */
const InfoTip = ({text, align}) => {
  const [show, setShow] = useState(false);
  const ref = React.useRef(null);
  const [pos, setPos] = useState('center');
  React.useEffect(() => {
    if (show && ref.current) {
      const rect = ref.current.getBoundingClientRect();
      if (rect.right + 90 > window.innerWidth) setPos('right');
      else if (rect.left - 90 < 0) setPos('left');
      else setPos('center');
    }
  }, [show]);
  const tipPos = align || pos;
  const tipStyle = tipPos === 'right'
    ? {right:0, transform:'none'}
    : tipPos === 'left'
    ? {left:0, transform:'none'}
    : {left:'50%', transform:'translateX(-50%)'};
  const arrowStyle = tipPos === 'right'
    ? {right:12, transform:'rotate(45deg)'}
    : tipPos === 'left'
    ? {left:12, transform:'rotate(45deg)'}
    : {left:'50%', transform:'translateX(-50%) rotate(45deg)'};
  return (
    <div ref={ref} style={{position:'relative',display:'inline-flex',marginLeft:6}} onMouseEnter={() => setShow(true)} onMouseLeave={() => setShow(false)} onClick={(e) => {e.stopPropagation();setShow(!show);}}>
      <Icons.Info size={14} color="#64748b"/>
      {show && (
        <div className="anim-fade" style={{position:'absolute',bottom:'calc(100% + 8px)',...tipStyle,background:'#1e293b',border:'1px solid rgba(255,255,255,0.15)',borderRadius:10,padding:'10px 14px',fontSize:12,color:'#cbd5e1',whiteSpace:'normal',width:180,zIndex:50,boxShadow:'0 8px 24px rgba(0,0,0,0.5)',lineHeight:1.5,fontFamily:'DM Sans, sans-serif'}}>
          {text}
          <div style={{position:'absolute',bottom:-5,...arrowStyle,width:10,height:10,background:'#1e293b',borderRight:'1px solid rgba(255,255,255,0.15)',borderBottom:'1px solid rgba(255,255,255,0.15)'}}/>
        </div>
      )}
    </div>
  );
};

const FormField = ({label, required, children, tip}) => (
  <div style={{marginBottom:16}}>
    <div style={{display:'flex',alignItems:'center',marginBottom:6}}>
      <label style={{fontSize:12,fontWeight:600,color:'#94a3b8',textTransform:'uppercase',letterSpacing:0.5}}>{label}{required && <span style={{color:'#d4a853'}}> *</span>}</label>
      {tip && <InfoTip text={tip}/>}
    </div>
    {children}
  </div>
);

/* ‚îÄ‚îÄ Main App ‚îÄ‚îÄ */
const App = () => {
  // Load from localStorage (start fresh with empty inventory)
  const loadItems = () => {
    try {
      const saved = localStorage.getItem('item2value_items');
      if (saved) return JSON.parse(saved);
      return [];
    } catch(e) { return []; }
  };

  const loadProfile = () => {
    try {
      const saved = localStorage.getItem('item2value_profile');
      if (saved) return JSON.parse(saved);
      return null;
    } catch(e) { return null; }
  };

  const [profile, setProfile] = useState(loadProfile);
  const [items, setItems] = useState(loadItems);
  const [screen, setScreen] = useState(loadProfile() ? 'home' : 'setup');
  const [editingProfile, setEditingProfile] = useState(false);
  const profileNameRef = useRef(null);
  const profileEmailRef = useRef(null);
  const [selectedId, setSelectedId] = useState(null);
  const [photoIndex, setPhotoIndex] = useState(0);
  const [viewMode, setViewMode] = useState('grid');
  const [filter, setFilter] = useState('All');
  const [search, setSearch] = useState('');
  const [sortBy, setSortBy] = useState('value-high');
  const [scanning, setScanning] = useState(false);
  const [analyzing, setAnalyzing] = useState(false);
  const [aiDone, setAiDone] = useState(false);
  const [editingCost, setEditingCost] = useState(false);
  const [editingAsking, setEditingAsking] = useState(false);
  const [editingMarket, setEditingMarket] = useState(false);
  const [editingEarnings, setEditingEarnings] = useState(false);
  const [costInput, setCostInput] = useState('');
  const [askingInput, setAskingInput] = useState('');
  const [marketInput, setMarketInput] = useState('');
  const [earningsInput, setEarningsInput] = useState('');
  const [editFormUI, setEditFormUI] = useState({category:'Fashion',condition:'Good',emoji:'üì¶',photos:[]});
  const editRefs = {
    name: useRef(null),
    brand: useRef(null),
    model: useRef(null),
    notes: useRef(null),
  };
  const [soldFilter, setSoldFilter] = useState('All');
  const [soldSearch, setSoldSearch] = useState('');
  const [soldSort, setSoldSort] = useState('recent');
  const [addingComp, setAddingComp] = useState(false);
  const [editingCompId, setEditingCompId] = useState(null);
  const [compForm, setCompForm] = useState({title:'',url:'',price:'',source:'eBay',condition:'Good'});
  const updateCompForm = (key, val) => setCompForm(prev => ({...prev, [key]: val}));
  const [showClearConfirm, setShowClearConfirm] = useState(false);
  const [showTutorial, setShowTutorial] = useState(false);
  const [tutorialStep, setTutorialStep] = useState(0);
  const [discoverQuery, setDiscoverQuery] = useState('');
  const [discoverResults, setDiscoverResults] = useState([]);
  const [discoverLoading, setDiscoverLoading] = useState(false);
  const [discoverCategory, setDiscoverCategory] = useState('All');
  const [discoverSearched, setDiscoverSearched] = useState(false);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const searchInputRef = useRef(null);
  const [addItemQuery, setAddItemQuery] = useState('');
  const [showAddSuggestions, setShowAddSuggestions] = useState(false);

  /* ‚îÄ‚îÄ Product Knowledge Base (for autocomplete across Discover + Add Item) ‚îÄ‚îÄ */
  const PRODUCT_DB = [
    // Fashion - Bags
    {name:'Louis Vuitton Neverfull MM',brand:'Louis Vuitton',model:'Neverfull MM',cat:'Fashion',emoji:'üëú'},
    {name:'Louis Vuitton Speedy 30',brand:'Louis Vuitton',model:'Speedy 30',cat:'Fashion',emoji:'üëú'},
    {name:'Louis Vuitton Pochette Metis',brand:'Louis Vuitton',model:'Pochette Metis',cat:'Fashion',emoji:'üëú'},
    {name:'Chanel Classic Flap Medium',brand:'Chanel',model:'Classic Flap Medium',cat:'Fashion',emoji:'üëú'},
    {name:'Chanel Boy Bag',brand:'Chanel',model:'Boy Bag',cat:'Fashion',emoji:'üëú'},
    {name:'Hermes Birkin 25',brand:'Hermes',model:'Birkin 25',cat:'Fashion',emoji:'üëú'},
    {name:'Hermes Birkin 30',brand:'Hermes',model:'Birkin 30',cat:'Fashion',emoji:'üëú'},
    {name:'Hermes Kelly 28',brand:'Hermes',model:'Kelly 28',cat:'Fashion',emoji:'üëú'},
    {name:'Gucci GG Marmont',brand:'Gucci',model:'GG Marmont',cat:'Fashion',emoji:'üëú'},
    {name:'Gucci Dionysus',brand:'Gucci',model:'Dionysus',cat:'Fashion',emoji:'üëú'},
    // Fashion - Sneakers (with colorways)
    {name:'Jordan 1 Retro High Chicago',brand:'Nike',model:'Air Jordan 1 High OG',cat:'Fashion',emoji:'üëü'},
    {name:'Jordan 1 Retro High Bred',brand:'Nike',model:'Air Jordan 1 High OG',cat:'Fashion',emoji:'üëü'},
    {name:'Jordan 1 Retro High Royal',brand:'Nike',model:'Air Jordan 1 High OG',cat:'Fashion',emoji:'üëü'},
    {name:'Jordan 1 Retro Low Travis Scott',brand:'Nike',model:'Air Jordan 1 Low',cat:'Fashion',emoji:'üëü'},
    {name:'Jordan 4 Retro Bred',brand:'Nike',model:'Air Jordan 4',cat:'Fashion',emoji:'üëü'},
    {name:'Jordan 4 Retro Military Black',brand:'Nike',model:'Air Jordan 4',cat:'Fashion',emoji:'üëü'},
    {name:'Jordan 11 Retro Concord',brand:'Nike',model:'Air Jordan 11',cat:'Fashion',emoji:'üëü'},
    {name:'Nike Dunk Low Panda',brand:'Nike',model:'Dunk Low',cat:'Fashion',emoji:'üëü'},
    {name:'Nike Dunk Low Grey Fog',brand:'Nike',model:'Dunk Low',cat:'Fashion',emoji:'üëü'},
    {name:'Nike Air Force 1 Low White',brand:'Nike',model:'Air Force 1 07',cat:'Fashion',emoji:'üëü'},
    {name:'Nike Air Max 90',brand:'Nike',model:'Air Max 90',cat:'Fashion',emoji:'üëü'},
    {name:'Nike Air Max 1',brand:'Nike',model:'Air Max 1',cat:'Fashion',emoji:'üëü'},
    {name:'Adidas Yeezy Boost 350 V2 Zebra',brand:'Adidas',model:'Yeezy Boost 350 V2',cat:'Fashion',emoji:'üëü'},
    {name:'Adidas Yeezy Boost 350 V2 Bred',brand:'Adidas',model:'Yeezy Boost 350 V2',cat:'Fashion',emoji:'üëü'},
    {name:'Adidas Yeezy Slide Onyx',brand:'Adidas',model:'Yeezy Slide',cat:'Fashion',emoji:'üëü'},
    {name:'Adidas Samba OG',brand:'Adidas',model:'Samba OG',cat:'Fashion',emoji:'üëü'},
    {name:'New Balance 550 White Green',brand:'New Balance',model:'550',cat:'Fashion',emoji:'üëü'},
    {name:'New Balance 2002R',brand:'New Balance',model:'2002R',cat:'Fashion',emoji:'üëü'},
    {name:'ASICS Gel-Kayano 14',brand:'ASICS',model:'Gel-Kayano 14',cat:'Fashion',emoji:'üëü'},
    // Fashion - Apparel
    {name:'Supreme Box Logo Hoodie',brand:'Supreme',model:'Box Logo Hoodie',cat:'Fashion',emoji:'üß•'},
    {name:'Canada Goose Expedition Parka',brand:'Canada Goose',model:'Expedition Parka',cat:'Fashion',emoji:'üß•'},
    {name:'North Face Nuptse 700',brand:'The North Face',model:'Nuptse 700',cat:'Fashion',emoji:'üß•'},
    {name:'Lululemon Align Leggings',brand:'Lululemon',model:'Align 25"',cat:'Fashion',emoji:'üëú'},
    {name:'Ray-Ban Wayfarer',brand:'Ray-Ban',model:'Wayfarer',cat:'Fashion',emoji:'üëú'},
    {name:'Patagonia Retro-X Fleece',brand:'Patagonia',model:'Retro-X',cat:'Fashion',emoji:'üß•'},
    // Electronics - iPhones (with model/year depth)
    {name:'iPhone 16 Pro Max',brand:'Apple',model:'iPhone 16 Pro Max',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 16 Pro',brand:'Apple',model:'iPhone 16 Pro',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 16',brand:'Apple',model:'iPhone 16',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 15 Pro Max',brand:'Apple',model:'iPhone 15 Pro Max',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 15 Pro',brand:'Apple',model:'iPhone 15 Pro',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 15',brand:'Apple',model:'iPhone 15',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 14 Pro Max',brand:'Apple',model:'iPhone 14 Pro Max',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 14 Pro',brand:'Apple',model:'iPhone 14 Pro',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 14',brand:'Apple',model:'iPhone 14',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 13 Pro',brand:'Apple',model:'iPhone 13 Pro',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone 13',brand:'Apple',model:'iPhone 13',cat:'Electronics',emoji:'üì±'},
    {name:'iPhone SE 2022',brand:'Apple',model:'iPhone SE 3rd Gen',cat:'Electronics',emoji:'üì±'},
    // Electronics - Samsung
    {name:'Samsung Galaxy S24 Ultra',brand:'Samsung',model:'Galaxy S24 Ultra',cat:'Electronics',emoji:'üì±'},
    {name:'Samsung Galaxy S24',brand:'Samsung',model:'Galaxy S24',cat:'Electronics',emoji:'üì±'},
    {name:'Samsung Galaxy S23 Ultra',brand:'Samsung',model:'Galaxy S23 Ultra',cat:'Electronics',emoji:'üì±'},
    {name:'Samsung Galaxy Z Fold 5',brand:'Samsung',model:'Galaxy Z Fold 5',cat:'Electronics',emoji:'üì±'},
    {name:'Samsung Galaxy Z Flip 5',brand:'Samsung',model:'Galaxy Z Flip 5',cat:'Electronics',emoji:'üì±'},
    // Electronics - Laptops
    {name:'MacBook Pro 16 M3 Max',brand:'Apple',model:'MacBook Pro 16" M3 Max',cat:'Electronics',emoji:'üíª'},
    {name:'MacBook Pro 14 M3 Pro',brand:'Apple',model:'MacBook Pro 14" M3 Pro',cat:'Electronics',emoji:'üíª'},
    {name:'MacBook Air 15 M3',brand:'Apple',model:'MacBook Air 15" M3',cat:'Electronics',emoji:'üíª'},
    {name:'MacBook Air 13 M3',brand:'Apple',model:'MacBook Air 13" M3',cat:'Electronics',emoji:'üíª'},
    // Electronics - Other
    {name:'iPad Pro 12.9 M2',brand:'Apple',model:'iPad Pro 12.9" M2',cat:'Electronics',emoji:'üíª'},
    {name:'iPad Air M2',brand:'Apple',model:'iPad Air M2',cat:'Electronics',emoji:'üíª'},
    {name:'AirPods Pro 2',brand:'Apple',model:'AirPods Pro 2nd Gen',cat:'Electronics',emoji:'üì±'},
    {name:'AirPods Max',brand:'Apple',model:'AirPods Max',cat:'Electronics',emoji:'üì±'},
    {name:'PlayStation 5 Slim',brand:'Sony',model:'PS5 Slim',cat:'Electronics',emoji:'üéÆ'},
    {name:'PlayStation 5 Digital',brand:'Sony',model:'PS5 Digital',cat:'Electronics',emoji:'üéÆ'},
    {name:'Nintendo Switch OLED',brand:'Nintendo',model:'Switch OLED',cat:'Electronics',emoji:'üéÆ'},
    {name:'Xbox Series X',brand:'Microsoft',model:'Series X',cat:'Electronics',emoji:'üéÆ'},
    {name:'Steam Deck OLED',brand:'Valve',model:'Steam Deck OLED',cat:'Electronics',emoji:'üéÆ'},
    {name:'Meta Quest 3',brand:'Meta',model:'Quest 3',cat:'Electronics',emoji:'üéÆ'},
    {name:'Sony A7 IV',brand:'Sony',model:'A7 IV',cat:'Electronics',emoji:'üì∑'},
    {name:'Canon EOS R5',brand:'Canon',model:'EOS R5',cat:'Electronics',emoji:'üì∑'},
    {name:'DJI Mini 4 Pro',brand:'DJI',model:'Mini 4 Pro',cat:'Electronics',emoji:'üì∑'},
    {name:'DJI Mavic 3 Pro',brand:'DJI',model:'Mavic 3 Pro',cat:'Electronics',emoji:'üì∑'},
    {name:'GoPro Hero 12',brand:'GoPro',model:'Hero 12 Black',cat:'Electronics',emoji:'üì∑'},
    {name:'Bose QuietComfort Ultra',brand:'Bose',model:'QC Ultra Headphones',cat:'Electronics',emoji:'üì±'},
    {name:'Sony WH-1000XM5',brand:'Sony',model:'WH-1000XM5',cat:'Electronics',emoji:'üì±'},
    {name:'Dyson Airwrap Complete',brand:'Dyson',model:'Airwrap Complete',cat:'Electronics',emoji:'üì±'},
    // Watches - Rolex variants
    {name:'Rolex Submariner Date',brand:'Rolex',model:'Submariner 126610LN',cat:'Watches',emoji:'‚åö'},
    {name:'Rolex Submariner No Date',brand:'Rolex',model:'Submariner 124060',cat:'Watches',emoji:'‚åö'},
    {name:'Rolex Daytona Ceramic',brand:'Rolex',model:'Daytona 116500LN',cat:'Watches',emoji:'‚åö'},
    {name:'Rolex GMT-Master II Pepsi',brand:'Rolex',model:'GMT-Master II 126710BLRO',cat:'Watches',emoji:'‚åö'},
    {name:'Rolex GMT-Master II Batman',brand:'Rolex',model:'GMT-Master II 126710BLNR',cat:'Watches',emoji:'‚åö'},
    {name:'Rolex Datejust 41',brand:'Rolex',model:'Datejust 126334',cat:'Watches',emoji:'‚åö'},
    {name:'Rolex Explorer I',brand:'Rolex',model:'Explorer 124270',cat:'Watches',emoji:'‚åö'},
    // Watches - Other brands
    {name:'Omega Speedmaster Moonwatch',brand:'Omega',model:'Speedmaster 310.30.42.50',cat:'Watches',emoji:'‚åö'},
    {name:'Omega Seamaster 300M',brand:'Omega',model:'Seamaster Diver 300M',cat:'Watches',emoji:'‚åö'},
    {name:'Patek Philippe Nautilus 5711',brand:'Patek Philippe',model:'Nautilus 5711/1A',cat:'Watches',emoji:'‚åö'},
    {name:'Patek Philippe Aquanaut',brand:'Patek Philippe',model:'Aquanaut 5167A',cat:'Watches',emoji:'‚åö'},
    {name:'Audemars Piguet Royal Oak 41mm',brand:'Audemars Piguet',model:'Royal Oak 15500ST',cat:'Watches',emoji:'‚åö'},
    {name:'Tudor Black Bay 58',brand:'Tudor',model:'Black Bay 58 79030N',cat:'Watches',emoji:'‚åö'},
    {name:'Tudor Pelagos',brand:'Tudor',model:'Pelagos 25600TN',cat:'Watches',emoji:'‚åö'},
    {name:'Seiko Presage Cocktail Time',brand:'Seiko',model:'Presage SRPB41',cat:'Watches',emoji:'‚åö'},
    {name:'Seiko SKX009',brand:'Seiko',model:'SKX009',cat:'Watches',emoji:'‚åö'},
    {name:'Casio G-Shock DW-5600',brand:'Casio',model:'G-Shock DW-5600E',cat:'Watches',emoji:'‚åö'},
    {name:'Casio G-Shock CasiOak',brand:'Casio',model:'G-Shock GA-2100',cat:'Watches',emoji:'‚åö'},
    {name:'Apple Watch Ultra 2',brand:'Apple',model:'Watch Ultra 2',cat:'Watches',emoji:'‚åö'},
    {name:'Cartier Tank Francaise',brand:'Cartier',model:'Tank Francaise',cat:'Watches',emoji:'‚åö'},
    {name:'Cartier Santos Medium',brand:'Cartier',model:'Santos de Cartier',cat:'Watches',emoji:'‚åö'},
    // Home
    {name:'Herman Miller Aeron',brand:'Herman Miller',model:'Aeron Size B',cat:'Home',emoji:'ü™ë'},
    {name:'Herman Miller Eames Lounge',brand:'Herman Miller',model:'Eames Lounge Chair',cat:'Home',emoji:'ü™ë'},
    {name:'Dyson V15 Detect',brand:'Dyson',model:'V15 Detect',cat:'Home',emoji:'ü™ë'},
    {name:'KitchenAid Artisan Mixer',brand:'KitchenAid',model:'Artisan 5qt',cat:'Home',emoji:'üç≤'},
    {name:'Le Creuset Dutch Oven',brand:'Le Creuset',model:'Round Dutch Oven 5.5qt',cat:'Home',emoji:'üç≤'},
    {name:'Vitamix A3500',brand:'Vitamix',model:'A3500',cat:'Home',emoji:'üç≤'},
    {name:'Roomba j7+',brand:'iRobot',model:'Roomba j7+',cat:'Home',emoji:'ü™ë'},
    {name:'Bonsai Tree',brand:'',model:'',cat:'Home',emoji:'ü™¥'},
    {name:'Mid-Century Modern Chair',brand:'',model:'',cat:'Home',emoji:'ü™ë'},
    {name:'Vintage Persian Rug',brand:'',model:'',cat:'Home',emoji:'ü™ë'},
    {name:'Breville Barista Express',brand:'Breville',model:'Barista Express',cat:'Home',emoji:'üç≤'},
    // Trading Cards - Pokemon (with specific sets)
    {name:'Pokemon Charizard VMAX',brand:'Pokemon',model:'Charizard VMAX 074/073',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Pokemon Charizard Base Set',brand:'Pokemon',model:'Charizard 4/102',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Pokemon Pikachu Illustrator',brand:'Pokemon',model:'Pikachu Illustrator',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Pokemon Booster Box Scarlet Violet',brand:'Pokemon',model:'Scarlet & Violet Booster Box',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Pokemon Booster Box Evolving Skies',brand:'Pokemon',model:'Evolving Skies Booster Box',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Pokemon ETB 151',brand:'Pokemon',model:'151 Elite Trainer Box',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Pokemon Japanese Booster Box',brand:'Pokemon',model:'Japanese Booster Box',cat:'Trading Cards',emoji:'üÉè'},
    // Trading Cards - MTG
    {name:'MTG Black Lotus',brand:'Magic: The Gathering',model:'Black Lotus Alpha',cat:'Trading Cards',emoji:'üÉè'},
    {name:'MTG Underground Sea',brand:'Magic: The Gathering',model:'Underground Sea Revised',cat:'Trading Cards',emoji:'üÉè'},
    {name:'MTG Mox Pearl',brand:'Magic: The Gathering',model:'Mox Pearl',cat:'Trading Cards',emoji:'üÉè'},
    // Trading Cards - Sports
    {name:'Topps Baseball Card',brand:'Topps',model:'Baseball Card',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Panini Prizm Basketball',brand:'Panini',model:'Prizm Basketball',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Panini Prizm Football',brand:'Panini',model:'Prizm Football',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Bowman Chrome Baseball',brand:'Bowman',model:'Chrome Baseball',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Upper Deck Hockey',brand:'Upper Deck',model:'Hockey Card',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Disney Lorcana Booster Box',brand:'Disney',model:'Lorcana Booster Box',cat:'Trading Cards',emoji:'üÉè'},
    {name:'One Piece Card Game Booster',brand:'Bandai',model:'One Piece TCG Booster',cat:'Trading Cards',emoji:'üÉè'},
    {name:'Yu-Gi-Oh Blue-Eyes White Dragon',brand:'Yu-Gi-Oh',model:'Blue-Eyes White Dragon LOB',cat:'Trading Cards',emoji:'üÉè'},
    // Collectibles - Comics (with specific issues)
    {name:'Amazing Spider-Man #129',brand:'Marvel',model:'1st Punisher',cat:'Collectibles',emoji:'üìö'},
    {name:'Amazing Spider-Man #300',brand:'Marvel',model:'1st Venom',cat:'Collectibles',emoji:'üìö'},
    {name:'Amazing Spider-Man #1',brand:'Marvel',model:'1st Issue 1963',cat:'Collectibles',emoji:'üìö'},
    {name:'Amazing Fantasy #15',brand:'Marvel',model:'1st Spider-Man',cat:'Collectibles',emoji:'üìö'},
    {name:'Incredible Hulk #181',brand:'Marvel',model:'1st Wolverine',cat:'Collectibles',emoji:'üìö'},
    {name:'X-Men #1 1963',brand:'Marvel',model:'1st X-Men',cat:'Collectibles',emoji:'üìö'},
    {name:'Batman #1 1940',brand:'DC Comics',model:'1st Issue',cat:'Collectibles',emoji:'üìö'},
    {name:'Detective Comics #27',brand:'DC Comics',model:'1st Batman',cat:'Collectibles',emoji:'üìö'},
    {name:'Action Comics #1',brand:'DC Comics',model:'1st Superman',cat:'Collectibles',emoji:'üìö'},
    {name:'Walking Dead #1',brand:'Image Comics',model:'1st Issue',cat:'Collectibles',emoji:'üìö'},
    // Collectibles - Figures
    {name:'Funko Pop Marvel Spider-Man',brand:'Funko',model:'Pop! Spider-Man',cat:'Collectibles',emoji:'üì¶'},
    {name:'Funko Pop Star Wars Grogu',brand:'Funko',model:'Pop! Grogu',cat:'Collectibles',emoji:'üì¶'},
    {name:'Funko Pop Anime Naruto',brand:'Funko',model:'Pop! Naruto',cat:'Collectibles',emoji:'üì¶'},
    {name:'Funko Pop Chase Variant',brand:'Funko',model:'Chase Variant',cat:'Collectibles',emoji:'üì¶'},
    {name:'Hot Toys Iron Man Mark 85',brand:'Hot Toys',model:'Iron Man Mark LXXXV',cat:'Collectibles',emoji:'üì¶'},
    {name:'Hot Toys Spider-Man',brand:'Hot Toys',model:'Spider-Man No Way Home',cat:'Collectibles',emoji:'üì¶'},
    {name:'Bearbrick 1000%',brand:'Medicom',model:'Bearbrick 1000%',cat:'Collectibles',emoji:'üì¶'},
    {name:'KAWS Companion Open Edition',brand:'KAWS',model:'Companion',cat:'Collectibles',emoji:'üì¶'},
    {name:'Sideshow Premium Format',brand:'Sideshow',model:'Premium Format Statue',cat:'Collectibles',emoji:'üì¶'},
    {name:'CGC Graded Comic',brand:'CGC',model:'Graded Comic Book',cat:'Collectibles',emoji:'üìö'},
    {name:'Sports Memorabilia Signed',brand:'',model:'Signed Item',cat:'Collectibles',emoji:'üì¶'},
    // Vinyl & Music
    {name:'Beatles Abbey Road Vinyl',brand:'The Beatles',model:'Abbey Road LP',cat:'Vinyl & Music',emoji:'üé∏'},
    {name:'Pink Floyd Dark Side Vinyl',brand:'Pink Floyd',model:'Dark Side of the Moon LP',cat:'Vinyl & Music',emoji:'üé∏'},
    {name:'Taylor Swift 1989 Vinyl',brand:'Taylor Swift',model:'1989 TV LP',cat:'Vinyl & Music',emoji:'üé∏'},
    {name:'Nirvana Nevermind Vinyl',brand:'Nirvana',model:'Nevermind LP',cat:'Vinyl & Music',emoji:'üé∏'},
    {name:'Radiohead OK Computer Vinyl',brand:'Radiohead',model:'OK Computer LP',cat:'Vinyl & Music',emoji:'üé∏'},
    {name:'Technics SL-1200',brand:'Technics',model:'SL-1200MK7',cat:'Vinyl & Music',emoji:'üé∏'},
    {name:'Limited Edition Vinyl',brand:'',model:'',cat:'Vinyl & Music',emoji:'üé∏'},
    // LEGO (with set numbers)
    {name:'LEGO Star Wars Millennium Falcon 75192',brand:'LEGO',model:'Millennium Falcon #75192',cat:'LEGO',emoji:'üß±'},
    {name:'LEGO Star Wars AT-AT 75313',brand:'LEGO',model:'AT-AT #75313',cat:'LEGO',emoji:'üß±'},
    {name:'LEGO Technic Bugatti Chiron',brand:'LEGO',model:'Bugatti Chiron #42083',cat:'LEGO',emoji:'üß±'},
    {name:'LEGO Technic Lamborghini',brand:'LEGO',model:'Lamborghini Sian #42115',cat:'LEGO',emoji:'üß±'},
    {name:'LEGO Creator Expert Taj Mahal',brand:'LEGO',model:'Taj Mahal #10256',cat:'LEGO',emoji:'üß±'},
    {name:'LEGO Ideas Tree House',brand:'LEGO',model:'Tree House #21318',cat:'LEGO',emoji:'üß±'},
    {name:'LEGO Architecture Colosseum',brand:'LEGO',model:'Colosseum #10276',cat:'LEGO',emoji:'üß±'},
    {name:'LEGO City Police Station',brand:'LEGO',model:'Police Station',cat:'LEGO',emoji:'üß±'},
    // Books
    {name:'Harry Potter First Edition Sorcerer Stone',brand:'J.K. Rowling',model:"Philosopher's Stone 1st Ed",cat:'Books',emoji:'üìö'},
    {name:'Harry Potter First Edition Chamber',brand:'J.K. Rowling',model:'Chamber of Secrets 1st Ed',cat:'Books',emoji:'üìö'},
    {name:'Signed Book Stephen King',brand:'Stephen King',model:'Signed First Edition',cat:'Books',emoji:'üìö'},
    {name:'Manga One Piece Box Set',brand:'Eiichiro Oda',model:'One Piece Box Set',cat:'Books',emoji:'üìö'},
    {name:'Manga Dragon Ball Complete',brand:'Akira Toriyama',model:'Dragon Ball Complete',cat:'Books',emoji:'üìö'},
    {name:'Rare First Edition',brand:'',model:'First Edition',cat:'Books',emoji:'üìö'},
    // Coins & Stamps
    {name:'American Silver Eagle 2024',brand:'US Mint',model:'Silver Eagle 1oz',cat:'Coins & Stamps',emoji:'üíé'},
    {name:'American Gold Eagle 1oz',brand:'US Mint',model:'Gold Eagle 1oz',cat:'Coins & Stamps',emoji:'üíé'},
    {name:'Morgan Silver Dollar 1921',brand:'US Mint',model:'Morgan Dollar 1921',cat:'Coins & Stamps',emoji:'üíé'},
    {name:'Morgan Silver Dollar 1878',brand:'US Mint',model:'Morgan Dollar 1878',cat:'Coins & Stamps',emoji:'üíé'},
    {name:'Peace Dollar',brand:'US Mint',model:'Peace Dollar',cat:'Coins & Stamps',emoji:'üíé'},
    {name:'PCGS MS-65 Graded Coin',brand:'PCGS',model:'MS-65 Graded',cat:'Coins & Stamps',emoji:'üíé'},
    {name:'Gold Krugerrand 1oz',brand:'South African Mint',model:'Krugerrand 1oz',cat:'Coins & Stamps',emoji:'üíé'},
    {name:'Rare Stamp Collection',brand:'',model:'',cat:'Coins & Stamps',emoji:'üíé'},
    // Sports
    {name:'Titleist Pro V1 Golf Clubs',brand:'Titleist',model:'Pro V1',cat:'Sports',emoji:'‚õ≥'},
    {name:'Wilson Pro Staff Tennis Racket',brand:'Wilson',model:'Pro Staff 97',cat:'Sports',emoji:'üéæ'},
    {name:'Peloton Bike+',brand:'Peloton',model:'Bike+',cat:'Sports',emoji:'üö≤'},
    {name:'Yeti Tundra 65 Cooler',brand:'Yeti',model:'Tundra 65',cat:'Sports',emoji:'üì¶'},
    {name:'Signed Baseball',brand:'',model:'Autographed',cat:'Sports',emoji:'‚öæ'},
    {name:'Signed Basketball',brand:'',model:'Autographed',cat:'Sports',emoji:'üèÄ'},
    // Art
    {name:'Original Oil Painting',brand:'',model:'',cat:'Art',emoji:'üñºÔ∏è'},
    {name:'Limited Edition Print Numbered',brand:'',model:'Numbered Print',cat:'Art',emoji:'üñºÔ∏è'},
    {name:'KAWS Print',brand:'KAWS',model:'Screenprint',cat:'Art',emoji:'üñºÔ∏è'},
    {name:'Banksy Print',brand:'Banksy',model:'',cat:'Art',emoji:'üñºÔ∏è'},
    {name:'Photography Print Signed',brand:'',model:'Signed Print',cat:'Art',emoji:'üñºÔ∏è'},
    // Automotive
    {name:'Car Parts OEM',brand:'',model:'OEM Parts',cat:'Automotive',emoji:'üöó'},
    {name:'Vintage Car Accessory',brand:'',model:'',cat:'Automotive',emoji:'üöó'},
    {name:'Aftermarket Wheels',brand:'',model:'',cat:'Automotive',emoji:'üöó'},
    // Tools
    {name:'Milwaukee M18 Fuel Drill',brand:'Milwaukee',model:'M18 Fuel',cat:'Tools',emoji:'üîß'},
    {name:'DeWalt 20V Max Combo Kit',brand:'DeWalt',model:'20V Max',cat:'Tools',emoji:'üîß'},
    {name:'Snap-On Socket Set',brand:'Snap-On',model:'Socket Set',cat:'Tools',emoji:'üîß'},
    {name:'Festool Track Saw',brand:'Festool',model:'TS 55 REQ',cat:'Tools',emoji:'üîß'},
    // Toys
    {name:'Vintage Star Wars Boba Fett',brand:'Kenner',model:'Boba Fett 1979',cat:'Toys',emoji:'üß∏'},
    {name:'Transformers G1 Optimus Prime',brand:'Hasbro',model:'G1 Optimus Prime',cat:'Toys',emoji:'üß∏'},
    {name:'American Girl Doll Samantha',brand:'American Girl',model:'Samantha',cat:'Toys',emoji:'üß∏'},
    {name:'Hot Wheels Treasure Hunt',brand:'Mattel',model:'Super Treasure Hunt',cat:'Toys',emoji:'üß∏'},
    {name:'Barbie Collector Limited',brand:'Mattel',model:'Barbie Collector',cat:'Toys',emoji:'üß∏'},
    {name:'Squishmallow 16 inch',brand:'Kellytoy',model:'Squishmallow 16"',cat:'Toys',emoji:'üß∏'},
    {name:'Beanie Baby Princess Diana',brand:'Ty',model:'Princess Bear',cat:'Toys',emoji:'üß∏'},
  ];

  const getSuggestions = (query, limit = 8) => {
    if (!query || query.trim().length === 0) return [];
    const q = query.toLowerCase().trim();
    const words = q.split(/\s+/);

    // 1. Match from user's own inventory
    const myItems = items
      .map(i => ({ text: [i.name, i.brand, i.model].filter(Boolean).join(' '), emoji: i.emoji, brand: i.brand, model: i.model, source: 'inventory' }))
      .filter(i => words.every(w => i.text.toLowerCase().includes(w)))
      .slice(0, 3);

    // 2. Match from product knowledge base
    const dbMatches = PRODUCT_DB
      .filter(p => words.every(w => (p.name + ' ' + p.brand + ' ' + p.model).toLowerCase().includes(w)))
      .filter(p => !myItems.some(m => m.text.toLowerCase() === p.name.toLowerCase()))
      .slice(0, 4)
      .map(p => ({ text: p.name, emoji: p.emoji, brand: p.brand, model: p.model, source: 'suggested' }));

    // 3. Dynamic smart suggestions (for queries that don't match anything)
    const dynamicSuggestions = [];
    if (myItems.length + dbMatches.length < 3) {
      const suffixes = ['vintage','used','new','rare','limited edition','lot','set','collection','parts','accessories','case','box','original'];
      const prefixes = ['vintage','rare','signed','limited','custom','original','authentic'];
      suffixes.forEach(s => {
        if (!q.includes(s)) dynamicSuggestions.push({ text: `${query.trim()} ${s}`, emoji: 'üîç', brand: '', model: '', source: 'dynamic' });
      });
      prefixes.forEach(p => {
        if (!q.includes(p)) dynamicSuggestions.push({ text: `${p} ${query.trim()}`, emoji: 'üîç', brand: '', model: '', source: 'dynamic' });
      });
    }

    return [...myItems, ...dbMatches, ...dynamicSuggestions.slice(0, Math.max(0, limit - myItems.length - dbMatches.length))].slice(0, limit);
  };
  const [communityComps, setCommunityComps] = useState([]);
  const [researchQuery, setResearchQuery] = useState('');
  const [researchData, setResearchData] = useState(null);
  const [researchLoading, setResearchLoading] = useState(false);
  const [scanMode, setScanMode] = useState('photo'); // 'photo' or 'barcode'
  const [scanData, setScanData] = useState(null); // pre-fill data from scan
  const [scanStatus, setScanStatus] = useState(''); // status message during scan
  const [barcodeScanning, setBarcodeScanning] = useState(false);
  const scannerRef = useRef(null);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const scrollRef = useRef(null);
  const supabaseUserIdRef = useRef(null);
  const syncTimerRef = useRef(null);

  // Save to localStorage whenever items or profile change (with overflow protection)
  useEffect(() => {
    try {
      localStorage.setItem('item2value_items', JSON.stringify(items));
    } catch(e) {
      alert('Storage is almost full! Your latest change may not have saved. Go to Profile > Export Backup to save your data, then try removing some photos.');
    }
    // Debounced sync to Supabase (waits 2s after last change to avoid spamming)
    if (syncTimerRef.current) clearTimeout(syncTimerRef.current);
    syncTimerRef.current = setTimeout(() => {
      if (supabaseUserIdRef.current && items.length > 0) {
        syncAllItems(items, supabaseUserIdRef.current);
      }
    }, 2000);
  }, [items]);
  useEffect(() => {
    if (profile) localStorage.setItem('item2value_profile', JSON.stringify(profile));
  }, [profile]);

  // On app load: sync profile to Supabase and get userId
  useEffect(() => {
    const initSync = async () => {
      const p = loadProfile();
      if (p && p.email) {
        const userId = await syncProfile(p);
        if (userId) {
          supabaseUserIdRef.current = userId;
          logEvent(userId, 'app_open', { name: p.name });
          // Sync any existing local items on first load
          const localItems = loadItems();
          if (localItems.length > 0) syncAllItems(localItems, userId);
        }
      }
    };
    initSync();
  }, []);

  // Record a price history snapshot (dedupes same-day entries)
  const recordPriceSnapshot = (itemId, value) => {
    const today = new Date().toISOString().slice(0,10);
    setItems(prev => prev.map(it => {
      if (it.id !== itemId) return it;
      const history = it.priceHistory || [];
      // If there's already a snapshot today, update it instead of adding duplicate
      const existing = history.findIndex(h => h.date === today);
      if (existing >= 0) {
        const updated = [...history];
        updated[existing] = {...updated[existing], value, cost: it.cost, asking: it.asking};
        return {...it, priceHistory: updated};
      }
      return {...it, priceHistory: [...history, {date: today, value, cost: it.cost, asking: it.asking}]};
    }));
  };

  // Auto-update market value from comps (average of all comp prices)
  const recalcMarketFromComps = (itemId) => {
    setItems(prev => prev.map(it => {
      if (it.id !== itemId) return it;
      const comps = it.comps || [];
      const prices = comps.map(c => c.price).filter(p => p > 0);
      if (prices.length === 0) return it;
      const avg = Math.round(prices.reduce((s,p) => s+p, 0) / prices.length);
      // Also record price history snapshot
      const today = new Date().toISOString().slice(0,10);
      const history = it.priceHistory || [];
      const existing = history.findIndex(h => h.date === today);
      let newHistory;
      if (existing >= 0) {
        newHistory = [...history];
        newHistory[existing] = {...newHistory[existing], value: avg, cost: it.cost, asking: it.asking};
      } else {
        newHistory = [...history, {date: today, value: avg, cost: it.cost, asking: it.asking}];
      }
      return {...it, value: avg, priceHistory: newHistory};
    }));
  };

  const getItemCost = (item) => item.cost;
  const getItemAsking = (item) => item.asking;
  const getItemGain = (item) => {
    const cost = getItemCost(item);
    if (cost === 0) return 0;
    return Math.round(((item.value - cost) / cost) * 100);
  };

  const getComps = (itemId) => {
    const item = items.find(i => i.id === itemId);
    return item ? (item.comps || []) : [];
  };

  const totalValue = items.reduce((s,i) => s + i.value, 0);
  const avgValue = items.length > 0 ? Math.round(totalValue / items.length) : 0;
  const topGainer = items.length > 0 ? items.reduce((m,i) => getItemGain(i) > getItemGain(m) ? i : m) : null;
  const soldItems = items.filter(i => i.earnings && i.earnings > 0);
  const totalEarnings = soldItems.reduce((s,i) => s + i.earnings, 0);
  const selected = items.find(i => i.id === selectedId);

  const filtered = items
    .filter(i => (filter === 'All' || i.category === filter) && i.name.toLowerCase().includes(search.toLowerCase()))
    .sort((a,b) => {
      if (sortBy === 'value-high') return b.value - a.value;
      if (sortBy === 'value-low') return a.value - b.value;
      if (sortBy === 'gain') return getItemGain(b) - getItemGain(a);
      return 0;
    });

  const goItem = (id) => { setSelectedId(id); setPhotoIndex(0); setCommunityComps([]); setScreen('detail'); };
  // Barcode product lookup via UPCitemdb (free trial, no key needed)
  const lookupBarcode = async (code) => {
    setScanStatus('Looking up product...');
    try {
      const resp = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${code}`);
      const data = await resp.json();
      if (data.items && data.items.length > 0) {
        const product = data.items[0];
        const catMap = {'Apparel':'Fashion','Clothing':'Fashion','Shoes':'Fashion','Electronics':'Electronics','Computers':'Electronics','Phone':'Electronics','Home':'Home','Kitchen':'Home','Garden':'Home','Sports':'Sports','Outdoors':'Sports','Toys':'Toys','Games':'Toys','Books':'Books','Media':'Books','Automotive':'Automotive','Tools':'Tools','Hardware':'Tools'};
        let bestCat = 'Other';
        if (product.category) { const c = product.category.toLowerCase(); for (const [k,v] of Object.entries(catMap)) { if (c.includes(k.toLowerCase())) { bestCat = v; break; } } }
        const sd = {
          name: product.title || '',
          brand: product.brand || '',
          model: product.model || '',
          category: bestCat,
          cost: product.lowest_recorded_price ? parseFloat(product.lowest_recorded_price) : 0,
          market: product.highest_recorded_price ? parseFloat(product.highest_recorded_price) : 0,
          photos: (product.images || []).slice(0, 1),
          barcode: code,
          source: 'barcode',
        };
        setScanData(sd);
        setScanStatus('Product found! Review details below.');
        return sd;
      } else {
        setScanStatus('Product not found in database. Try photo mode or add manually.');
        return null;
      }
    } catch (e) {
      console.log('Barcode lookup error:', e);
      setScanStatus('Lookup failed. Check connection and try again.');
      return null;
    }
  };

  // Navigate to Add Item with scan data pre-filled
  const goAddWithScanData = (data) => {
    if (!data) { setScreen('add-item'); return; }
    // We'll pre-fill the form after navigating
    setScanData(data);
    setScreen('add-item');
  };

  // Stop barcode scanner cleanup
  const stopBarcodeScanner = () => {
    if (scannerRef.current) {
      try { scannerRef.current.stop().catch(() => {}); } catch(e) {}
      scannerRef.current = null;
    }
    setBarcodeScanning(false);
  };

  const takePhoto = () => {
    setScanning(true);
    setTimeout(() => { setScanning(false); setAnalyzing(true);
      setTimeout(() => { setAnalyzing(false); setAiDone(true); }, 2200);
    }, 900);
  };

  const fmt = (n) => '$' + n.toLocaleString();

  // Compress photo to prevent localStorage overflow (~50KB per photo instead of ~3MB)
  const compressPhoto = (dataUrl) => {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const maxSize = 600;
        let w = img.width, h = img.height;
        if (w > h && w > maxSize) { h = Math.round(h * maxSize / w); w = maxSize; }
        else if (h > maxSize) { w = Math.round(w * maxSize / h); h = maxSize; }
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', 0.6));
      };
      img.onerror = () => resolve(dataUrl);
      img.src = dataUrl;
    });
  };
  const userName = profile ? profile.name : 'there';
  const userEmail = profile ? profile.email : '';
  const userInitial = userName.charAt(0).toUpperCase();
  const getGreeting = () => {
    const h = new Date().getHours();
    if (h < 12) return 'Good Morning';
    if (h < 17) return 'Good Afternoon';
    return 'Good Evening';
  };

  // Generate real alerts from actual inventory data
  const generateAlerts = () => {
    const a = [];
    let id = 1;
    const now = new Date();
    items.forEach(item => {
      const cost = getItemCost(item);
      const gain = getItemGain(item);
      const asking = getItemAsking(item);
      // Alert: item is worth more than you paid (positive ROI)
      if (gain > 15) {
        a.push({id: id++, type:'Strong Performer', msg:`${item.name} is up ${gain}% from what you paid.`, iconKey:'TrendUp', emoji:item.emoji, itemId:item.id});
      }
      // Alert: item value is below what you paid (losing money)
      if (item.value < cost && cost > 0) {
        const loss = Math.round(((cost - item.value) / cost) * 100);
        a.push({id: id++, type:'Below Cost', msg:`${item.name} market value is ${loss}% below what you paid.`, iconKey:'TrendDown', emoji:item.emoji, itemId:item.id});
      }
      // Alert: asking price is way above market (may be overpriced)
      if (asking > 0 && item.value > 0 && asking > item.value * 1.2) {
        const pct = Math.round(((asking - item.value) / item.value) * 100);
        a.push({id: id++, type:'Priced High', msg:`${item.name} asking is ${pct}% above market. May be hard to sell.`, iconKey:'Zap', emoji:item.emoji, itemId:item.id});
      }
      // Alert: asking price is below market (could get more)
      if (asking > 0 && item.value > 0 && asking < item.value * 0.9) {
        a.push({id: id++, type:'Underpriced', msg:`${item.name} is listed below market value. You could ask for more.`, iconKey:'Dollar', emoji:item.emoji, itemId:item.id});
      }
      // Alert: no comps added yet
      if (!item.comps || item.comps.length === 0) {
        a.push({id: id++, type:'Needs Comps', msg:`${item.name} has no comparable listings. Add comps for better valuation.`, iconKey:'Search', emoji:item.emoji, itemId:item.id});
      }
      // Alert: no market value set (defaulted to cost or asking)
      if (item.value === cost && asking !== cost) {
        a.push({id: id++, type:'Set Market Value', msg:`${item.name} market value may need updating. It's still set to your cost.`, iconKey:'Edit', emoji:item.emoji, itemId:item.id});
      }
      // Alert: item added recently (welcome)
      if (item.createdAt) {
        const created = new Date(item.createdAt);
        const hoursSince = (now - created) / (1000 * 60 * 60);
        if (hoursSince < 24) {
          a.push({id: id++, type:'New Item Added', msg:`${item.name} was added to your inventory.`, iconKey:'Package', emoji:item.emoji, itemId:item.id});
        }
      }
    });
    // Sort: actionable alerts first (Below Cost, Underpriced, Needs Comps), then info
    const priority = {'Below Cost':0,'Underpriced':1,'Priced High':2,'Needs Comps':3,'Set Market Value':4,'Strong Performer':5,'New Item Added':6};
    a.sort((x,y) => (priority[x.type]??99) - (priority[y.type]??99));
    return a;
  };
  const alerts = generateAlerts();
  const inputStyle = {width:'100%',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:10,padding:'12px 14px',color:'#fff',fontSize:14,outline:'none',fontFamily:'DM Sans, sans-serif'};
  // Focus styles handled via CSS .form-input:focus class

  const GainBadge = ({gain, size='sm'}) => {
    const isUp = gain >= 0;
    const Ic = isUp ? Icons.TrendUp : Icons.TrendDown;
    const color = isUp ? '#4ade80' : '#f87171';
    const sz = size === 'sm' ? 12 : 16;
    return <span style={{display:'inline-flex',alignItems:'center',gap:3,color,fontSize: size==='sm'?12:15,fontWeight:600}}>
      <Ic size={sz} color={color}/>{isUp?'+':''}{gain}%
    </span>;
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  const SetupScreen = () => (
    <div style={{height:'100%',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:32}}>
      <div style={{width:80,height:80,borderRadius:20,background:'linear-gradient(135deg,#d4a853,#b8860b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:36,marginBottom:24}}>üíé</div>
      <h1 style={{fontSize:26,fontWeight:700,color:'#fff',marginBottom:6}}>Welcome to Pr√Ñperty</h1>
      <p className="text-muted" style={{fontSize:14,textAlign:'center',marginBottom:32,lineHeight:1.5}}>Track your inventory, monitor market values, and maximize your returns.</p>

      <div style={{width:'100%',maxWidth:320}}>
        <FormField label="Your Name" required>
          <input ref={profileNameRef} className="form-input" defaultValue="" placeholder="e.g. Jordan" style={inputStyle}/>
        </FormField>
        <FormField label="Email" required>
          <input ref={profileEmailRef} className="form-input" type="email" defaultValue="" placeholder="e.g. you@email.com" style={inputStyle}/>
        </FormField>

        <button onClick={() => {
          const name = profileNameRef.current?.value?.trim() || '';
          const email = profileEmailRef.current?.value?.trim() || '';
          if (!name) { alert('Please enter your name.'); return; }
          if (!email) { alert('Please enter your email.'); return; }
          const newProfile = { name, email, createdAt: new Date().toISOString() };
          setProfile(newProfile);
          setScreen('home');
          // Show tutorial for new users
          setShowTutorial(true);
          setTutorialStep(0);
          // Sync new profile to Supabase
          syncProfile(newProfile).then(userId => {
            if (userId) { supabaseUserIdRef.current = userId; }
          });
        }} className="gradient-amber" style={{width:'100%',border:'none',borderRadius:14,padding:'16px 0',fontSize:16,fontWeight:700,color:'#000',cursor:'pointer',marginTop:8}}>
          Get Started
        </button>
      </div>
    </div>
  );

  const HomeScreen = () => (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      {/* Header */}
      <div style={{padding:'32px 24px 8px'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:28}}>
          <div>
            <p className="text-dim" style={{fontSize:13,letterSpacing:1,textTransform:'uppercase'}}>{getGreeting()}</p>
            <h1 style={{fontSize:28,fontWeight:700,color:'#fff',marginTop:4}}>{userName}</h1>
          </div>
          <div className="gradient-amber" style={{width:44,height:44,borderRadius:22,display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,fontWeight:700,color:'#000'}}>{userInitial}</div>
        </div>

        {/* Stats Grid */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          {[
            {label:'Total Items',val:String(items.length),icon:'Package',grad:'linear-gradient(135deg,#3b82f6,#2563eb)'},
            {label:'Total Value',val:fmt(totalValue),icon:'Dollar',grad:'linear-gradient(135deg,#d4a853,#b8860b)',tip:'The combined market value of all items currently in your inventory.'},
            {label:'Total Earnings',val: totalEarnings > 0 ? fmt(totalEarnings) : '--',icon:'BarChart',grad:'linear-gradient(135deg,#a855f7,#7c3aed)',tip:'Total revenue from items you\'ve sold. Tap to see all sold items.',onClick:() => setScreen('sold-items')},
            {label:'Top Gainer',val: topGainer ? `+${getItemGain(topGainer)}%` : '--',icon:'TrendUp',grad:'linear-gradient(135deg,#22c55e,#16a34a)',tip: topGainer ? `Your best performing item by % gain. Currently: ${topGainer.name}` : 'Add items to see your top performer.'},
          ].map((c,i) => {
            const Ic = Icons[c.icon];
            return <div key={i} className="glass anim-up" style={{borderRadius:16,padding:16,animationDelay:`${i*0.08}s`,cursor:c.onClick?'pointer':'default',overflow:'visible',position:'relative'}} onClick={c.onClick || undefined}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                <div>
                  <div style={{display:'flex',alignItems:'center'}}>
                    <p className="text-dim" style={{fontSize:11,textTransform:'uppercase',letterSpacing:1}}>{c.label}</p>
                    {c.tip && <InfoTip text={c.tip}/>}
                  </div>
                  <p style={{fontSize:22,fontWeight:700,color:'#fff',marginTop:6}}>{c.val}</p>
                </div>
                <div style={{width:40,height:40,borderRadius:10,background:c.grad,display:'flex',alignItems:'center',justifyContent:'center'}}>
                  <Ic size={20} color="#fff"/>
                </div>
              </div>
            </div>;
          })}
        </div>
      </div>

      {/* Action Buttons */}
      <div style={{padding:'20px 24px',display:'flex',gap:12}}>
        <button onClick={() => setScreen('scan')} className="gradient-amber" style={{flex:1,border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:600,color:'#000',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
          <Icons.Camera size={20} color="#000"/>Scan Item
        </button>
        <button onClick={() => setScreen('add-item')} className="glass glass-hover" style={{flex:1,border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:600,color:'#fff',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8,background:'rgba(255,255,255,0.06)'}}>
          <Icons.Plus size={20}/>Add Manually
        </button>
      </div>

      {/* Market Pulse - Discover CTA */}
      <div style={{padding:'0 24px 12px'}}>
        <button onClick={() => setScreen('discover')} className="glass glass-hover" style={{width:'100%',borderRadius:14,padding:16,border:'1px solid rgba(168,85,247,0.2)',background:'linear-gradient(135deg,rgba(168,85,247,0.08),rgba(59,130,246,0.08))',cursor:'pointer',display:'flex',alignItems:'center',gap:14}}>
          <div style={{width:44,height:44,borderRadius:12,background:'linear-gradient(135deg,#a855f7,#3b82f6)',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>
            <Icons.Search size={22} color="#fff"/>
          </div>
          <div style={{flex:1,textAlign:'left'}}>
            <p style={{fontWeight:700,color:'#fff',fontSize:14}}>Discover Market Prices</p>
            <p className="text-dim" style={{fontSize:12,marginTop:2}}>Search what any item is buying and selling for</p>
          </div>
          <Icons.ChevronRight size={18} color="#a855f7"/>
        </button>
      </div>

      {/* Portfolio by Sector */}
      {(() => {
        const categories = {};
        items.forEach(item => {
          if (!categories[item.category]) categories[item.category] = {items:[], totalValue:0, totalCost:0};
          categories[item.category].items.push(item);
          categories[item.category].totalValue += item.value;
          categories[item.category].totalCost += getItemCost(item);
        });
        const sectorIcons = {Fashion:'üëú',Electronics:'üì±',Home:'üè†',Watches:'‚åö',Art:'üé®',Sports:'‚öΩ',Other:'üì¶'};
        const sectorColors = {Fashion:'#e879f9',Electronics:'#3b82f6',Home:'#f59e0b',Watches:'#22c55e',Art:'#f472b6',Sports:'#fb923c',Other:'#94a3b8'};
        const sectors = Object.entries(categories).map(([cat, data]) => {
          const gainPct = data.totalCost > 0 ? ((data.totalValue - data.totalCost) / data.totalCost) * 100 : 0;
          const gainDollar = data.totalValue - data.totalCost;
          return {cat, ...data, gainPct, gainDollar};
        });
        return (
          <div style={{padding:'12px 24px'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
              <h2 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Portfolio</h2>
              <span className="text-dim" style={{fontSize:11}}>Total Gain/Loss</span>
            </div>
            {sectors.length === 0 ? (
              <div className="glass" style={{borderRadius:14,padding:24,textAlign:'center'}}>
                <p style={{fontSize:32,marginBottom:8}}>üìä</p>
                <p className="text-muted" style={{fontSize:13}}>No sectors yet. Add items to see your portfolio breakdown.</p>
              </div>
            ) : (
            <div style={{display:'flex',flexDirection:'column',gap:10}}>
              {sectors.map((s,i) => {
                const isUp = s.gainDollar >= 0;
                return (
                  <div key={s.cat} className="glass glass-hover anim-right" style={{borderRadius:14,padding:16,cursor:'pointer',animationDelay:`${i*0.06}s`}} onClick={() => {setFilter(s.cat);setScreen('inventory');}}>
                    <div style={{display:'flex',alignItems:'center',gap:12}}>
                      <div style={{width:44,height:44,borderRadius:12,background:`${sectorColors[s.cat]}20`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:22}}>{sectorIcons[s.cat]||'üì¶'}</div>
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                          <p style={{fontWeight:600,color:'#fff',fontSize:14}}>{s.cat}</p>
                          <p className="text-gold" style={{fontWeight:700,fontSize:15}}>{fmt(s.totalValue)}</p>
                        </div>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:4}}>
                          <p className="text-dim" style={{fontSize:12}}>{s.items.length} item{s.items.length>1?'s':''}</p>
                          <span style={{fontSize:13,fontWeight:600,color:isUp?'#4ade80':'#f87171',display:'flex',alignItems:'center',gap:3}}>
                            {isUp?<Icons.TrendUp size={13} color="#4ade80"/>:<Icons.TrendDown size={13} color="#f87171"/>}
                            {isUp?'+':''}{s.gainPct.toFixed(1)}% ({isUp?'+':''}${Math.abs(Math.round(s.gainDollar)).toLocaleString()})
                          </span>
                        </div>
                        {/* Mini bar showing value allocation */}
                        <div style={{marginTop:8,height:4,borderRadius:2,background:'rgba(255,255,255,0.06)',overflow:'hidden'}}>
                          <div style={{height:'100%',borderRadius:2,background:sectorColors[s.cat],width:`${Math.min(100,(s.totalValue/totalValue)*100)}%`,transition:'width 0.5s ease'}}/>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            )}
          </div>
        );
      })()}

      {/* Watchlist: Biggest Movers */}
      {(() => {
        const sorted = [...items].sort((a,b) => Math.abs(getItemGain(b)) - Math.abs(getItemGain(a)));
        return (
          <div style={{padding:'16px 24px'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <h2 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Watchlist</h2>
                <InfoTip text="Your items ranked by biggest market moves. Updates as new comparable listings appear across marketplaces."/>
              </div>
              <button onClick={() => setScreen('inventory')} style={{background:'none',border:'none',color:'#d4a853',fontSize:13,fontWeight:600,cursor:'pointer'}}>View All</button>
            </div>
            {sorted.length === 0 ? (
              <div className="glass" style={{borderRadius:14,padding:24,textAlign:'center'}}>
                <p style={{fontSize:32,marginBottom:8}}>üëÄ</p>
                <p className="text-muted" style={{fontSize:13}}>Your watchlist is empty. Add items to track their market moves.</p>
              </div>
            ) : (<React.Fragment>
            {/* Table header */}
            <div style={{display:'grid',gridTemplateColumns:'1fr auto auto',gap:8,padding:'0 4px 8px',borderBottom:'1px solid rgba(255,255,255,0.08)'}}>
              <span className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:1}}>Item</span>
              <span className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:1,textAlign:'right',minWidth:70}}>Mkt Value</span>
              <span className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:1,textAlign:'right',minWidth:80}}>Daily Chg</span>
            </div>
            <div style={{display:'flex',flexDirection:'column'}}>
              {sorted.map((item,i) => {
                const dailyDollar = item.value * (getItemGain(item) / 100) * 0.1;
                const dailyPct = (getItemGain(item) * 0.1);
                const isUp = dailyPct >= 0;
                return (
                  <div key={item.id} onClick={() => goItem(item.id)} className="anim-right" style={{display:'grid',gridTemplateColumns:'1fr auto auto',gap:8,padding:'12px 4px',borderBottom:'1px solid rgba(255,255,255,0.04)',cursor:'pointer',alignItems:'center',animationDelay:`${i*0.04}s`}}>
                    <div style={{display:'flex',alignItems:'center',gap:10,minWidth:0}}>
                      <span style={{fontSize:20}}>{item.emoji}</span>
                      <div style={{minWidth:0}}>
                        <p className="truncate" style={{fontWeight:600,color:'#fff',fontSize:13}}>{item.name}</p>
                        <p className="text-dim" style={{fontSize:11}}>{item.category}</p>
                      </div>
                    </div>
                    <p style={{fontWeight:600,color:'#fff',fontSize:14,textAlign:'right',minWidth:70}}>{fmt(item.value)}</p>
                    <div style={{textAlign:'right',minWidth:80}}>
                      <p style={{fontSize:13,fontWeight:600,color:isUp?'#4ade80':'#f87171'}}>{isUp?'+':''}{dailyPct.toFixed(2)}%</p>
                      <p style={{fontSize:11,color:isUp?'#4ade80':'#f87171',opacity:0.8}}>{isUp?'+':''}${Math.abs(Math.round(dailyDollar)).toLocaleString()}</p>
                    </div>
                  </div>
                );
              })}
            </div>
            </React.Fragment>)}
          </div>
        );
      })()}
    </div>
  );

  const ScanScreen = () => {
    const startBarcodeScanner = () => {
      setBarcodeScanning(true);
      setScanStatus('Starting camera...');
      setTimeout(() => {
        if (scannerRef.current) { try { scannerRef.current.stop().catch(()=>{}); } catch(e){} }
        const scanner = new Html5Qrcode("barcode-reader");
        scannerRef.current = scanner;
        scanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0 },
          (decodedText) => {
            scanner.stop().catch(()=>{});
            scannerRef.current = null;
            setBarcodeScanning(false);
            setScanStatus('Barcode found: ' + decodedText);
            if (supabaseUserIdRef.current) logEvent(supabaseUserIdRef.current, 'barcode_scanned', { code: decodedText });
            lookupBarcode(decodedText);
          },
          () => {} // ignore scan failures (normal while searching)
        ).then(() => {
          setScanStatus('Point camera at barcode...');
        }).catch((err) => {
          console.log('Camera error:', err);
          setBarcodeScanning(false);
          setScanStatus('Camera access denied. Check permissions.');
        });
      }, 200);
    };

    const handlePhotoCapture = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      setScanStatus('Processing photo...');
      const reader = new FileReader();
      reader.onload = async (ev) => {
        const compressed = await compressPhoto(ev.target.result);
        const sd = { name: '', brand: '', model: '', category: 'Other', cost: 0, market: 0, photos: [compressed], source: 'photo' };
        setScanData(sd);
        setScanStatus('Photo captured! Add details and save.');
        if (supabaseUserIdRef.current) logEvent(supabaseUserIdRef.current, 'photo_scanned', {});
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    };

    return (
    <div style={{height:'100%',background:'#0a0a0f',display:'flex',flexDirection:'column'}}>
      {/* Header */}
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px',flexShrink:0}}>
        <button onClick={() => {stopBarcodeScanner();setScanStatus('');setScanData(null);setScreen('home');}} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
        <h1 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Scan Item</h1>
        <div style={{width:24}}/>
      </div>

      {/* Mode Toggle */}
      <div style={{display:'flex',gap:8,padding:'0 24px 16px',flexShrink:0}}>
        {[{id:'photo',label:'Take Photo',icon:'üì∏'},{id:'barcode',label:'Scan Barcode',icon:'üìä'}].map(m => (
          <button key={m.id} onClick={() => { stopBarcodeScanner(); setScanMode(m.id); setScanStatus(''); setScanData(null); }}
            style={{flex:1,padding:'12px 0',borderRadius:12,border:'1px solid',fontSize:13,fontWeight:600,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:6,
              borderColor: scanMode === m.id ? '#d4a853' : 'rgba(255,255,255,0.1)',
              background: scanMode === m.id ? 'rgba(212,168,83,0.15)' : 'rgba(255,255,255,0.04)',
              color: scanMode === m.id ? '#d4a853' : '#94a3b8'}}>
            <span>{m.icon}</span>{m.label}
          </button>
        ))}
      </div>

      {/* Scanner Area */}
      <div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:'0 24px',overflow:'hidden'}}>
        {scanMode === 'barcode' ? (
          <div style={{width:'100%',maxWidth:320}}>
            <div id="barcode-reader" style={{width:'100%',borderRadius:16,overflow:'hidden',background:'#000',minHeight:240}}></div>
            {!barcodeScanning && !scanData && (
              <button onClick={startBarcodeScanner} className="gradient-amber" style={{width:'100%',border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:700,color:'#000',cursor:'pointer',marginTop:16}}>
                Start Scanning
              </button>
            )}
            {barcodeScanning && (
              <div style={{textAlign:'center',marginTop:16}}>
                <div style={{width:32,height:32,border:'3px solid rgba(212,168,83,0.3)',borderTopColor:'#d4a853',borderRadius:'50%',animation:'spin 0.8s linear infinite',margin:'0 auto 12px'}}></div>
                <p style={{fontSize:13,color:'#94a3b8'}}>Searching for barcode...</p>
              </div>
            )}
          </div>
        ) : (
          <div style={{width:'100%',maxWidth:320,textAlign:'center'}}>
            {!scanData ? (
              <>
                <div style={{width:200,height:200,borderRadius:24,border:'3px dashed rgba(255,255,255,0.15)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',margin:'0 auto 24px',background:'rgba(255,255,255,0.03)'}}>
                  <Icons.Camera size={48} color="#475569"/>
                  <p style={{fontSize:12,color:'#475569',marginTop:8}}>Take a photo of your item</p>
                </div>
                <label className="gradient-amber" style={{display:'block',width:'100%',border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:700,color:'#000',cursor:'pointer',textAlign:'center'}}>
                  Open Camera
                  <input type="file" accept="image/*" capture="environment" style={{display:'none'}} onChange={handlePhotoCapture}/>
                </label>
                <label style={{display:'block',width:'100%',background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer',textAlign:'center',marginTop:10}}>
                  <span style={{display:'flex',alignItems:'center',justifyContent:'center',gap:6}}><Icons.Upload size={16}/>Choose from Gallery</span>
                  <input type="file" accept="image/*" style={{display:'none'}} onChange={handlePhotoCapture}/>
                </label>
              </>
            ) : scanData.source === 'photo' && (
              <div>
                <img src={scanData.photos[0]} style={{width:200,height:200,borderRadius:16,objectFit:'cover',border:'2px solid #d4a853',margin:'0 auto 16px',display:'block'}}/>
                <p style={{fontSize:14,fontWeight:600,color:'#4ade80',marginBottom:4}}>Photo captured!</p>
                <p style={{fontSize:12,color:'#94a3b8',marginBottom:16}}>Your photo will be the cover image. Add details on the next screen.</p>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Status Message */}
      {scanStatus && (
        <div style={{padding:'0 24px',flexShrink:0}}>
          <div style={{background:'rgba(255,255,255,0.06)',borderRadius:12,padding:14,textAlign:'center',marginBottom:12}}>
            <p style={{fontSize:13,color: scanStatus.includes('found') || scanStatus.includes('captured') ? '#4ade80' : scanStatus.includes('denied') || scanStatus.includes('failed') || scanStatus.includes('not found') ? '#f87171' : '#d4a853'}}>{scanStatus}</p>
          </div>
        </div>
      )}

      {/* Scan Result Preview (barcode) */}
      {scanData && scanData.source === 'barcode' && (
        <div style={{padding:'0 24px',flexShrink:0}}>
          <div className="glass" style={{borderRadius:16,padding:16,marginBottom:12}}>
            <div style={{display:'flex',gap:12,alignItems:'center',marginBottom:12}}>
              {scanData.photos[0] && <img src={scanData.photos[0]} style={{width:56,height:56,borderRadius:10,objectFit:'cover',background:'#1e293b'}}/>}
              <div style={{flex:1,minWidth:0}}>
                <p className="truncate" style={{fontWeight:700,color:'#fff',fontSize:14}}>{scanData.name || 'Unknown Product'}</p>
                <p className="text-dim" style={{fontSize:11}}>{[scanData.brand, scanData.model, scanData.barcode].filter(Boolean).join(' ¬∑ ')}</p>
              </div>
            </div>
            <div style={{display:'flex',gap:8}}>
              {scanData.cost > 0 && <span style={{fontSize:11,color:'#3b82f6',background:'rgba(59,130,246,0.1)',padding:'4px 10px',borderRadius:8}}>Low: ${scanData.cost}</span>}
              {scanData.market > 0 && <span style={{fontSize:11,color:'#4ade80',background:'rgba(34,197,94,0.1)',padding:'4px 10px',borderRadius:8}}>High: ${scanData.market}</span>}
              <span style={{fontSize:11,color:'#a855f7',background:'rgba(168,85,247,0.1)',padding:'4px 10px',borderRadius:8}}>{scanData.category}</span>
            </div>
          </div>
        </div>
      )}

      {/* Bottom Actions */}
      <div style={{padding:'0 24px 32px',flexShrink:0}}>
        {scanData ? (
          <div style={{display:'flex',flex:'column',gap:10}}>
            <button onClick={() => { stopBarcodeScanner(); goAddWithScanData(scanData); }} className="gradient-amber" style={{flex:1,border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:700,color:'#000',cursor:'pointer'}}>
              Review & Save ‚Üí
            </button>
            <button onClick={() => { setScanData(null); setScanStatus(''); }} style={{flex:1,background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer'}}>
              Scan Again
            </button>
          </div>
        ) : (
          <button onClick={() => { stopBarcodeScanner(); setScreen('add-item'); }} style={{width:'100%',background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer'}}>
            Skip, Add Manually
          </button>
        )}
      </div>
    </div>
  );
  };

  const AIScreen = () => (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      {/* Header */}
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px'}}>
        <button onClick={() => {setScreen('scan');setAnalyzing(false);setAiDone(false);}} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
        <h1 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Item Analysis</h1>
        <div style={{width:24}}/>
      </div>

      {/* Photo */}
      <div style={{padding:'0 24px 24px'}}>
        <div style={{width:'100%',height:240,borderRadius:20,background:'linear-gradient(135deg,#334155,#1e293b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:80,position:'relative',overflow:'hidden'}}>
          üëú
          <div style={{position:'absolute',bottom:0,left:0,right:0,height:'40%',background:'linear-gradient(to top,rgba(10,10,15,0.6),transparent)'}}/>
        </div>
      </div>

      {analyzing ? (
        <div className="anim-fade" style={{padding:'40px 24px',textAlign:'center'}}>
          <div style={{position:'relative',width:64,height:64,margin:'0 auto 20px'}}>
            <div style={{position:'absolute',inset:0,border:'2px solid transparent',borderTopColor:'#d4a853',borderRadius:'50%',animation:'spin 1s linear infinite'}}/>
            <div style={{position:'absolute',inset:8,border:'2px solid transparent',borderRightColor:'#b8860b',borderRadius:'50%',animation:'spinReverse 0.8s linear infinite'}}/>
          </div>
          <p style={{fontSize:20,fontWeight:600,color:'#fff'}}>Analyzing...</p>
          <p className="text-muted" style={{fontSize:14,marginTop:8}}>AI is identifying your item</p>
          <div style={{marginTop:20,height:4,borderRadius:2,background:'rgba(255,255,255,0.06)',overflow:'hidden'}}>
            <div style={{height:'100%',width:'60%',borderRadius:2,background:'linear-gradient(90deg,#d4a853,#b8860b,#d4a853)',backgroundSize:'200% 100%',animation:'shimmer 1.5s ease-in-out infinite'}}/>
          </div>
        </div>
      ) : aiDone ? (
        <div className="anim-up" style={{padding:'0 24px'}}>
          {/* Prediction card */}
          <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:8}}>
              <h3 style={{fontSize:18,fontWeight:700,color:'#fff',flex:1,marginRight:12}}>Louis Vuitton Neverfull MM</h3>
              <div style={{background:'rgba(34,197,94,0.15)',border:'1px solid rgba(34,197,94,0.25)',borderRadius:8,padding:'4px 10px',flexShrink:0}}>
                <span style={{fontSize:12,fontWeight:600,color:'#4ade80'}}>94% Match</span>
              </div>
            </div>
            <p className="text-muted" style={{fontSize:14}}>Damier Ebene Pattern</p>
          </div>

          {/* Details */}
          <div style={{display:'flex',flexDirection:'column',gap:10,marginBottom:24}}>
            {[['Category','Handbags & Purses'],['Brand','Louis Vuitton'],['Model','Neverfull MM'],['Material','Canvas & Leather'],['Condition','Excellent']].map(([k,v],i) => (
              <div key={i} className="glass" style={{borderRadius:12,padding:'14px 16px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <span className="text-muted" style={{fontSize:13}}>{k}</span>
                <span style={{fontWeight:600,color:'#fff',fontSize:14}}>{v}</span>
              </div>
            ))}
          </div>

          {/* Actions */}
          <button onClick={() => {setSelectedId(1);setScreen('pricing');}} className="gradient-amber" style={{width:'100%',border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:700,color:'#000',cursor:'pointer',marginBottom:12}}>
            Search Comps
          </button>
          <button onClick={() => {setScreen('inventory');setAiDone(false);}} className="glass glass-hover" style={{width:'100%',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:600,color:'#fff',cursor:'pointer',background:'rgba(255,255,255,0.06)'}}>
            Save to Inventory
          </button>
        </div>
      ) : null}
    </div>
  );

  /* ‚îÄ‚îÄ Discover Screen (Community Market Data) ‚îÄ‚îÄ */
  const doDiscoverSearch = async (q, cat) => {
    setDiscoverSearched(true);
    setShowSuggestions(false);
    setDiscoverLoading(true);
    const results = await searchCommunityItems(q, cat);
    setDiscoverResults(results);
    setDiscoverLoading(false);
  };

  const DiscoverScreen = () => {
    // Aggregate results by name (group similar items)
    const grouped = {};
    discoverResults.forEach(it => {
      const key = (it.name || '').toLowerCase().trim();
      if (!grouped[key]) grouped[key] = { name: it.name, emoji: it.emoji, brand: it.brand, category: it.category, items: [] };
      grouped[key].items.push(it);
    });
    const groups = Object.values(grouped).sort((a, b) => b.items.length - a.items.length);

    const categories = ['All', 'Fashion', 'Electronics', 'Home', 'Watches', 'Sports', 'Collectibles', 'Trading Cards', 'Vinyl & Music', 'LEGO', 'Coins & Stamps', 'Art', 'Automotive', 'Books', 'Toys', 'Tools', 'Other'];

    return (
      <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
        {/* Header */}
        <div style={{padding:'32px 24px 8px'}}>
          <h1 style={{fontSize:24,fontWeight:700,color:'#fff',marginBottom:4}}>Discover</h1>
          <p className="text-dim" style={{fontSize:13}}>Search what anything is buying and selling for</p>
        </div>

        {/* Search Bar with Autocomplete */}
        <div style={{padding:'12px 24px'}}>
          <div style={{position:'relative'}}>
            <Icons.Search size={18} color="#475569" style={{position:'absolute',left:14,top:'50%',transform:'translateY(-50%)',zIndex:1,pointerEvents:'none'}}/>
            <input
              ref={searchInputRef}
              className="form-input"
              placeholder="Search any item (e.g. Nike Air Max 90)"
              value={discoverQuery}
              onChange={e => { setDiscoverQuery(e.target.value); setShowSuggestions(e.target.value.length > 0); }}
              onFocus={() => { if (discoverQuery.length > 0) setShowSuggestions(true); }}
              onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
              onKeyDown={e => { if (e.key === 'Enter') { setShowSuggestions(false); doDiscoverSearch(discoverQuery, discoverCategory); } }}
              style={{width:'100%',padding:'14px 16px 14px 40px',borderRadius:14,border:'1px solid rgba(255,255,255,0.1)',background:'rgba(255,255,255,0.06)',color:'#fff',fontSize:14}}
            />
            {/* Autocomplete Suggestions Dropdown (fill bar only, no auto-search) */}
            {showSuggestions && discoverQuery.trim().length > 0 && (() => {
              const suggestions = getSuggestions(discoverQuery);
              if (suggestions.length === 0) return null;
              return (
                <div style={{position:'absolute',top:'100%',left:0,right:0,zIndex:50,marginTop:4,background:'#1a1a2e',border:'1px solid rgba(255,255,255,0.12)',borderRadius:12,overflow:'hidden',boxShadow:'0 8px 32px rgba(0,0,0,0.5)',maxHeight:280,overflowY:'auto'}}>
                  {suggestions.map((s, i) => (
                    <div key={i} onClick={() => { setDiscoverQuery(s.text); setShowSuggestions(false); }}
                      style={{padding:'12px 16px',display:'flex',alignItems:'center',gap:10,cursor:'pointer',borderBottom: i < suggestions.length - 1 ? '1px solid rgba(255,255,255,0.06)' : 'none',background:'transparent'}}
                      onMouseEnter={e => e.currentTarget.style.background='rgba(255,255,255,0.06)'}
                      onMouseLeave={e => e.currentTarget.style.background='transparent'}>
                      <span style={{fontSize:14}}>{s.emoji}</span>
                      <div style={{flex:1,minWidth:0}}>
                        <p className="truncate" style={{fontSize:13,color:'#fff',fontWeight:500}}>{s.text}</p>
                        {s.brand && <p style={{fontSize:10,color:'rgba(255,255,255,0.4)',marginTop:1}}>{[s.brand, s.model].filter(Boolean).join(' ¬∑ ')}</p>}
                      </div>
                      <span style={{fontSize:10,color: s.source === 'inventory' ? '#d4a853' : s.source === 'suggested' ? '#a855f7' : '#64748b',background: s.source === 'inventory' ? 'rgba(212,168,83,0.1)' : s.source === 'suggested' ? 'rgba(168,85,247,0.1)' : 'rgba(255,255,255,0.04)',padding:'2px 8px',borderRadius:6,fontWeight:600}}>
                        {s.source === 'inventory' ? 'My Items' : s.source === 'suggested' ? 'Suggested' : 'Try this'}
                      </span>
                    </div>
                  ))}
                </div>
              );
            })()}
          </div>
          <div style={{display:'flex',gap:8,marginTop:10}}>
            <button onClick={() => { setShowSuggestions(false); doDiscoverSearch(discoverQuery, discoverCategory); }} className="gradient-amber" style={{flex:1,border:'none',borderRadius:12,padding:'12px 0',fontSize:14,fontWeight:700,color:'#000',cursor:'pointer'}}>
              Search Market
            </button>
            {discoverQuery.trim() && (
              <button onClick={() => goResearch(discoverQuery.trim())} style={{flex:1,border:'1px solid rgba(212,168,83,0.4)',borderRadius:12,padding:'12px 0',fontSize:14,fontWeight:700,color:'#d4a853',cursor:'pointer',background:'rgba(212,168,83,0.08)'}}>
                Deep Research ‚Üí
              </button>
            )}
          </div>
        </div>

        {/* Category Filter Chips */}
        <div className="scroll-hide" style={{padding:'4px 24px 12px',display:'flex',gap:8,overflowX:'auto'}}>
          {categories.map(cat => (
            <button key={cat} onClick={() => { setDiscoverCategory(cat); if (discoverSearched && discoverQuery) doDiscoverSearch(discoverQuery, cat); }}
              style={{padding:'6px 14px',borderRadius:20,border:'1px solid',whiteSpace:'nowrap',fontSize:12,fontWeight:600,cursor:'pointer',
                borderColor: discoverCategory === cat ? '#d4a853' : 'rgba(255,255,255,0.1)',
                background: discoverCategory === cat ? 'rgba(212,168,83,0.15)' : 'rgba(255,255,255,0.04)',
                color: discoverCategory === cat ? '#d4a853' : '#64748b',
              }}>
              {cat}
            </button>
          ))}
        </div>

        <div style={{padding:'0 24px'}}>

          {/* ‚îÄ‚îÄ PHASE 1: Browse Mode (before search) ‚îÄ‚îÄ */}
          {!discoverSearched && !discoverQuery.trim() && (() => {
            const showcaseCategories = [
              {cat:'Trading Cards',emoji:'üÉè',label:'Hot in Trading Cards',color:'#F5A623'},
              {cat:'Fashion',emoji:'üëü',label:'Trending in Fashion',color:'#a855f7'},
              {cat:'Electronics',emoji:'üì±',label:'Popular Electronics',color:'#3b82f6'},
              {cat:'Watches',emoji:'‚åö',label:'Watch Market',color:'#C8A951'},
              {cat:'Collectibles',emoji:'üì¶',label:'Collectibles & Comics',color:'#ef4444'},
              {cat:'LEGO',emoji:'üß±',label:'LEGO Sets',color:'#D01012'},
              {cat:'Vinyl & Music',emoji:'üé∏',label:'Vinyl & Music',color:'#22c55e'},
              {cat:'Coins & Stamps',emoji:'üíé',label:'Coins & Bullion',color:'#d4a853'},
            ];
            const filtered = discoverCategory === 'All' ? showcaseCategories : showcaseCategories.filter(sc => sc.cat === discoverCategory);
            const catsToShow = filtered.length > 0 ? filtered : showcaseCategories;
            return (
              <div>
                <p className="text-dim" style={{fontSize:11,textTransform:'uppercase',letterSpacing:0.8,marginBottom:12,fontWeight:600}}>Browse Categories</p>
                {catsToShow.map(sc => {
                  const catItems = PRODUCT_DB.filter(p => p.cat === sc.cat).slice(0, 3);
                  return (
                    <div key={sc.cat} className="glass anim-fade" style={{borderRadius:16,padding:16,marginBottom:12,border:`1px solid ${sc.color}22`}}>
                      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
                        <span style={{fontSize:16}}>{sc.emoji}</span>
                        <p style={{fontSize:13,fontWeight:700,color:sc.color}}>{sc.label}</p>
                      </div>
                      <div style={{display:'flex',flexDirection:'column',gap:6}}>
                        {catItems.map((p, pi) => (
                          <div key={pi} onClick={() => { setDiscoverQuery(p.name); setShowSuggestions(false); }}
                            style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',borderRadius:10,background:'rgba(255,255,255,0.04)',cursor:'pointer'}}
                            onMouseEnter={e => e.currentTarget.style.background='rgba(255,255,255,0.08)'}
                            onMouseLeave={e => e.currentTarget.style.background='rgba(255,255,255,0.04)'}>
                            <span style={{fontSize:14}}>{p.emoji}</span>
                            <div style={{flex:1,minWidth:0}}>
                              <p className="truncate" style={{fontSize:12,color:'#fff',fontWeight:500}}>{p.name}</p>
                              {p.brand && <p style={{fontSize:10,color:'rgba(255,255,255,0.35)',marginTop:1}}>{p.brand}{p.model ? ' ¬∑ ' + p.model : ''}</p>}
                            </div>
                            <span style={{fontSize:10,color:sc.color,fontWeight:600}}>Search ‚Üí</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            );
          })()}

          {/* ‚îÄ‚îÄ PHASE 3: Search Results (after clicking Search Market) ‚îÄ‚îÄ */}
          {/* Back to Browse button */}
          {discoverSearched && (
            <button onClick={() => { setDiscoverSearched(false); setDiscoverQuery(''); setDiscoverResults([]); }}
              style={{display:'flex',alignItems:'center',gap:6,background:'none',border:'none',color:'#d4a853',fontSize:12,fontWeight:600,cursor:'pointer',padding:'0 0 12px',marginTop:4}}>
              ‚Üê Back to Browse
            </button>
          )}

          {/* Web Marketplace Links - category-aware */}
          {discoverSearched && discoverQuery.trim() && (() => {
            const marketplaces = getMarketplacesForCategory(discoverCategory, discoverQuery);
            return (
              <div className="glass anim-fade" style={{borderRadius:16,padding:20,marginBottom:16,border:'1px solid rgba(212,168,83,0.15)'}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:12}}>
                  <div style={{width:28,height:28,borderRadius:8,background:'linear-gradient(135deg,#d4a853,#b8860b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14}}>üåê</div>
                  <div>
                    <p style={{fontWeight:700,color:'#fff',fontSize:14}}>Web Prices</p>
                    <p className="text-dim" style={{fontSize:11}}>{discoverCategory !== 'All' ? `Showing marketplaces for ${discoverCategory}` : 'Tap to see real prices on marketplaces'}</p>
                  </div>
                </div>
                <div style={{display:'flex',flexDirection:'column',gap:6}}>
                  {marketplaces.map(m => (
                    <a key={m.name} href={m.url} target="_blank" rel="noopener noreferrer" style={{
                      display:'flex', alignItems:'center', justifyContent:'space-between',
                      background:m.bg, border:`1px solid ${m.color}22`, borderRadius:12,
                      padding:'10px 14px', textDecoration:'none',
                    }}>
                      <div>
                        <span style={{fontSize:13,fontWeight:600,color:m.color}}>{m.name}</span>
                        <span style={{fontSize:11,color:'#475569',marginLeft:8}}>{m.desc}</span>
                      </div>
                      <span style={{fontSize:12,color:m.color}}>‚Üó</span>
                    </a>
                  ))}
                </div>
              </div>
            );
          })()}

          {/* Community Results Header */}
          {discoverSearched && discoverQuery.trim() && !discoverLoading && (
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:12}}>
              <div style={{width:28,height:28,borderRadius:8,background:'linear-gradient(135deg,#a855f7,#7c3aed)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14}}>üë•</div>
              <div>
                <p style={{fontWeight:700,color:'#fff',fontSize:14}}>Community Data</p>
                <p className="text-dim" style={{fontSize:11}}>{discoverResults.length > 0 ? `${discoverResults.length} results from Pr√Ñperty users` : 'No community data yet'}</p>
              </div>
            </div>
          )}

          {/* Loading */}
          {discoverLoading && (
            <div style={{textAlign:'center',padding:'40px 0'}}>
              <div style={{width:24,height:24,border:'2px solid rgba(212,168,83,0.2)',borderTopColor:'#d4a853',borderRadius:'50%',animation:'spin 0.8s linear infinite',margin:'0 auto 12px'}}/>
              <p className="text-dim" style={{fontSize:13}}>Searching community data...</p>
            </div>
          )}

          {/* Prompt to search when query typed but not yet searched */}
          {!discoverSearched && discoverQuery.trim() && (
            <div style={{textAlign:'center',padding:'30px 0'}}>
              <div style={{fontSize:36,marginBottom:12}}>üëÜ</div>
              <p style={{fontSize:14,fontWeight:600,color:'#fff',marginBottom:6}}>Ready to search</p>
              <p className="text-dim" style={{fontSize:12,lineHeight:1.5}}>Hit "Search Market" to see prices for "{discoverQuery}"</p>
            </div>
          )}

          {/* No Community Results (web prices still show above) */}
          {discoverSearched && !discoverLoading && discoverResults.length === 0 && discoverQuery && (
            <div className="glass" style={{borderRadius:14,padding:20,textAlign:'center',marginBottom:16}}>
              <p className="text-dim" style={{fontSize:13,lineHeight:1.5,marginBottom:12}}>No community data yet for "{discoverQuery}". Check the web prices above, or be the first to track this item!</p>
              <button onClick={() => setScreen('add-item')} className="gradient-amber" style={{border:'none',borderRadius:12,padding:'10px 20px',fontSize:13,fontWeight:700,color:'#000',cursor:'pointer'}}>
                Add This Item
              </button>
            </div>
          )}

          {/* Results */}
          {discoverSearched && !discoverLoading && groups.map((group, gi) => {
            const allPrices = group.items.map(it => it.value).filter(v => v > 0);
            const allCosts = group.items.map(it => it.cost).filter(v => v > 0);
            const allEarnings = group.items.filter(it => it.earnings && it.earnings > 0);
            const avgValue = allPrices.length > 0 ? Math.round(allPrices.reduce((s,v) => s+v, 0) / allPrices.length) : 0;
            const lowValue = allPrices.length > 0 ? Math.min(...allPrices) : 0;
            const highValue = allPrices.length > 0 ? Math.max(...allPrices) : 0;
            const avgCost = allCosts.length > 0 ? Math.round(allCosts.reduce((s,v) => s+v, 0) / allCosts.length) : 0;
            const avgEarnings = allEarnings.length > 0 ? Math.round(allEarnings.reduce((s,e) => s+e.earnings, 0) / allEarnings.length) : 0;
            const totalComps = group.items.reduce((s, it) => s + (it.comps || []).length, 0);
            const allCompPrices = group.items.flatMap(it => (it.comps || []).map(c => c.price)).filter(p => p > 0);
            const avgCompPrice = allCompPrices.length > 0 ? Math.round(allCompPrices.reduce((s,p) => s+p, 0) / allCompPrices.length) : 0;

            const recentComps = group.items.flatMap(it => (it.comps || []).map(c => ({...c, fromItem: it.name}))).slice(0, 10);

            return (
              <div key={gi} className="glass anim-up" style={{borderRadius:16,padding:20,marginBottom:16,animationDelay:`${gi * 0.05}s`,cursor:'pointer'}} onClick={() => goResearch(group.name, { listings: group.items.length, avgValue, lowValue, highValue, avgCost, soldCount: allEarnings.length, avgSold: avgEarnings, totalComps, avgCompPrice, recentComps, categories: [group.category] })}>
                {/* Item header */}
                <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:16}}>
                  <div style={{width:44,height:44,borderRadius:12,background:'linear-gradient(135deg,#334155,#1e293b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:22}}>{group.emoji || 'üì¶'}</div>
                  <div style={{flex:1}}>
                    <p style={{fontWeight:700,color:'#fff',fontSize:15}}>{group.name}</p>
                    <p className="text-dim" style={{fontSize:11}}>{group.brand ? group.brand + ' ¬∑ ' : ''}{group.category} ¬∑ {group.items.length} listing{group.items.length > 1 ? 's' : ''}</p>
                  </div>
                  <Icons.ChevronRight size={18} color="#4a5568" />
                </div>

                {/* Price Ticker */}
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:12}}>
                  <div style={{background:'rgba(255,255,255,0.04)',borderRadius:10,padding:'10px 12px',textAlign:'center'}}>
                    <p className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:0.5}}>Market Value</p>
                    <p style={{fontSize:18,fontWeight:700,color:'#d4a853',marginTop:4}}>{avgValue > 0 ? fmt(avgValue) : '--'}</p>
                  </div>
                  <div style={{background:'rgba(255,255,255,0.04)',borderRadius:10,padding:'10px 12px',textAlign:'center'}}>
                    <p className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:0.5}}>Low</p>
                    <p style={{fontSize:18,fontWeight:700,color:'#f87171',marginTop:4}}>{lowValue > 0 ? fmt(lowValue) : '--'}</p>
                  </div>
                  <div style={{background:'rgba(255,255,255,0.04)',borderRadius:10,padding:'10px 12px',textAlign:'center'}}>
                    <p className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:0.5}}>High</p>
                    <p style={{fontSize:18,fontWeight:700,color:'#4ade80',marginTop:4}}>{highValue > 0 ? fmt(highValue) : '--'}</p>
                  </div>
                </div>

                {/* Extra Stats */}
                <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                  {avgCost > 0 && <span style={{fontSize:11,color:'#94a3b8',background:'rgba(255,255,255,0.06)',padding:'4px 10px',borderRadius:8}}>Avg Cost: {fmt(avgCost)}</span>}
                  {avgEarnings > 0 && <span style={{fontSize:11,color:'#4ade80',background:'rgba(34,197,94,0.1)',padding:'4px 10px',borderRadius:8}}>Avg Sold: {fmt(avgEarnings)}</span>}
                  {allEarnings.length > 0 && <span style={{fontSize:11,color:'#a855f7',background:'rgba(168,85,247,0.1)',padding:'4px 10px',borderRadius:8}}>{allEarnings.length} sold</span>}
                  {totalComps > 0 && <span style={{fontSize:11,color:'#3b82f6',background:'rgba(59,130,246,0.1)',padding:'4px 10px',borderRadius:8}}>{totalComps} comp{totalComps > 1 ? 's' : ''} ¬∑ Avg {fmt(avgCompPrice)}</span>}
                </div>

                {/* Comp details if any */}
                {totalComps > 0 && (
                  <div style={{marginTop:12,paddingTop:12,borderTop:'1px solid rgba(255,255,255,0.06)'}}>
                    <p className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:0.5,marginBottom:8}}>Recent Comps</p>
                    {group.items.flatMap(it => (it.comps || []).map(c => ({...c, fromItem: it.name}))).slice(0, 5).map((c, ci) => (
                      <div key={ci} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom: ci < 4 ? '1px solid rgba(255,255,255,0.03)' : 'none'}}>
                        <div>
                          <p className="truncate" style={{color:'#cbd5e1',fontSize:12,maxWidth:200}}>{c.title}</p>
                          <p className="text-dim" style={{fontSize:10}}>{c.source} ¬∑ {c.condition}</p>
                        </div>
                        <span className="text-gold" style={{fontWeight:700,fontSize:13}}>{fmt(c.price)}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  /* ‚îÄ‚îÄ Research Page (Item Landing Page) ‚îÄ‚îÄ */
  const goResearch = async (query, data = null) => {
    setResearchQuery(query);
    setResearchData(data);
    setScreen('research');
    // If no data passed, fetch from community
    if (!data) {
      setResearchLoading(true);
      const results = await searchCommunityItems(query, 'All');
      const allPrices = results.map(r => r.value).filter(v => v > 0);
      const allCosts = results.map(r => r.cost).filter(v => v > 0);
      const allEarnings = results.filter(r => r.earnings && r.earnings > 0);
      const allComps = results.flatMap(r => (r.comps || []).filter(c => c.price > 0));
      setResearchData({
        listings: results.length,
        avgValue: allPrices.length > 0 ? Math.round(allPrices.reduce((s,v) => s+v,0) / allPrices.length) : 0,
        lowValue: allPrices.length > 0 ? Math.min(...allPrices) : 0,
        highValue: allPrices.length > 0 ? Math.max(...allPrices) : 0,
        avgCost: allCosts.length > 0 ? Math.round(allCosts.reduce((s,v) => s+v,0) / allCosts.length) : 0,
        soldCount: allEarnings.length,
        avgSold: allEarnings.length > 0 ? Math.round(allEarnings.reduce((s,e) => s+e.earnings,0) / allEarnings.length) : 0,
        totalComps: allComps.length,
        avgCompPrice: allComps.length > 0 ? Math.round(allComps.reduce((s,c) => s+c.price,0) / allComps.length) : 0,
        recentComps: allComps.slice(0, 10),
        categories: [...new Set(results.map(r => r.category).filter(Boolean))],
      });
      setResearchLoading(false);
    }
    if (supabaseUserIdRef.current) logEvent(supabaseUserIdRef.current, 'research_view', { query });
  };

  const ResearchScreen = () => {
    const q = researchQuery;
    const d = researchData || {};
    const seen = new Set();
    const webQ = encodeURIComponent(q.split(/\s+/).filter(w => { const l = w.toLowerCase(); if (seen.has(l)) return false; seen.add(l); return true; }).join(' '));

    // Buy/Sell Signal calculation
    const signal = (() => {
      let score = 50; // neutral
      let reasons = [];
      if (d.avgValue > 0 && d.avgCost > 0) {
        const margin = ((d.avgValue - d.avgCost) / d.avgCost) * 100;
        if (margin > 30) { score += 20; reasons.push('High profit margin (' + Math.round(margin) + '%)'); }
        else if (margin > 10) { score += 10; reasons.push('Decent margin (' + Math.round(margin) + '%)'); }
        else if (margin < 0) { score -= 15; reasons.push('Selling below cost'); }
      }
      if (d.soldCount > 3) { score += 10; reasons.push('Active resale market'); }
      else if (d.soldCount > 0) { score += 5; reasons.push('Some resale activity'); }
      if (d.totalComps > 5) { score += 10; reasons.push('Strong comp data (' + d.totalComps + ' comps)'); }
      else if (d.totalComps > 0) { score += 5; reasons.push(d.totalComps + ' comp(s) available'); }
      if (d.avgSold > d.avgValue && d.avgSold > 0) { score += 10; reasons.push('Selling above market value'); }
      if (d.listings > 5) { score -= 5; reasons.push('High supply (' + d.listings + ' listings)'); }
      if (d.listings === 0) { reasons.push('No community data yet'); score = 50; }
      score = Math.max(0, Math.min(100, score));
      const label = score >= 70 ? 'BUY' : score >= 45 ? 'HOLD' : 'SELL';
      const color = score >= 70 ? '#22c55e' : score >= 45 ? '#d4a853' : '#ef4444';
      return { score, label, color, reasons };
    })();

    return (
      <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
        {/* Header */}
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px'}}>
          <button onClick={() => setScreen('discover')} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
          <h1 style={{fontSize:16,fontWeight:700,color:'#fff'}}>Market Research</h1>
          <div style={{width:24}}/>
        </div>

        {/* Hero */}
        <div style={{padding:'0 24px 20px'}}>
          <div style={{background:'linear-gradient(135deg,rgba(168,85,247,0.12),rgba(59,130,246,0.12))',border:'1px solid rgba(168,85,247,0.2)',borderRadius:20,padding:24,textAlign:'center'}}>
            <div style={{fontSize:40,marginBottom:8}}>üìä</div>
            <h2 style={{fontSize:22,fontWeight:700,color:'#fff',marginBottom:4}}>{q}</h2>
            <p className="text-dim" style={{fontSize:13}}>{d.categories && d.categories.length > 0 ? d.categories.join(', ') : 'Search any item to see market intelligence'}</p>
          </div>
        </div>

        {researchLoading ? (
          <div style={{textAlign:'center',padding:'40px 0'}}>
            <div style={{width:24,height:24,border:'2px solid rgba(212,168,83,0.2)',borderTopColor:'#d4a853',borderRadius:'50%',animation:'spin 0.8s linear infinite',margin:'0 auto 12px'}}/>
            <p className="text-dim" style={{fontSize:13}}>Analyzing market data...</p>
          </div>
        ) : (
          <div style={{padding:'0 24px'}}>

            {/* Buy/Sell Signal */}
            <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16,border:`1px solid ${signal.color}33`}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}}>
                <div>
                  <p className="text-dim" style={{fontSize:11,textTransform:'uppercase',letterSpacing:1}}>Market Signal</p>
                  <div style={{display:'flex',alignItems:'center',gap:10,marginTop:6}}>
                    <span style={{fontSize:28,fontWeight:800,color:signal.color,fontFamily:'Sora'}}>{signal.label}</span>
                    <span style={{fontSize:14,color:'#64748b'}}>{signal.score}/100</span>
                  </div>
                </div>
                <div style={{width:56,height:56,borderRadius:28,border:`3px solid ${signal.color}`,display:'flex',alignItems:'center',justifyContent:'center'}}>
                  <span style={{fontSize:18,fontWeight:700,color:signal.color}}>{signal.score}</span>
                </div>
              </div>
              {/* Signal meter */}
              <div style={{height:8,borderRadius:4,background:'linear-gradient(90deg,#ef4444,#f59e0b,#d4a853,#22c55e)',marginBottom:12,position:'relative'}}>
                <div style={{position:'absolute',top:-4,left:`${signal.score}%`,transform:'translateX(-50%)',width:16,height:16,borderRadius:8,background:'#fff',border:`3px solid ${signal.color}`,boxShadow:`0 0 12px ${signal.color}66`}}/>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:4}}>
                {signal.reasons.map((r, i) => (
                  <p key={i} style={{fontSize:12,color:'#94a3b8'}}>‚Ä¢ {r}</p>
                ))}
                {signal.reasons.length === 0 && <p style={{fontSize:12,color:'#475569'}}>Search for an item to see buy/sell signals</p>}
              </div>
            </div>

            {/* Price Intelligence */}
            <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16,position:'relative'}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:14}}>
                <span style={{fontSize:18}}>üí∞</span>
                <h3 style={{fontSize:16,fontWeight:700,color:'#fff'}}>Price Intelligence</h3>
                <button onClick={(e) => { e.stopPropagation(); const tip = document.getElementById('pi-tooltip'); tip.style.display = tip.style.display === 'block' ? 'none' : 'block'; }} style={{width:20,height:20,borderRadius:'50%',border:'1px solid rgba(255,255,255,0.2)',background:'rgba(255,255,255,0.06)',color:'#94a3b8',fontSize:11,fontWeight:700,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',padding:0,lineHeight:1,marginLeft:2}}>i</button>
              </div>
              <div id="pi-tooltip" style={{display:'none',background:'#1e293b',border:'1px solid rgba(255,255,255,0.12)',borderRadius:12,padding:14,marginBottom:14,boxShadow:'0 8px 24px rgba(0,0,0,0.4)'}}>
                <p style={{fontSize:12,color:'#e2e8f0',lineHeight:1.6,margin:0}}>Aggregated pricing data from Pr√Ñperty community members tracking this item. <b style={{color:'#d4a853'}}>Market Value</b> is the avg estimated worth. <b style={{color:'#3b82f6'}}>Avg Cost</b> is what people paid. <b style={{color:'#a855f7'}}>Range</b> shows lowest to highest values. <b style={{color:'#4ade80'}}>Avg Sold</b> is the average sale price.</p>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:12}}>
                {[
                  {l:'Market Value',v:d.avgValue,c:'#d4a853'},
                  {l:'Avg Cost',v:d.avgCost,c:'#3b82f6'},
                  {l:'Price Range',v:d.lowValue > 0 ? fmt(d.lowValue) + ' - ' + fmt(d.highValue) : null,c:'#a855f7',raw:true},
                  {l:'Avg Sold Price',v:d.avgSold,c:'#22c55e'},
                ].map((stat, i) => (
                  <div key={i} style={{background:'rgba(255,255,255,0.04)',borderRadius:10,padding:12,textAlign:'center'}}>
                    <p className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:0.5}}>{stat.l}</p>
                    <p style={{fontSize:16,fontWeight:700,color:stat.c,marginTop:4}}>{stat.raw ? (stat.v || '--') : (stat.v > 0 ? fmt(stat.v) : '--')}</p>
                  </div>
                ))}
              </div>
              <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                <span style={{fontSize:11,color:'#94a3b8',background:'rgba(255,255,255,0.06)',padding:'4px 10px',borderRadius:8}}>{d.listings || 0} community listings</span>
                <span style={{fontSize:11,color:'#94a3b8',background:'rgba(255,255,255,0.06)',padding:'4px 10px',borderRadius:8}}>{d.totalComps || 0} comps</span>
                <span style={{fontSize:11,color:'#94a3b8',background:'rgba(255,255,255,0.06)',padding:'4px 10px',borderRadius:8}}>{d.soldCount || 0} sold</span>
              </div>
            </div>

            {/* Web Prices - category-aware */}
            <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:14}}>
                <span style={{fontSize:18}}>üåê</span>
                <h3 style={{fontSize:16,fontWeight:700,color:'#fff'}}>Live Market Prices</h3>
              </div>
              {(() => {
                const category = d.categories && d.categories[0] ? d.categories[0] : 'All';
                const mps = getMarketplacesForCategory(category, researchQuery);
                return (
                  <div style={{display:'flex',flexDirection:'column',gap:6}}>
                    {mps.map(m => (
                      <a key={m.name} href={m.url} target="_blank" rel="noopener noreferrer" style={{
                        display:'flex', alignItems:'center', justifyContent:'space-between',
                        background:m.bg, border:`1px solid ${m.color}22`, borderRadius:12,
                        padding:'10px 14px', textDecoration:'none',
                      }}>
                        <div>
                          <span style={{fontSize:13,fontWeight:600,color:m.color}}>{m.name}</span>
                          <span style={{fontSize:11,color:'#475569',marginLeft:8}}>{m.desc}</span>
                        </div>
                        <span style={{fontSize:12,color:m.color}}>‚Üó</span>
                      </a>
                    ))}
                  </div>
                );
              })()}
            </div>

            {/* Social Buzz */}
            <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                <span style={{fontSize:18}}>üì±</span>
                <h3 style={{fontSize:16,fontWeight:700,color:'#fff'}}>Social Buzz</h3>
              </div>
              <p className="text-dim" style={{fontSize:12,marginBottom:14}}>See what people are saying, unboxing, reviewing, and hyping</p>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
                {[
                  {name:'TikTok',color:'#000',bg:'linear-gradient(135deg,#25F4EE,#FE2C55)',url:`https://www.tiktok.com/search?q=${webQ}`,icon:'üéµ'},
                  {name:'Instagram',color:'#E1306C',bg:'linear-gradient(135deg,#833AB4,#E1306C,#F77737)',url:`https://www.instagram.com/explore/tags/${webQ.replace(/%20/g,'')}/`,icon:'üì∏'},
                  {name:'YouTube',color:'#FF0000',bg:'rgba(255,0,0,0.15)',url:`https://www.youtube.com/results?search_query=${webQ}+review`,icon:'üé¨'},
                  {name:'X / Twitter',color:'#000',bg:'rgba(255,255,255,0.1)',url:`https://x.com/search?q=${webQ}&f=live`,icon:'ùïè'},
                  {name:'Reddit',color:'#FF4500',bg:'rgba(255,69,0,0.12)',url:`https://www.reddit.com/search/?q=${webQ}&sort=new`,icon:'üí¨'},
                  {name:'Pinterest',color:'#E60023',bg:'rgba(230,0,35,0.12)',url:`https://www.pinterest.com/search/pins/?q=${webQ}`,icon:'üìå'},
                  {name:'Xiaohongshu',color:'#FE2C55',bg:'rgba(254,44,85,0.12)',url:`https://www.xiaohongshu.com/search_result?keyword=${webQ}`,icon:'üìï'},
                  {name:'Google Trends',color:'#4285f4',bg:'rgba(66,133,244,0.12)',url:`https://trends.google.com/trends/explore?q=${webQ}`,icon:'üìà'},
                ].map(s => (
                  <a key={s.name} href={s.url} target="_blank" rel="noopener noreferrer" style={{display:'flex',alignItems:'center',gap:10,background:typeof s.bg === 'string' && s.bg.startsWith('linear') ? undefined : s.bg,backgroundImage:typeof s.bg === 'string' && s.bg.startsWith('linear') ? s.bg : undefined,border:'1px solid rgba(255,255,255,0.08)',borderRadius:12,padding:'12px 14px',textDecoration:'none'}}>
                    <span style={{fontSize:20}}>{s.icon}</span>
                    <div>
                      <p style={{fontSize:13,fontWeight:600,color:'#fff'}}>{s.name}</p>
                    </div>
                  </a>
                ))}
              </div>
            </div>

            {/* Trend Analysis */}
            <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                <span style={{fontSize:18}}>üìà</span>
                <h3 style={{fontSize:16,fontWeight:700,color:'#fff'}}>Trend Analysis</h3>
              </div>
              <p className="text-dim" style={{fontSize:12,marginBottom:14}}>Is this item trending up or fading? Check the data.</p>
              <div style={{display:'flex',flexDirection:'column',gap:6}}>
                {[
                  {name:'Google Trends (Interest Over Time)',color:'#4285f4',url:`https://trends.google.com/trends/explore?q=${webQ}`,desc:'Search interest over 12 months'},
                  {name:'Google News',color:'#4285f4',url:`https://news.google.com/search?q=${webQ}`,desc:'Latest news and articles'},
                  {name:'eBay Trending',color:'#e53238',url:`https://www.ebay.com/sch/i.html?_nkw=${webQ}&_sop=1`,desc:'Most watched listings'},
                  {name:'Lyst (Fashion Trends)',color:'#000',url:`https://www.lyst.com/search/?q=${webQ}`,desc:'Fashion trend data'},
                ].map(t => (
                  <a key={t.name} href={t.url} target="_blank" rel="noopener noreferrer" style={{display:'flex',alignItems:'center',justifyContent:'space-between',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:12,padding:'10px 14px',textDecoration:'none'}}>
                    <div><span style={{fontSize:13,fontWeight:600,color:'#fff'}}>{t.name}</span><br/><span style={{fontSize:11,color:'#475569'}}>{t.desc}</span></div>
                    <span style={{fontSize:12,color:t.color}}>‚Üó</span>
                  </a>
                ))}
              </div>
            </div>

            {/* Community Comps */}
            {d.recentComps && d.recentComps.length > 0 && (
              <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:14}}>
                  <span style={{fontSize:18}}>üë•</span>
                  <h3 style={{fontSize:16,fontWeight:700,color:'#fff'}}>Community Comps</h3>
                </div>
                {d.recentComps.map((c, ci) => (
                  <div key={ci} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 0',borderBottom:ci < d.recentComps.length - 1 ? '1px solid rgba(255,255,255,0.04)' : 'none'}}>
                    <div>
                      <p className="truncate" style={{color:'#cbd5e1',fontSize:13,maxWidth:220}}>{c.title}</p>
                      <p className="text-dim" style={{fontSize:10}}>{c.source} ¬∑ {c.condition}</p>
                    </div>
                    <span className="text-gold" style={{fontWeight:700,fontSize:14}}>{fmt(c.price)}</span>
                  </div>
                ))}
              </div>
            )}

            {/* Actions */}
            <button onClick={() => setScreen('add-item')} className="gradient-amber" style={{width:'100%',border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:700,color:'#000',cursor:'pointer',marginBottom:12}}>
              Add This to My Inventory
            </button>
            <button onClick={() => setScreen('discover')} className="glass glass-hover" style={{width:'100%',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',fontSize:14,fontWeight:600,color:'#fff',cursor:'pointer',background:'rgba(255,255,255,0.06)',marginBottom:20}}>
              Back to Discover
            </button>
          </div>
        )}
      </div>
    );
  };

  /* ‚îÄ‚îÄ Add Item Form ‚îÄ‚îÄ */
  const emojiOptions = ['üì¶','üëú','üëü','ü™ë','üì∑','‚åö','üç≤','üì±','üéí','üéÆ','üíª','üñºÔ∏è','üé∏','üíé','üß•'];
  const categoryOptions = ['Fashion','Electronics','Home','Watches','Art','Sports','Collectibles','Trading Cards','Vinyl & Music','LEGO','Books','Coins & Stamps','Toys','Automotive','Tools','Other'];
  const conditionOptions = ['New','Like New','Excellent','Very Good','Good','Fair'];

  /* ‚îÄ‚îÄ Marketplace Config (category-aware) ‚îÄ‚îÄ */
  const ALL_MARKETPLACES = {
    // Universal marketplaces (shown for all categories)
    'eBay Sold':       { color:'#e53238', bg:'rgba(229,50,56,0.08)', urlFn: q => `https://www.ebay.com/sch/i.html?_nkw=${q}&LH_Sold=1&LH_Complete=1`, desc:'Actual sold prices', categories:'all' },
    'eBay Active':     { color:'#e53238', bg:'rgba(229,50,56,0.08)', urlFn: q => `https://www.ebay.com/sch/i.html?_nkw=${q}`, desc:'Current listings', categories:'all' },
    'Amazon':          { color:'#FF9900', bg:'rgba(255,153,0,0.08)', urlFn: q => `https://www.amazon.com/s?k=${q}`, desc:'New & used prices', categories:'all' },
    'Google Shopping':  { color:'#4285f4', bg:'rgba(66,133,244,0.08)', urlFn: q => `https://www.google.com/search?q=${q}+price&tbm=shop`, desc:'Compare across stores', categories:'all' },
    'Facebook':        { color:'#1877f2', bg:'rgba(24,119,242,0.08)', urlFn: q => `https://www.facebook.com/marketplace/search/?query=${q}`, desc:'Local deals', categories:'all' },
    'Mercari':         { color:'#4dc9f6', bg:'rgba(77,201,246,0.08)', urlFn: q => `https://www.mercari.com/search/?keyword=${q}`, desc:'General marketplace', categories:['Fashion','Electronics','Home','Toys','Sports','Collectibles','Other'] },
    // Fashion / Luxury
    'Poshmark':        { color:'#7f0353', bg:'rgba(127,3,83,0.08)', urlFn: q => `https://poshmark.com/search?query=${q}&type=listings&src=dir`, desc:'Fashion & accessories', categories:['Fashion','Watches'] },
    'StockX':          { color:'#0d9e4f', bg:'rgba(13,158,79,0.08)', urlFn: q => `https://stockx.com/search?s=${q}`, desc:'Sneakers, streetwear & collectibles', categories:['Fashion','Collectibles','Trading Cards','Electronics','Toys'] },
    'The RealReal':    { color:'#000000', bg:'rgba(255,255,255,0.06)', urlFn: q => `https://www.therealreal.com/search?q=${q}`, desc:'Luxury consignment', categories:['Fashion','Watches','Art'] },
    'Grailed':         { color:'#000000', bg:'rgba(255,255,255,0.06)', urlFn: q => `https://www.grailed.com/shop?query=${q}`, desc:"Men's fashion & streetwear", categories:['Fashion'] },
    'Vestiaire':       { color:'#1a1a1a', bg:'rgba(255,255,255,0.06)', urlFn: q => `https://www.vestiairecollective.com/search/?q=${q}`, desc:'Designer resale', categories:['Fashion','Watches'] },
    // Watches
    'Chrono24':        { color:'#C8A951', bg:'rgba(200,169,81,0.08)', urlFn: q => `https://www.chrono24.com/search/index.htm?query=${q}`, desc:'Luxury watch marketplace', categories:['Watches'] },
    // Trading Cards
    'TCGPlayer':       { color:'#F5A623', bg:'rgba(245,166,35,0.08)', urlFn: q => `https://www.tcgplayer.com/search/all/product?q=${q}`, desc:'Trading card marketplace', categories:['Trading Cards','Collectibles','Toys'] },
    'COMC':            { color:'#1a5276', bg:'rgba(26,82,118,0.08)', urlFn: q => `https://www.comc.com/Cards/Baseball,sp,${q}`, desc:'Sports cards & comics', categories:['Trading Cards','Collectibles','Sports'] },
    'Card Kingdom':    { color:'#2c3e50', bg:'rgba(44,62,80,0.08)', urlFn: q => `https://www.cardkingdom.com/catalog/search?search=header&filter%5Bname%5D=${q}`, desc:'Magic: The Gathering', categories:['Trading Cards'] },
    // Vinyl & Music
    'Discogs':         { color:'#333333', bg:'rgba(51,51,51,0.08)', urlFn: q => `https://www.discogs.com/search/?q=${q}&type=all`, desc:'Vinyl & music marketplace', categories:['Vinyl & Music','Collectibles'] },
    // LEGO
    'BrickLink':       { color:'#D01012', bg:'rgba(208,16,18,0.08)', urlFn: q => `https://www.bricklink.com/v2/search.page?q=${q}`, desc:'LEGO parts & sets', categories:['LEGO','Toys','Collectibles'] },
    // Books
    'AbeBooks':        { color:'#D4AF37', bg:'rgba(212,175,55,0.08)', urlFn: q => `https://www.abebooks.com/servlet/SearchResults?kn=${q}`, desc:'Rare & first edition books', categories:['Books','Collectibles'] },
    // Coins & Antiques
    'Heritage Auctions':{ color:'#8B4513', bg:'rgba(139,69,19,0.08)', urlFn: q => `https://www.ha.com/search/searchresults.s?N=0&Ntt=${q}`, desc:'Coins, stamps & fine art', categories:['Coins & Stamps','Art','Collectibles'] },
    // Collectibles & Live
    'Whatnot':         { color:'#7C3AED', bg:'rgba(124,58,237,0.08)', urlFn: q => `https://www.whatnot.com/search?q=${q}`, desc:'Live auction collectibles', categories:['Collectibles','Trading Cards','Toys','Fashion','Coins & Stamps','Vinyl & Music'] },
    'GoCollect':       { color:'#2196F3', bg:'rgba(33,150,243,0.08)', urlFn: q => `https://gocollect.com/search?q=${q}`, desc:'Comic book values', categories:['Collectibles','Books'] },
    'HobbyDB':         { color:'#FF6B35', bg:'rgba(255,107,53,0.08)', urlFn: q => `https://www.hobbydb.com/marketplaces/hobbydb/catalog_items?q=${q}`, desc:'Funko, toys & collectibles', categories:['Collectibles','Toys'] },
    'Catawiki':        { color:'#F7941D', bg:'rgba(247,148,29,0.08)', urlFn: q => `https://www.catawiki.com/en/s/?q=${q}`, desc:'Curated auctions', categories:['Collectibles','Art','Watches','Coins & Stamps'] },
    // General
    'TikTok Shop':     { color:'#FE2C55', bg:'rgba(254,44,85,0.08)', urlFn: q => `https://www.tiktok.com/search?q=${q}+shop`, desc:'Trending products', categories:['Fashion','Electronics','Collectibles','Toys'] },
    'Craigslist':      { color:'#5a0e8f', bg:'rgba(90,14,143,0.08)', urlFn: q => `https://www.craigslist.org/search/sss?query=${q}`, desc:'Local classifieds', categories:['Home','Automotive','Electronics','Tools'] },
  };

  // Keyword hints to infer category from search query
  const CATEGORY_KEYWORDS = {
    'Fashion': ['shirt','dress','jacket','jeans','sneaker','shoe','boots','bag','purse','handbag','wallet','belt','hat','sunglasses','coat','hoodie','sweater','denim','leather','nike','adidas','jordan','yeezy','supreme','gucci','louis vuitton','chanel','prada','balenciaga','poshmark','grailed','streetwear','vintage clothing','designer','lululemon','hermes','birkin','tiffany','polo','ralph lauren','north face','patagonia'],
    'Electronics': ['phone','laptop','tablet','camera','headphones','speaker','monitor','gpu','cpu','console','playstation','xbox','nintendo','switch','iphone','ipad','macbook','samsung','sony','apple','airpods','tv','drone','keyboard','mouse','projector','router','gopro','kindle','oculus','quest','steam deck','graphics card','motherboard','ram','ssd'],
    'Home': ['furniture','lamp','rug','plant','bonsai','vase','chair','table','desk','shelf','mirror','clock','decor','candle','pillow','blanket','kitchen','cookware','appliance','blender','pottery','ceramic','roomba','dyson','vitamix','le creuset','instant pot','air fryer','espresso','coffee maker'],
    'Watches': ['watch','rolex','omega','seiko','casio','cartier','patek','audemars','breitling','tudor','tag heuer','chronograph','timepiece','wristwatch','g-shock','tissot','hamilton','citizen','orient','swatch'],
    'Art': ['painting','sculpture','print','lithograph','canvas','artwork','drawing','illustration','photograph','signed art','limited print','fine art','abstract','oil painting','watercolor','banksy','warhol','kaws','shepard fairey'],
    'Sports': ['baseball','football','basketball','soccer','tennis','golf','hockey','bat','glove','jersey','helmet','racket','athletic','fitness','weights','bike','cycling','skiing','surfboard','cleats','nfl','nba','mlb','nhl'],
    'Collectibles': ['antique','vintage','memorabilia','figurine','statue','prop','funko','pop vinyl','bobblehead','pin','badge','medal','action figure','collectible','signed','autograph','limited edition','spider-man','batman','superman','marvel','dc comics','star wars','disney','sideshow','hot toys','neca','mcfarlane','spawn','iron man','hulk','x-men','avengers','deadpool','wolverine','cgc','cbcs','slabbed'],
    'Trading Cards': ['pokemon','magic the gathering','mtg','yugioh','baseball card','football card','sports card','tcg','charizard','psa','bgs','graded card','booster','pack','topps','panini','upper deck','prizm','donruss','fleer','bowman','rookie card','refractor','holo','holographic'],
    'Vinyl & Music': ['vinyl','record','album','lp','turntable','cassette','cd','band','concert','pressing','first press','discogs','beatles','pink floyd','led zeppelin','nirvana','radiohead','taylor swift','kanye'],
    'LEGO': ['lego','brick','minifig','minifigure','lego set','technic','star wars lego','creator','modular','bricklink','bionicle','ninjago','duplo'],
    'Books': ['book','novel','first edition','signed copy','hardcover','paperback','comic','comic book','comics','manga','graphic novel','textbook','rare book','manuscript','amazing spider','detective comics','action comics','walking dead','saga','sandman','watchmen','x-men comic','batman comic','issue #','spider-man #','incredible hulk','fantastic four','dc comic','marvel comic','image comics','dark horse'],
    'Coins & Stamps': ['coin','penny','quarter','dollar','stamp','bullion','silver','gold coin','numismatic','mint','proof','currency','banknote','medal','morgan dollar','peace dollar','buffalo nickel','wheat penny','silver eagle','krugerrand'],
    'Toys': ['toy','doll','barbie','hot wheels','transformer','nerf','board game','puzzle','plush','stuffed animal','rc car','model kit','train set','gi joe','power rangers','he-man','teenage mutant','tmnt','beanie baby','tamagotchi','furby','squishmallow'],
    'Automotive': ['car','truck','motorcycle','wheel','tire','bumper','engine','exhaust','headlight','seat','steering','obd','auto part','classic car','vintage car','mustang','corvette','porsche','ferrari','bmw','mercedes','tesla','turbo','carburetor'],
    'Tools': ['drill','saw','wrench','hammer','screwdriver','tool set','power tool','dewalt','milwaukee','makita','craftsman','welder','compressor','level','measuring','snap-on','festool','bosch','ryobi'],
  };

  // Regex patterns that strongly signal a category (e.g. issue numbers for comics)
  const CATEGORY_PATTERNS = {
    'Books': [/\#\d+/, /issue\s*\d+/i, /vol(\.|ume)?\s*\d+/i],
    'Collectibles': [/\#\d+/, /series\s*\d+/i, /wave\s*\d+/i, /chase\s+variant/i],
    'Coins & Stamps': [/\d{4}\s*(dollar|penny|cent|dime|quarter)/i, /ms\s*\d{2}/i, /pr\s*\d{2}/i],
    'Trading Cards': [/\#\d+\/\d+/i, /psa\s*\d+/i, /bgs\s*[\d.]+/i, /1st\s*edition/i],
  };

  const inferCategoriesFromQuery = (query) => {
    if (!query || !query.trim()) return [];
    const q = query.toLowerCase().trim();
    const matched = new Set();

    // Check PRODUCT_DB first for exact/partial matches
    PRODUCT_DB.forEach(p => {
      const pText = (p.name + ' ' + p.brand + ' ' + p.model).toLowerCase();
      if (q.split(/\s+/).every(w => pText.includes(w)) || pText.includes(q)) {
        matched.add(p.cat);
      }
    });

    // Check keyword hints (check each word in query against keywords too)
    const queryWords = q.split(/\s+/).filter(w => w.length > 2);
    Object.entries(CATEGORY_KEYWORDS).forEach(([cat, keywords]) => {
      if (keywords.some(kw => q.includes(kw) || kw.includes(q) || queryWords.some(w => kw.includes(w) && w.length > 3))) {
        matched.add(cat);
      }
    });

    // Check regex patterns (issue numbers, grading, etc.)
    Object.entries(CATEGORY_PATTERNS).forEach(([cat, patterns]) => {
      if (patterns.some(rx => rx.test(query))) {
        matched.add(cat);
      }
    });

    return [...matched];
  };

  const getMarketplacesForCategory = (category, query) => {
    const q = encodeURIComponent(query);

    // If a specific category is selected (not "All"), use it directly
    let effectiveCategories = null;
    if (category && category !== 'All') {
      effectiveCategories = [category];
    } else if (query && query.trim()) {
      // Infer categories from the search query
      effectiveCategories = inferCategoriesFromQuery(query);
    }

    return Object.entries(ALL_MARKETPLACES)
      .filter(([_, mp]) => {
        // Universal marketplaces always show
        if (mp.categories === 'all') return true;
        // If we have effective categories, only show marketplaces matching those
        if (effectiveCategories && effectiveCategories.length > 0) {
          return Array.isArray(mp.categories) && mp.categories.some(c => effectiveCategories.includes(c));
        }
        // No category and no query match: only show universal marketplaces
        return false;
      })
      .map(([name, mp]) => ({ name, color: mp.color, bg: mp.bg, url: mp.urlFn(q), desc: mp.desc }));
  };

  // Comp source options (all platforms a user might log a comp from)
  const compSourceOptions = ['eBay','Amazon','Poshmark','Mercari','StockX','Facebook Marketplace','Craigslist','The RealReal','Vestiaire','Grailed','Chrono24','TCGPlayer','COMC','Discogs','BrickLink','AbeBooks','Heritage Auctions','Whatnot','GoCollect','HobbyDB','Catawiki','TikTok Shop','Card Kingdom','Other'];

  // Use refs for text inputs to prevent re-renders (fixes iOS keyboard dismissal)
  const formRefs = {
    name: useRef(null),
    brand: useRef(null),
    model: useRef(null),
    cost: useRef(null),
    datePurchased: useRef(null),
    asking: useRef(null),
    market: useRef(null),
    notes: useRef(null),
  };
  // Only emoji, category, condition, and photos use state (no keyboard involved)
  const [addFormUI, setAddFormUI] = useState({category:'Fashion',condition:'Good',emoji:'üì¶',photos:[]});

  const resetAddForm = () => {
    Object.values(formRefs).forEach(ref => { if (ref.current) ref.current.value = ''; });
    setAddFormUI({category:'Fashion',condition:'Good',emoji:'üì¶',photos:[]});
    setScanData(null);
  };

  // Reset autocomplete when entering add-item screen; pre-fill from scan
  useEffect(() => {
    if (screen === 'add-item') { setAddItemQuery(''); setShowAddSuggestions(false); }
    if (screen === 'add-item' && scanData) {
      setTimeout(() => {
        if (formRefs.name.current && scanData.name) formRefs.name.current.value = scanData.name;
        if (formRefs.brand.current && scanData.brand) formRefs.brand.current.value = scanData.brand;
        if (formRefs.model.current && scanData.model) formRefs.model.current.value = scanData.model;
        if (formRefs.cost.current && scanData.cost) formRefs.cost.current.value = scanData.cost;
        if (formRefs.market.current && scanData.market) formRefs.market.current.value = scanData.market;
        const updates = {};
        if (scanData.category) updates.category = scanData.category;
        if (scanData.photos && scanData.photos.length > 0) updates.photos = scanData.photos;
        if (Object.keys(updates).length > 0) setAddFormUI(prev => ({...prev, ...updates}));
      }, 100);
    }
  }, [screen, scanData]);

  const AddItemScreen = () => (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      {/* Header */}
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px',position:'sticky',top:0,background:'linear-gradient(180deg,#0a0a0f 80%,transparent)',zIndex:20}}>
        <button onClick={() => setScreen('home')} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
        <h1 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Add Item</h1>
        <div style={{width:24}}/>
      </div>

      {scanData && (
        <div style={{margin:'0 24px 12px',background:'rgba(34,197,94,0.1)',border:'1px solid rgba(34,197,94,0.2)',borderRadius:12,padding:'10px 16px',display:'flex',alignItems:'center',gap:10}}>
          <span style={{fontSize:16}}>{scanData.source === 'barcode' ? 'üìä' : 'üì∏'}</span>
          <div>
            <p style={{fontSize:13,fontWeight:600,color:'#4ade80'}}>{scanData.source === 'barcode' ? 'Scanned from barcode' : 'Photo captured'}</p>
            <p style={{fontSize:11,color:'#94a3b8'}}>Review the details below and tap Save when ready.</p>
          </div>
        </div>
      )}

      <div style={{padding:'0 24px'}}>
        {/* Emoji picker */}
        <FormField label="Icon">
          <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
            {emojiOptions.map(e => (
              <button key={e} onClick={() => setAddFormUI(prev => ({...prev,emoji:e}))} style={{width:44,height:44,borderRadius:10,fontSize:22,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',border: addFormUI.emoji===e ? '2px solid #d4a853' : '1px solid rgba(255,255,255,0.1)',background: addFormUI.emoji===e ? 'rgba(212,168,83,0.15)' : 'rgba(255,255,255,0.04)'}}>{e}</button>
            ))}
          </div>
        </FormField>

        {/* Photo Upload */}
        <FormField label={`Photos (${addFormUI.photos.length}/5)`} tip="Tap any photo to set it as cover.">
          <div style={{display:'flex',gap:10,flexWrap:'wrap'}}>
            {addFormUI.photos.map((photo,idx) => (
              <div key={idx} onClick={() => { if (idx !== 0) setAddFormUI(prev => { const p = [...prev.photos]; const [moved] = p.splice(idx, 1); p.unshift(moved); return {...prev, photos: p}; }); }} style={{width:72,height:72,borderRadius:12,overflow:'hidden',position:'relative',border: idx === 0 ? '2px solid #d4a853' : '1px solid rgba(255,255,255,0.1)',cursor:'pointer'}}>
                <img src={photo} style={{width:'100%',height:'100%',objectFit:'cover'}}/>
                {idx===0 && <div style={{position:'absolute',bottom:0,left:0,right:0,background:'rgba(212,168,83,0.9)',padding:'2px 0',textAlign:'center'}}><span style={{fontSize:8,fontWeight:700,color:'#000',textTransform:'uppercase',letterSpacing:0.5}}>Cover</span></div>}
                {idx!==0 && <div style={{position:'absolute',bottom:0,left:0,right:0,background:'rgba(0,0,0,0.6)',padding:'2px 0',textAlign:'center'}}><span style={{fontSize:7,fontWeight:600,color:'#94a3b8',textTransform:'uppercase',letterSpacing:0.5}}>Tap for cover</span></div>}
                <button onClick={(e) => { e.stopPropagation(); setAddFormUI(prev => ({...prev,photos:prev.photos.filter((_,i)=>i!==idx)})); }} style={{position:'absolute',top:4,right:4,width:20,height:20,borderRadius:10,background:'rgba(0,0,0,0.7)',border:'none',color:'#fff',fontSize:12,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',lineHeight:1}}>√ó</button>
              </div>
            ))}
            {addFormUI.photos.length < 5 && (
              <label style={{width:72,height:72,borderRadius:12,border:'2px dashed rgba(255,255,255,0.15)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',cursor:'pointer',background:'rgba(255,255,255,0.03)',gap:4}}>
                <Icons.Camera size={20} color="#64748b"/>
                <span style={{fontSize:9,color:'#64748b',fontWeight:600}}>Add</span>
                <input type="file" accept="image/*" multiple style={{display:'none'}} onChange={e => {
                  const files = Array.from(e.target.files).slice(0, 5 - addFormUI.photos.length);
                  files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                      const compressed = await compressPhoto(ev.target.result);
                      setAddFormUI(prev => ({...prev, photos: [...prev.photos, compressed].slice(0,5)}));
                    };
                    reader.readAsDataURL(file);
                  });
                  e.target.value = '';
                }}/>
              </label>
            )}
          </div>
        </FormField>

        {/* Item name with autocomplete */}
        <FormField label="Item Name" required>
          <div style={{position:'relative'}}>
            <input ref={formRefs.name} className="form-input" defaultValue="" placeholder="e.g. Louis Vuitton Neverfull MM" style={inputStyle}
              onChange={e => { setAddItemQuery(e.target.value); setShowAddSuggestions(e.target.value.trim().length > 0); }}
              onFocus={e => { if (e.target.value.trim().length > 0) setShowAddSuggestions(true); }}
              onBlur={() => setTimeout(() => setShowAddSuggestions(false), 200)}
              autoComplete="off"/>
            {showAddSuggestions && addItemQuery.trim().length > 0 && (() => {
              const suggestions = getSuggestions(addItemQuery);
              if (suggestions.length === 0) return null;
              return (
                <div style={{position:'absolute',top:'100%',left:0,right:0,zIndex:50,marginTop:4,background:'#1a1a2e',border:'1px solid rgba(255,255,255,0.12)',borderRadius:12,overflow:'hidden',boxShadow:'0 8px 32px rgba(0,0,0,0.5)',maxHeight:240,overflowY:'auto'}}>
                  {suggestions.map((s, i) => (
                    <div key={i} onMouseDown={e => e.preventDefault()} onClick={() => {
                      if (formRefs.name.current) formRefs.name.current.value = s.text;
                      if (formRefs.brand.current && s.brand) formRefs.brand.current.value = s.brand;
                      if (formRefs.model.current && s.model) formRefs.model.current.value = s.model;
                      const matched = PRODUCT_DB.find(p => p.name.toLowerCase() === s.text.toLowerCase());
                      if (matched) {
                        if (matched.emoji) setAddFormUI(prev => ({...prev, emoji: matched.emoji}));
                        if (matched.cat) setAddFormUI(prev => ({...prev, category: matched.cat}));
                      }
                      setAddItemQuery(''); setShowAddSuggestions(false);
                    }}
                      style={{padding:'12px 16px',display:'flex',alignItems:'center',gap:10,cursor:'pointer',borderBottom: i < suggestions.length - 1 ? '1px solid rgba(255,255,255,0.06)' : 'none',background:'transparent'}}
                      onMouseEnter={e => e.currentTarget.style.background='rgba(255,255,255,0.06)'}
                      onMouseLeave={e => e.currentTarget.style.background='transparent'}>
                      <span style={{fontSize:14}}>{s.emoji}</span>
                      <div style={{flex:1,minWidth:0}}>
                        <p className="truncate" style={{fontSize:13,color:'#fff',fontWeight:500}}>{s.text}</p>
                        {s.brand && <p style={{fontSize:10,color:'rgba(255,255,255,0.4)',marginTop:1}}>{[s.brand, s.model].filter(Boolean).join(' ¬∑ ')}</p>}
                      </div>
                      <span style={{fontSize:10,color: s.source === 'inventory' ? '#d4a853' : s.source === 'suggested' ? '#a855f7' : '#64748b',background: s.source === 'inventory' ? 'rgba(212,168,83,0.1)' : s.source === 'suggested' ? 'rgba(168,85,247,0.1)' : 'rgba(255,255,255,0.04)',padding:'2px 8px',borderRadius:6,fontWeight:600}}>
                        {s.source === 'inventory' ? 'My Items' : s.source === 'suggested' ? 'Suggested' : 'Try this'}
                      </span>
                    </div>
                  ))}
                </div>
              );
            })()}
          </div>
        </FormField>

        {/* Brand + Model row */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <FormField label="Brand">
            <input ref={formRefs.brand} className="form-input" defaultValue="" placeholder="e.g. Nike" style={inputStyle}/>
          </FormField>
          <FormField label="Model">
            <input ref={formRefs.model} className="form-input" defaultValue="" placeholder="e.g. Dunk Low" style={inputStyle}/>
          </FormField>
        </div>

        {/* Category + Condition row */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <FormField label="Category" required>
            <select value={addFormUI.category} onChange={e => setAddFormUI(prev => ({...prev,category:e.target.value}))} style={{...inputStyle,cursor:'pointer'}}>
              {categoryOptions.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </FormField>
          <FormField label="Condition">
            <select value={addFormUI.condition} onChange={e => setAddFormUI(prev => ({...prev,condition:e.target.value}))} style={{...inputStyle,cursor:'pointer'}}>
              {conditionOptions.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </FormField>
        </div>

        {/* Divider */}
        <div style={{borderTop:'1px solid rgba(255,255,255,0.08)',margin:'8px 0 20px'}}/>
        <h3 style={{fontSize:14,fontWeight:700,color:'#fff',marginBottom:16}}>Pricing</h3>

        {/* What I Paid */}
        <FormField label="What I Paid" required tip="The total amount you spent to acquire this item, including tax and shipping.">
          <div style={{position:'relative'}}>
            <span style={{position:'absolute',left:14,top:'50%',transform:'translateY(-50%)',color:'#64748b',fontSize:14,fontWeight:600}}>$</span>
            <input ref={formRefs.cost} className="form-input" type="number" defaultValue="" placeholder="0.00" style={{...inputStyle,paddingLeft:28}}/>
          </div>
        </FormField>

        {/* Date Purchased */}
        <FormField label="Date Purchased" tip="When you bought or acquired this item.">
          <input ref={formRefs.datePurchased} className="form-input" type="date" defaultValue="" style={{...inputStyle,colorScheme:'dark'}}/>
        </FormField>

        {/* My Asking Price */}
        <FormField label="My Asking Price" tip="The price you'd list this item for if you sold it today. Leave blank to auto-set to market value.">
          <div style={{position:'relative'}}>
            <span style={{position:'absolute',left:14,top:'50%',transform:'translateY(-50%)',color:'#64748b',fontSize:14,fontWeight:600}}>$</span>
            <input ref={formRefs.asking} className="form-input" type="number" defaultValue="" placeholder="Optional" style={{...inputStyle,paddingLeft:28}}/>
          </div>
        </FormField>

        {/* Estimated Market Value */}
        <FormField label="Estimated Market Value" tip="What you think this item is worth based on your research. You can update this anytime.">
          <div style={{position:'relative'}}>
            <span style={{position:'absolute',left:14,top:'50%',transform:'translateY(-50%)',color:'#64748b',fontSize:14,fontWeight:600}}>$</span>
            <input ref={formRefs.market} className="form-input" type="number" defaultValue="" placeholder="Optional" style={{...inputStyle,paddingLeft:28}}/>
          </div>
        </FormField>

        {/* Notes */}
        <FormField label="Notes">
          <textarea ref={formRefs.notes} className="form-input" defaultValue="" placeholder="Any extra details, serial numbers, where you bought it..." rows={3} style={{...inputStyle,resize:'vertical',minHeight:60}}/>
        </FormField>

        {/* Submit */}
        <button onClick={() => {
          const name = formRefs.name.current?.value?.trim() || '';
          const cost = formRefs.cost.current?.value || '';
          if (!name || !cost) { alert('Please enter an item name and what you paid.'); return; }
          const newItem = {
            id: Date.now(),
            name: name,
            brand: formRefs.brand.current?.value?.trim() || '',
            model: formRefs.model.current?.value?.trim() || '',
            category: addFormUI.category,
            condition: addFormUI.condition,
            cost: parseFloat(cost) || 0,
            asking: parseFloat(formRefs.asking.current?.value) || 0,
            value: parseFloat(formRefs.market.current?.value) || parseFloat(formRefs.asking.current?.value) || parseFloat(cost) || 0,
            emoji: addFormUI.emoji,
            notes: formRefs.notes.current?.value?.trim() || '',
            photos: addFormUI.photos,
            comps: [],
            createdAt: new Date().toISOString(),
            datePurchased: formRefs.datePurchased.current?.value || null,
            earnings: null,
            dateSold: null,
            priceHistory: [{date: new Date().toISOString().slice(0,10), value: parseFloat(formRefs.market.current?.value) || parseFloat(formRefs.asking.current?.value) || parseFloat(cost) || 0, cost: parseFloat(cost) || 0, asking: parseFloat(formRefs.asking.current?.value) || 0}],
          };
          setItems(prev => [newItem, ...prev]);
          if (supabaseUserIdRef.current) {
            syncItem(newItem, supabaseUserIdRef.current);
            logEvent(supabaseUserIdRef.current, 'item_added', { name: newItem.name, category: newItem.category, cost: newItem.cost });
          }
          resetAddForm();
          setScreen('inventory');
        }} className="gradient-amber" style={{width:'100%',border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:700,color:'#000',cursor:'pointer',marginBottom:12}}>
          Save to Inventory
        </button>
        <button onClick={() => {resetAddForm();setScreen('home');}} style={{width:'100%',background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer'}}>
          Cancel
        </button>
      </div>
    </div>
  );

  const initEditForm = (item) => {
    setEditFormUI({category:item.category,condition:item.condition,emoji:item.emoji,photos:item.photos||[]});
    setTimeout(() => {
      if (editRefs.name.current) editRefs.name.current.value = item.name || '';
      if (editRefs.brand.current) editRefs.brand.current.value = item.brand || '';
      if (editRefs.model.current) editRefs.model.current.value = item.model || '';
      if (editRefs.notes.current) editRefs.notes.current.value = item.notes || '';
    }, 50);
  };

  const EditItemScreen = () => {
    if (!selected) return null;
    return (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px',position:'sticky',top:0,background:'linear-gradient(180deg,#0a0a0f 80%,transparent)',zIndex:20}}>
        <button onClick={() => setScreen('detail')} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
        <h1 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Edit Item</h1>
        <div style={{width:24}}/>
      </div>

      <div style={{padding:'0 24px'}}>
        {/* Emoji picker */}
        <FormField label="Icon">
          <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
            {emojiOptions.map(e => (
              <button key={e} onClick={() => setEditFormUI(prev => ({...prev,emoji:e}))} style={{width:44,height:44,borderRadius:10,fontSize:22,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',border: editFormUI.emoji===e ? '2px solid #d4a853' : '1px solid rgba(255,255,255,0.1)',background: editFormUI.emoji===e ? 'rgba(212,168,83,0.15)' : 'rgba(255,255,255,0.04)'}}>{e}</button>
            ))}
          </div>
        </FormField>

        {/* Photo Management */}
        <FormField label={`Photos (${editFormUI.photos.length}/5)`} tip="Tap any photo to set it as cover.">
          <div style={{display:'flex',gap:10,flexWrap:'wrap'}}>
            {editFormUI.photos.map((photo,idx) => (
              <div key={idx} onClick={() => { if (idx !== 0) setEditFormUI(prev => { const p = [...prev.photos]; const [moved] = p.splice(idx, 1); p.unshift(moved); return {...prev, photos: p}; }); }} style={{width:72,height:72,borderRadius:12,overflow:'hidden',position:'relative',border: idx === 0 ? '2px solid #d4a853' : '1px solid rgba(255,255,255,0.1)',cursor:'pointer'}}>
                <img src={photo} style={{width:'100%',height:'100%',objectFit:'cover'}}/>
                {idx===0 && <div style={{position:'absolute',bottom:0,left:0,right:0,background:'rgba(212,168,83,0.9)',padding:'2px 0',textAlign:'center'}}><span style={{fontSize:8,fontWeight:700,color:'#000',textTransform:'uppercase',letterSpacing:0.5}}>Cover</span></div>}
                {idx!==0 && <div style={{position:'absolute',bottom:0,left:0,right:0,background:'rgba(0,0,0,0.6)',padding:'2px 0',textAlign:'center'}}><span style={{fontSize:7,fontWeight:600,color:'#94a3b8',textTransform:'uppercase',letterSpacing:0.5}}>Tap for cover</span></div>}
                <button onClick={(e) => { e.stopPropagation(); setEditFormUI(prev => ({...prev,photos:prev.photos.filter((_,i)=>i!==idx)})); }} style={{position:'absolute',top:4,right:4,width:20,height:20,borderRadius:10,background:'rgba(0,0,0,0.7)',border:'none',color:'#fff',fontSize:12,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',lineHeight:1}}>√ó</button>
              </div>
            ))}
            {editFormUI.photos.length < 5 && (
              <label style={{width:72,height:72,borderRadius:12,border:'2px dashed rgba(255,255,255,0.15)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',cursor:'pointer',background:'rgba(255,255,255,0.03)',gap:4}}>
                <Icons.Camera size={20} color="#64748b"/>
                <span style={{fontSize:9,color:'#64748b',fontWeight:600}}>Add</span>
                <input type="file" accept="image/*" multiple style={{display:'none'}} onChange={e => {
                  const files = Array.from(e.target.files).slice(0, 5 - editFormUI.photos.length);
                  files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                      const compressed = await compressPhoto(ev.target.result);
                      setEditFormUI(prev => ({...prev, photos: [...prev.photos, compressed].slice(0,5)}));
                    };
                    reader.readAsDataURL(file);
                  });
                  e.target.value = '';
                }}/>
              </label>
            )}
          </div>
        </FormField>

        {/* Item name */}
        <FormField label="Item Name" required>
          <input ref={editRefs.name} className="form-input" defaultValue="" placeholder="e.g. Louis Vuitton Neverfull MM" style={inputStyle}/>
        </FormField>

        {/* Brand + Model row */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <FormField label="Brand">
            <input ref={editRefs.brand} className="form-input" defaultValue="" placeholder="e.g. Nike" style={inputStyle}/>
          </FormField>
          <FormField label="Model">
            <input ref={editRefs.model} className="form-input" defaultValue="" placeholder="e.g. Dunk Low" style={inputStyle}/>
          </FormField>
        </div>

        {/* Category + Condition row */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <FormField label="Category" required>
            <select value={editFormUI.category} onChange={e => setEditFormUI(prev => ({...prev,category:e.target.value}))} style={{...inputStyle,cursor:'pointer'}}>
              {categoryOptions.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </FormField>
          <FormField label="Condition">
            <select value={editFormUI.condition} onChange={e => setEditFormUI(prev => ({...prev,condition:e.target.value}))} style={{...inputStyle,cursor:'pointer'}}>
              {conditionOptions.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </FormField>
        </div>

        {/* Notes */}
        <FormField label="Notes">
          <textarea ref={editRefs.notes} className="form-input" defaultValue="" placeholder="Any extra details, serial numbers, where you bought it..." rows={3} style={{...inputStyle,resize:'vertical',minHeight:60}}/>
        </FormField>

        {/* Save */}
        <button onClick={() => {
          const name = editRefs.name.current?.value?.trim() || '';
          if (!name) { alert('Item name is required.'); return; }
          setItems(prev => prev.map(it => it.id === selected.id ? {
            ...it,
            name,
            brand: editRefs.brand.current?.value?.trim() || '',
            model: editRefs.model.current?.value?.trim() || '',
            category: editFormUI.category,
            condition: editFormUI.condition,
            emoji: editFormUI.emoji,
            notes: editRefs.notes.current?.value?.trim() || '',
            photos: editFormUI.photos,
          } : it));
          setScreen('detail');
        }} className="gradient-amber" style={{width:'100%',border:'none',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:700,color:'#000',cursor:'pointer',marginBottom:12}}>
          Save Changes
        </button>
        <button onClick={() => setScreen('detail')} style={{width:'100%',background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer'}}>
          Cancel
        </button>
      </div>
    </div>
    );
  };

  const InventoryScreen = () => (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      {/* Header */}
      <div style={{padding:'20px 24px 0',position:'sticky',top:0,background:'linear-gradient(180deg,#0a0a0f 80%,transparent)',zIndex:20,paddingBottom:16}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <h1 style={{fontSize:24,fontWeight:700,color:'#fff'}}>Inventory</h1>
            {items.length > 0 && <span style={{background:'rgba(212,168,83,0.15)',color:'#d4a853',fontSize:12,fontWeight:700,padding:'4px 10px',borderRadius:20}}>{items.length}</span>}
          </div>
          <button onClick={() => setViewMode(viewMode==='grid'?'list':'grid')} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}>
            {viewMode==='grid' ? <Icons.List size={22}/> : <Icons.Grid size={22}/>}
          </button>
        </div>

        {/* Search */}
        <div className="glass" style={{borderRadius:12,padding:'12px 14px',display:'flex',alignItems:'center',gap:10,marginBottom:14}}>
          <Icons.Search size={16} color="#64748b"/>
          <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search items..." style={{background:'none',border:'none',outline:'none',color:'#fff',fontSize:14,width:'100%'}}/>
        </div>

        {/* Filters */}
        <div className="scroll-hide" style={{display:'flex',gap:8,overflowX:'auto',marginBottom:12}}>
          {['All', ...categoryOptions.filter(cat => items.some(i => i.category === cat))].map(f => (
            <button key={f} onClick={() => setFilter(f)} style={{padding:'8px 16px',borderRadius:10,fontSize:13,fontWeight:600,whiteSpace:'nowrap',cursor:'pointer',border: filter===f?'none':'1px solid rgba(255,255,255,0.1)',background: filter===f?'linear-gradient(135deg,#d4a853,#b8860b)':'rgba(255,255,255,0.04)',color: filter===f?'#000':'#fff'}}>{f}</button>
          ))}
        </div>

        {/* Sort */}
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <Icons.Filter size={14} color="#64748b"/>
          <select value={sortBy} onChange={e => setSortBy(e.target.value)} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',color:'#fff',fontSize:13,borderRadius:8,padding:'6px 10px',outline:'none'}}>
            <option value="value-high">Value: High to Low</option>
            <option value="value-low">Value: Low to High</option>
            <option value="gain">Biggest Gains</option>
          </select>
        </div>
      </div>

      {/* Items */}
      <div style={{padding:'12px 24px'}}>
        {filtered.length === 0 ? (
          <div style={{textAlign:'center',padding:'48px 24px'}}>
            <p style={{fontSize:48,marginBottom:12}}>üì¶</p>
            <p style={{fontSize:16,fontWeight:600,color:'#fff',marginBottom:6}}>{items.length === 0 ? 'No items yet' : 'No matches found'}</p>
            <p className="text-muted" style={{fontSize:13,marginBottom:20}}>{items.length === 0 ? 'Tap "+ Add Manually" to start building your inventory.' : 'Try a different search or filter.'}</p>
            {items.length === 0 && <button onClick={() => setScreen('add-item')} className="gradient-amber" style={{border:'none',borderRadius:12,padding:'12px 24px',fontSize:14,fontWeight:600,color:'#000',cursor:'pointer'}}>+ Add Your First Item</button>}
          </div>
        ) : viewMode === 'grid' ? (
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
            {filtered.map((item,i) => (
              <div key={item.id} onClick={() => goItem(item.id)} className="glass glass-hover anim-up" style={{borderRadius:16,overflow:'hidden',cursor:'pointer',animationDelay:`${i*0.06}s`}}>
                <div style={{width:'100%',height:120,background:'linear-gradient(135deg,#334155,#1e293b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:44,overflow:'hidden',position:'relative'}}>
                  {item.photos && item.photos.length > 0 ? <img src={item.photos[0]} style={{width:'100%',height:'100%',objectFit:'cover'}}/> : item.emoji}
                  {item.earnings && item.earnings > 0 && <div style={{position:'absolute',top:6,right:6,background:'rgba(34,197,94,0.9)',borderRadius:6,padding:'2px 6px',fontSize:9,fontWeight:700,color:'#fff'}}>SOLD</div>}
                </div>
                <div style={{padding:12}}>
                  <p className="truncate" style={{fontWeight:600,color:'#fff',fontSize:13}}>{item.name}</p>
                  <p className="text-dim" style={{fontSize:11,marginTop:3}}>{item.condition}</p>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:10}}>
                    <span className="text-gold" style={{fontWeight:700,fontSize:14}}>{fmt(item.value)}</span>
                    <GainBadge gain={getItemGain(item)}/>
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {filtered.map((item,i) => (
              <div key={item.id} onClick={() => goItem(item.id)} className="glass glass-hover anim-right" style={{borderRadius:14,padding:16,display:'flex',alignItems:'center',gap:14,cursor:'pointer',animationDelay:`${i*0.04}s`}}>
                <div style={{width:56,height:56,borderRadius:12,background:'linear-gradient(135deg,#334155,#1e293b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,flexShrink:0,overflow:'hidden'}}>
                  {item.photos && item.photos.length > 0 ? <img src={item.photos[0]} style={{width:'100%',height:'100%',objectFit:'cover'}}/> : item.emoji}
                </div>
                <div style={{flex:1,minWidth:0}}>
                  <p className="truncate" style={{fontWeight:600,color:'#fff',fontSize:14}}>{item.name}</p>
                  <p className="text-dim" style={{fontSize:12,marginTop:3}}>{item.condition}</p>
                </div>
                <div style={{textAlign:'right',flexShrink:0}}>
                  <p className="text-gold" style={{fontWeight:700,fontSize:15}}>{fmt(item.value)}</p>
                  <div style={{marginTop:3}}><GainBadge gain={getItemGain(item)}/></div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );

  const DetailScreen = () => {
    if (!selected) return null;
    const currentCost = getItemCost(selected);
    const profit = selected.value - currentCost;
    const gainPct = currentCost === 0 ? 0 : Math.round(((selected.value - currentCost) / currentCost) * 100);
    return (
      <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
        {/* Header */}
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px',position:'sticky',top:0,background:'linear-gradient(180deg,#0a0a0f 80%,transparent)',zIndex:20}}>
          <button onClick={() => {setScreen('inventory');setEditingCost(false);}} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
          <h1 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Details</h1>
          <button onClick={() => alert('Sharing is coming soon!')} style={{background:'none',border:'none',color:'#475569',cursor:'pointer'}}><Icons.Share size={22}/></button>
        </div>

        {/* Photo Gallery */}
        <div style={{padding:'0 24px 20px'}}>
          <div style={{width:'100%',height:280,borderRadius:24,background:'linear-gradient(135deg,#334155,#1e293b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:80,position:'relative',overflow:'hidden'}}
            onTouchStart={e => { e.currentTarget._touchX = e.touches[0].clientX; }}
            onTouchEnd={e => {
              const diff = e.currentTarget._touchX - e.changedTouches[0].clientX;
              const total = selected.photos?.length || 0;
              if (total > 1) {
                if (diff > 40) setPhotoIndex(prev => Math.min(prev + 1, total - 1));
                if (diff < -40) setPhotoIndex(prev => Math.max(prev - 1, 0));
              }
            }}>
            {selected.photos && selected.photos.length > 0 ? (
              <img src={selected.photos[photoIndex] || selected.photos[0]} style={{width:'100%',height:'100%',objectFit:'cover',transition:'opacity 0.2s ease'}} />
            ) : (
              selected.emoji
            )}
            <div style={{position:'absolute',bottom:0,left:0,right:0,height:'30%',background:'linear-gradient(to top,rgba(10,10,15,0.5),transparent)'}}/>
            {/* Left/Right tap zones */}
            {selected.photos && selected.photos.length > 1 && (
              <React.Fragment>
                {photoIndex > 0 && <div onClick={() => setPhotoIndex(prev => prev - 1)} style={{position:'absolute',left:0,top:0,bottom:0,width:'30%',cursor:'pointer'}}/>}
                {photoIndex < selected.photos.length - 1 && <div onClick={() => setPhotoIndex(prev => prev + 1)} style={{position:'absolute',right:0,top:0,bottom:0,width:'30%',cursor:'pointer'}}/>}
              </React.Fragment>
            )}
            {/* Photo counter */}
            {selected.photos && selected.photos.length > 1 && (
              <div style={{position:'absolute',top:12,right:12,background:'rgba(0,0,0,0.6)',borderRadius:12,padding:'4px 10px',fontSize:11,fontWeight:600,color:'#fff'}}>{photoIndex + 1}/{selected.photos.length}</div>
            )}
            {/* Dots */}
            {selected.photos && selected.photos.length > 0 && (
              <div style={{position:'absolute',bottom:16,left:'50%',transform:'translateX(-50%)',display:'flex',gap:6}}>
                {selected.photos.map((_, idx) => (
                  <div key={idx} onClick={() => setPhotoIndex(idx)} style={{width: idx === photoIndex ? 24 : 6, height:6, borderRadius:3, background: idx === photoIndex ? '#fff' : 'rgba(255,255,255,0.3)', transition:'width 0.2s ease', cursor:'pointer'}}/>
                ))}
              </div>
            )}
          </div>
        </div>

        <div style={{padding:'0 24px'}}>
          <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
            <h2 style={{fontSize:22,fontWeight:700,color:'#fff'}}>{selected.name}</h2>
            {selected.earnings && selected.earnings > 0 && <span style={{background:'rgba(34,197,94,0.15)',color:'#22c55e',fontSize:10,fontWeight:700,padding:'3px 8px',borderRadius:6}}>SOLD</span>}
          </div>
          <p className="text-muted" style={{fontSize:13,marginBottom:24}}>{selected.category} ¬∑ {selected.condition}</p>

          {/* Valuation */}
          {(() => {
            const currentAsking = getItemAsking(selected);
            const currentEarnings = selected.earnings || 0;
            const hasSold = currentEarnings > 0;
            const investProfit = currentAsking - currentCost;
            const investPct = currentCost === 0 ? 0 : Math.round((investProfit / currentCost) * 100);
            const resaleDiff = currentAsking - selected.value;
            const resalePct = selected.value === 0 ? 0 : Math.round((resaleDiff / selected.value) * 100);
            const netProfit = hasSold ? (currentEarnings - currentCost) : (currentAsking - currentCost);
            const netPct = currentCost === 0 ? 0 : Math.round((netProfit / currentCost) * 100);

            const EditableBox = ({label, value, editing, setEditing, input, setInput, onSave, tip, color='#fff', placeholder}) => (
              <div className="glass" style={{borderRadius:12,padding:'12px 8px',textAlign:'center',cursor:'pointer',border: editing ? '1px solid rgba(212,168,83,0.5)' : '1px solid rgba(255,255,255,0.08)',minWidth:0,boxSizing:'border-box'}} onClick={() => {if(!editing){setEditing(true);setInput(value != null ? String(value) : '');}}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:3}}>
                  <p className="text-dim" style={{fontSize:9,textTransform:'uppercase',letterSpacing:0.8,whiteSpace:'nowrap'}}>{label}</p>
                  <Icons.Edit size={8} color="#475569"/>
                  {tip && <InfoTip text={tip}/>}
                </div>
                {editing ? (
                  <div style={{marginTop:6,display:'flex',alignItems:'center',justifyContent:'center',gap:3}}>
                    <span style={{fontSize:18,fontWeight:700,color:'#d4a853'}}>$</span>
                    <input autoFocus type="number" value={input} onChange={e => setInput(e.target.value)}
                      onKeyDown={e => { if(e.key==='Enter'){onSave();} if(e.key==='Escape'){setEditing(false);} }}
                      onBlur={onSave}
                      style={{width:70,fontSize:18,fontWeight:700,color:'#fff',background:'transparent',border:'none',borderBottom:'2px solid #d4a853',outline:'none',textAlign:'center',fontFamily:'DM Sans, sans-serif'}}
                      onClick={e => e.stopPropagation()}/>
                  </div>
                ) : (
                  <p style={{fontSize:18,fontWeight:700,color,marginTop:6}}>{value != null ? fmt(value) : (placeholder || '--')}</p>
                )}
                {!editing && <p className="text-dim" style={{fontSize:8,marginTop:3}}>tap to edit</p>}
              </div>
            );

            return (
            <div className="glass" style={{borderRadius:16,padding:16,marginBottom:16}}>
              <h3 style={{fontSize:16,fontWeight:700,color:'#fff',marginBottom:14}}>Valuation</h3>
              {/* 2x2 price boxes */}
              <div style={{display:'grid',gridTemplateColumns:'repeat(2, 1fr)',gap:10,marginBottom:12,width:'100%',boxSizing:'border-box'}}>
                <EditableBox label="What I Paid" value={currentCost} editing={editingCost} setEditing={setEditingCost} input={costInput} setInput={setCostInput} tip="Total you spent acquiring this item."
                  onSave={() => {
                    const v = parseFloat(costInput);
                    if (!isNaN(v) && v >= 0) {
                      setItems(prev => prev.map(it => it.id === selected.id ? {...it, cost: v} : it));
                    }
                    setEditingCost(false);
                  }}/>
                <EditableBox label="Asking Price" value={currentAsking} editing={editingAsking} setEditing={setEditingAsking} input={askingInput} setInput={setAskingInput} tip="The price you'd list this at if you sold today." color="#d4a853"
                  onSave={() => {
                    const v = parseFloat(askingInput);
                    if (!isNaN(v) && v >= 0) {
                      setItems(prev => prev.map(it => it.id === selected.id ? {...it, asking: v} : it));
                    }
                    setEditingAsking(false);
                  }}/>
                <EditableBox label="Market" value={selected.value} editing={editingMarket} setEditing={setEditingMarket} input={marketInput} setInput={setMarketInput} tip="Your estimate of fair market value based on comparable listings." color="#94a3b8"
                  onSave={() => {
                    const v = parseFloat(marketInput);
                    if (!isNaN(v) && v >= 0) {
                      setItems(prev => prev.map(it => it.id === selected.id ? {...it, value: v} : it));
                      recordPriceSnapshot(selected.id, v);
                    }
                    setEditingMarket(false);
                  }}/>
                <EditableBox label="Earnings" value={currentEarnings || null} editing={editingEarnings} setEditing={setEditingEarnings} input={earningsInput} setInput={setEarningsInput} tip="What you actually sold this item for, including any fees or deductions." color="#22c55e" placeholder="--"
                  onSave={() => {
                    const v = parseFloat(earningsInput);
                    if (!isNaN(v) && v >= 0) {
                      setItems(prev => prev.map(it => it.id === selected.id ? {...it, earnings: v} : it));
                      if (v > 0 && supabaseUserIdRef.current) {
                        logEvent(supabaseUserIdRef.current, 'item_sold', { name: selected.name, earnings: v, cost: selected.cost, profit: v - (selected.cost || 0) });
                      }
                    } else if (earningsInput === '' || earningsInput === '0') {
                      setItems(prev => prev.map(it => it.id === selected.id ? {...it, earnings: null} : it));
                    }
                    setEditingEarnings(false);
                  }}/>
              </div>

              {/* Sold Platform (only show when item is sold) */}
              {hasSold && (
                <div style={{marginBottom:12}}>
                  <p className="text-dim" style={{fontSize:9,textTransform:'uppercase',letterSpacing:0.8,marginBottom:4}}>Sold On</p>
                  <select value={selected.soldPlatform || ''} onChange={e => {
                    setItems(prev => prev.map(it => it.id === selected.id ? {...it, soldPlatform: e.target.value || null} : it));
                  }} style={{width:'100%',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:8,padding:'8px 10px',color:'#fff',fontSize:12,outline:'none',fontFamily:'DM Sans, sans-serif',cursor:'pointer'}}>
                    <option value="">Select platform...</option>
                    {compSourceOptions.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
              )}

              {/* Date fields */}
              <div style={{display:'grid',gridTemplateColumns: hasSold ? '1fr 1fr' : '1fr',gap:10,marginBottom:16}}>
                <div>
                  <p className="text-dim" style={{fontSize:9,textTransform:'uppercase',letterSpacing:0.8,marginBottom:4}}>Date Purchased</p>
                  <input type="date" value={selected.datePurchased || ''} onChange={e => {
                    setItems(prev => prev.map(it => it.id === selected.id ? {...it, datePurchased: e.target.value || null} : it));
                  }} style={{width:'100%',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:8,padding:'8px 10px',color:'#fff',fontSize:12,outline:'none',fontFamily:'DM Sans, sans-serif',colorScheme:'dark'}}/>
                </div>
                {hasSold && (
                  <div>
                    <p className="text-dim" style={{fontSize:9,textTransform:'uppercase',letterSpacing:0.8,marginBottom:4}}>Date Sold</p>
                    <input type="date" value={selected.dateSold || ''} onChange={e => {
                      setItems(prev => prev.map(it => it.id === selected.id ? {...it, dateSold: e.target.value || null} : it));
                    }} style={{width:'100%',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:8,padding:'8px 10px',color:'#fff',fontSize:12,outline:'none',fontFamily:'DM Sans, sans-serif',colorScheme:'dark'}}/>
                  </div>
                )}
              </div>

              {/* Metrics */}
              <div style={{borderTop:'1px solid rgba(255,255,255,0.08)',paddingTop:14,display:'flex',flexDirection:'column',gap:10}}>
                {/* Investment Return: asking vs paid */}
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div style={{display:'flex',alignItems:'center',gap:4}}>
                    <span className="text-muted" style={{fontSize:12}}>Investment Return</span>
                    <InfoTip text="Your return if you sell at your asking price. (Asking Price - What You Paid) / What You Paid."/>
                  </div>
                  <span style={{fontSize:14,fontWeight:700,color:investProfit>=0?'#4ade80':'#f87171',display:'flex',alignItems:'center',gap:4}}>
                    {investProfit>=0?<Icons.TrendUp size={14} color="#4ade80"/>:<Icons.TrendDown size={14} color="#f87171"/>}
                    {investProfit>=0?'+':''}{investPct}% ({investProfit>=0?'+':''}${Math.abs(investProfit).toLocaleString()})
                  </span>
                </div>
                {/* Resale Premium: asking vs market */}
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div style={{display:'flex',alignItems:'center',gap:4}}>
                    <span className="text-muted" style={{fontSize:12}}>Resale Premium</span>
                    <InfoTip text="How your asking price compares to market. Positive = you're priced above market."/>
                  </div>
                  <span style={{fontSize:14,fontWeight:700,color:resaleDiff>=0?'#4ade80':'#f87171',display:'flex',alignItems:'center',gap:4}}>
                    {resaleDiff>=0?<Icons.TrendUp size={14} color="#4ade80"/>:<Icons.TrendDown size={14} color="#f87171"/>}
                    {resaleDiff>=0?'+':''}{resalePct}% ({resaleDiff>=0?'+':''}${Math.abs(resaleDiff).toLocaleString()})
                  </span>
                </div>
                {/* Net Profit: conditional based on whether item sold */}
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',borderTop:'1px solid rgba(255,255,255,0.06)',paddingTop:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:4}}>
                    <span style={{fontSize:13,fontWeight:600,color:'#cbd5e1'}}>{hasSold ? 'Net Profit' : 'Net Profit if Sold'}</span>
                    <InfoTip text={hasSold ? "Your actual profit: what you earned minus what you paid." : "Your asking price minus what you paid. This is your projected profit if someone buys at your price."}/>
                  </div>
                  <span style={{fontSize:15,fontWeight:700,color:netProfit>=0?'#4ade80':'#f87171',display:'flex',alignItems:'center',gap:4}}>
                    {netProfit>=0?<Icons.TrendUp size={16} color="#4ade80"/>:<Icons.TrendDown size={16} color="#f87171"/>}
                    {netProfit>=0?'+':''}${Math.abs(netProfit).toLocaleString()}
                  </span>
                </div>
              </div>
            </div>
            );
          })()}

          {/* Price History Chart */}
          <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16}}>
            <h3 style={{fontSize:16,fontWeight:700,color:'#fff',marginBottom:12}}>Price History</h3>
            {(() => {
              const history = selected.priceHistory || [];
              if (history.length < 2) {
                return (
                  <div style={{padding:'20px 0',textAlign:'center'}}>
                    <Icons.Clock size={28} color="#475569"/>
                    <p className="text-dim" style={{fontSize:12,marginTop:8}}>{history.length === 0 ? 'No price history yet. Update market value to start tracking.' : 'Update market value again to see your price trend. Each change is recorded.'}</p>
                  </div>
                );
              }
              // SVG line chart
              const W = 300, H = 120, padX = 40, padY = 16;
              const values = history.map(h => h.value);
              const minV = Math.min(...values) * 0.95;
              const maxV = Math.max(...values) * 1.05;
              const rangeV = maxV - minV || 1;
              const points = history.map((h, i) => {
                const x = padX + (i / (history.length - 1)) * (W - padX - 8);
                const y = padY + (1 - (h.value - minV) / rangeV) * (H - padY * 2);
                return {x, y, ...h};
              });
              const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
              const areaPath = linePath + ` L${points[points.length-1].x},${H-padY} L${points[0].x},${H-padY} Z`;
              const isUp = values[values.length-1] >= values[0];
              const lineColor = isUp ? '#4ade80' : '#f87171';
              return (
                <div>
                  <svg viewBox={`0 0 ${W} ${H}`} style={{width:'100%',height:'auto'}}>
                    {/* Grid lines */}
                    {[0,0.25,0.5,0.75,1].map((pct,i) => {
                      const y = padY + pct * (H - padY * 2);
                      const val = Math.round(maxV - pct * rangeV);
                      return <React.Fragment key={i}>
                        <line x1={padX} y1={y} x2={W-8} y2={y} stroke="rgba(255,255,255,0.06)" strokeWidth="0.5"/>
                        {i % 2 === 0 && <text x={padX-4} y={y+3} fill="#475569" fontSize="7" textAnchor="end" fontFamily="DM Sans">${val.toLocaleString()}</text>}
                      </React.Fragment>;
                    })}
                    {/* Area fill */}
                    <path d={areaPath} fill={`${lineColor}12`}/>
                    {/* Line */}
                    <path d={linePath} fill="none" stroke={lineColor} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    {/* Dots */}
                    {points.map((p, i) => (
                      <circle key={i} cx={p.x} cy={p.y} r={i === points.length-1 ? 4 : 2.5} fill={i === points.length-1 ? lineColor : '#1e293b'} stroke={lineColor} strokeWidth="1.5"/>
                    ))}
                  </svg>
                  {/* Date labels */}
                  <div style={{display:'flex',justifyContent:'space-between',marginTop:4,paddingLeft:40}}>
                    <span className="text-dim" style={{fontSize:9}}>{new Date(history[0].date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>
                    <span className="text-dim" style={{fontSize:9}}>{new Date(history[history.length-1].date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>
                  </div>
                  {/* Summary */}
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:10,paddingTop:10,borderTop:'1px solid rgba(255,255,255,0.06)'}}>
                    <span className="text-dim" style={{fontSize:11}}>{history.length} data point{history.length>1?'s':''}</span>
                    <span style={{fontSize:12,fontWeight:600,color:lineColor}}>
                      {isUp?'+':''}{Math.round(((values[values.length-1]-values[0])/values[0])*100)}% overall
                    </span>
                  </div>
                </div>
              );
            })()}
          </div>

          {/* Comps */}
          <div className="glass" style={{borderRadius:16,padding:20,marginBottom:20}}>
            <h3 style={{fontSize:16,fontWeight:700,color:'#fff',marginBottom:16}}>Comparable Listings</h3>
            {getComps(selected.id).length === 0 && !addingComp && (
              <p className="text-dim" style={{fontSize:13,textAlign:'center',padding:'12px 0'}}>No comparables yet. Search below to find similar listings.</p>
            )}

            {/* Smart Search Links - category-aware */}
            {(() => {
              const searchTerms = (() => { const seen = new Set(); return [selected.name, selected.brand, selected.model].filter(Boolean).join(' ').split(/\s+/).filter(w => { const l = w.toLowerCase(); if (seen.has(l)) return false; seen.add(l); return true; }).join(' '); })();
              const searches = getMarketplacesForCategory(selected.category, searchTerms);
              return (
                <div style={{marginBottom:12}}>
                  <p style={{fontSize:11,color:'#64748b',marginBottom:8,textTransform:'uppercase',letterSpacing:0.5}}>Quick Search (tap to find comps)</p>
                  <div style={{display:'flex',flexWrap:'wrap',gap:8}}>
                    {searches.map(s => (
                      <a key={s.name} href={s.url} target="_blank" rel="noopener noreferrer" style={{
                        background:s.bg, border:`1px solid ${s.color}33`, borderRadius:20,
                        padding:'6px 14px', fontSize:12, fontWeight:600, color:s.color,
                        textDecoration:'none', display:'inline-flex', alignItems:'center', gap:4,
                      }}>
                        {s.name} ‚Üó
                      </a>
                    ))}
                  </div>
                  <p style={{fontSize:11,color:'#334155',marginTop:8,lineHeight:1.4}}>Find a listing, then tap "Add Comparable" below to enter the price.</p>
                </div>
              );
            })()}
            <div style={{display:'flex',flexDirection:'column',gap:10}}>
              {getComps(selected.id).map(c => (
                editingCompId === c.id ? (
                  <div key={c.id} className="glass anim-fade" style={{borderRadius:12,padding:14}}>
                    <div style={{display:'flex',flexDirection:'column',gap:8}}>
                      <input className="form-input" value={compForm.title} onChange={e => updateCompForm('title',e.target.value)} placeholder="Listing title" style={inputStyle}/>
                      <input className="form-input" value={compForm.url} onChange={e => updateCompForm('url',e.target.value)} placeholder="URL" style={inputStyle}/>
                      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
                        <div style={{position:'relative'}}>
                          <span style={{position:'absolute',left:14,top:'50%',transform:'translateY(-50%)',color:'#64748b',fontSize:14,fontWeight:600}}>$</span>
                          <input className="form-input" type="number" value={compForm.price} onChange={e => updateCompForm('price',e.target.value)} placeholder="Price" style={{...inputStyle,paddingLeft:28}}/>
                        </div>
                        <select value={compForm.source} onChange={e => updateCompForm('source',e.target.value)} style={{...inputStyle,cursor:'pointer'}}>
                          {compSourceOptions.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                      </div>
                      <select value={compForm.condition} onChange={e => updateCompForm('condition',e.target.value)} style={{...inputStyle,cursor:'pointer'}}>
                        {['New','Like New','Excellent','Very Good','Good','Fair'].map(co => <option key={co} value={co}>{co}</option>)}
                      </select>
                      <div style={{display:'flex',gap:8}}>
                        <button onClick={() => {
                          if (!compForm.title || !compForm.price) return;
                          setItems(prev => prev.map(it => it.id === selected.id ? {...it, comps: (it.comps||[]).map(comp => comp.id === c.id ? {...comp, title:compForm.title, url:compForm.url, price:parseFloat(compForm.price), source:compForm.source, condition:compForm.condition} : comp)} : it));
                          setTimeout(() => recalcMarketFromComps(selected.id), 50);
                          setEditingCompId(null);
                          setCompForm({title:'',url:'',price:'',source:'eBay',condition:'Good'});
                        }} className="gradient-amber" style={{flex:1,border:'none',borderRadius:10,padding:'10px 0',fontSize:13,fontWeight:700,color:'#000',cursor:'pointer'}}>Save</button>
                        <button onClick={() => {setEditingCompId(null);setCompForm({title:'',url:'',price:'',source:'eBay',condition:'Good'});}} style={{flex:1,background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:10,padding:'10px 0',color:'#fff',fontSize:13,fontWeight:600,cursor:'pointer'}}>Cancel</button>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div key={c.id} className="glass glass-hover" style={{borderRadius:12,padding:14,position:'relative'}}>
                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
                      <span className="text-dim" style={{fontSize:11,textTransform:'uppercase',letterSpacing:0.5}}>{c.source}</span>
                      <span className="text-gold" style={{fontWeight:700,fontSize:14}}>{fmt(c.price)}</span>
                    </div>
                    <p className="truncate" style={{color:'#fff',fontSize:13,marginBottom:6}}>{c.title}</p>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                      <div>
                        <span className="text-dim" style={{fontSize:11}}>{c.condition}</span>
                        <span className="text-dim" style={{fontSize:11,marginLeft:8}}>{c.date}</span>
                      </div>
                      <div style={{display:'flex',gap:6}}>
                        <button onClick={(e) => {e.stopPropagation();setEditingCompId(c.id);setCompForm({title:c.title,url:c.url||'',price:String(c.price),source:c.source,condition:c.condition});}} style={{background:'rgba(255,255,255,0.08)',border:'none',borderRadius:6,padding:'4px 8px',cursor:'pointer',display:'flex',alignItems:'center',gap:4}}>
                          <Icons.Edit size={12} color="#94a3b8"/><span style={{fontSize:10,color:'#94a3b8'}}>Edit</span>
                        </button>
                        <button onClick={(e) => {e.stopPropagation();if(confirm('Delete this comparable?')){setItems(prev => prev.map(it => it.id === selected.id ? {...it, comps: (it.comps||[]).filter(comp => comp.id !== c.id)} : it));setTimeout(() => recalcMarketFromComps(selected.id), 50);}}} style={{background:'rgba(239,68,68,0.1)',border:'none',borderRadius:6,padding:'4px 8px',cursor:'pointer',display:'flex',alignItems:'center',gap:4}}>
                          <span style={{fontSize:10,color:'#f87171'}}>Delete</span>
                        </button>
                      </div>
                    </div>
                  </div>
                )
              ))}
            </div>

            {/* Add Comp Form */}
            {addingComp ? (
              <div className="glass anim-fade" style={{borderRadius:12,padding:16,marginTop:10}}>
                <p style={{fontSize:13,fontWeight:600,color:'#fff',marginBottom:12}}>Add Comparable Listing</p>
                <div style={{display:'flex',flexDirection:'column',gap:10}}>
                  <input className="form-input" value={compForm.title} onChange={e => updateCompForm('title',e.target.value)} placeholder="Listing title (e.g. Sony A7III Body Only)" style={inputStyle}/>
                  <input className="form-input" value={compForm.url} onChange={e => updateCompForm('url',e.target.value)} placeholder="URL (paste eBay/Poshmark link)" style={inputStyle}/>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                    <div style={{position:'relative'}}>
                      <span style={{position:'absolute',left:14,top:'50%',transform:'translateY(-50%)',color:'#64748b',fontSize:14,fontWeight:600}}>$</span>
                      <input className="form-input" type="number" value={compForm.price} onChange={e => updateCompForm('price',e.target.value)} placeholder="Price" style={{...inputStyle,paddingLeft:28}}/>
                    </div>
                    <select value={compForm.source} onChange={e => updateCompForm('source',e.target.value)} style={{...inputStyle,cursor:'pointer'}}>
                      {compSourceOptions.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                  </div>
                  <select value={compForm.condition} onChange={e => updateCompForm('condition',e.target.value)} style={{...inputStyle,cursor:'pointer'}}>
                    {['New','Like New','Excellent','Very Good','Good','Fair'].map(co => <option key={co} value={co}>{co}</option>)}
                  </select>
                  <div style={{display:'flex',gap:10}}>
                    <button onClick={() => {
                      if (!compForm.title || !compForm.price) return;
                      const newComp = {
                        id: Date.now(),
                        source: compForm.source,
                        title: compForm.title,
                        price: parseFloat(compForm.price),
                        condition: compForm.condition,
                        date: 'just now',
                        url: compForm.url,
                      };
                      setItems(prev => prev.map(it => it.id === selected.id ? {...it, comps: [...(it.comps||[]), newComp]} : it));
                      setTimeout(() => recalcMarketFromComps(selected.id), 50);
                      if (supabaseUserIdRef.current) logEvent(supabaseUserIdRef.current, 'comp_added', { itemName: selected.name, compTitle: newComp.title, price: newComp.price, source: newComp.source });
                      setCompForm({title:'',url:'',price:'',source:'eBay',condition:'Good'});
                      setAddingComp(false);
                    }} className="gradient-amber" style={{flex:1,border:'none',borderRadius:10,padding:'12px 0',fontSize:13,fontWeight:700,color:'#000',cursor:'pointer'}}>
                      Save Comp
                    </button>
                    <button onClick={() => {setAddingComp(false);setCompForm({title:'',url:'',price:'',source:'eBay',condition:'Good'});}} style={{flex:1,background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:10,padding:'12px 0',color:'#fff',fontSize:13,fontWeight:600,cursor:'pointer'}}>
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            ) : (
              <button onClick={() => {setAddingComp(true);setEditingCompId(null);setCompForm({title:'',url:'',price:'',source:'eBay',condition:'Good'});}} className="glass glass-hover" style={{width:'100%',border:'1px solid rgba(255,255,255,0.12)',borderRadius:12,padding:'14px 0',fontSize:13,fontWeight:600,color:'#d4a853',cursor:'pointer',background:'rgba(255,255,255,0.04)',display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginTop:10}}>
                <Icons.Plus size={16} color="#d4a853"/>Add Comparable
              </button>
            )}
          </div>

          {/* Community Comps */}
          <div className="glass" style={{borderRadius:16,padding:20,marginBottom:20}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
              <div>
                <h3 style={{fontSize:16,fontWeight:700,color:'#fff'}}>Community Comps</h3>
                <p className="text-dim" style={{fontSize:11}}>From other Pr√Ñperty users</p>
              </div>
              <button onClick={async () => {
                setCommunityComps([]);
                const comps = await fetchCommunityComps(selected.name, selected.brand);
                // Filter out comps the user already has
                const existingTitles = new Set((selected.comps || []).map(c => (c.title + c.price).toLowerCase()));
                const filtered = comps.filter(c => !existingTitles.has((c.title + c.price).toLowerCase()));
                setCommunityComps(filtered);
                if (supabaseUserIdRef.current) logEvent(supabaseUserIdRef.current, 'community_comps_loaded', { itemName: selected.name, resultsCount: filtered.length });
              }} style={{background:'rgba(168,85,247,0.15)',border:'1px solid rgba(168,85,247,0.3)',borderRadius:10,padding:'8px 14px',fontSize:12,fontWeight:600,color:'#c084fc',cursor:'pointer'}}>
                Load
              </button>
            </div>

            {communityComps.length === 0 ? (
              <p className="text-dim" style={{fontSize:12,textAlign:'center',padding:'8px 0'}}>Tap "Load" to find comps from the community. The more users add, the better the data gets!</p>
            ) : (
              <div style={{display:'flex',flexDirection:'column',gap:8}}>
                {communityComps.slice(0, 8).map((c, ci) => (
                  <div key={ci} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:12,background:'rgba(168,85,247,0.06)',border:'1px solid rgba(168,85,247,0.15)',borderRadius:12}}>
                    <div style={{flex:1,minWidth:0}}>
                      <p className="truncate" style={{color:'#fff',fontSize:13}}>{c.title}</p>
                      <p className="text-dim" style={{fontSize:10}}>{c.source} ¬∑ {c.condition}{c.fromItem ? ` ¬∑ via "${c.fromItem}"` : ''}</p>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:8,flexShrink:0}}>
                      <span className="text-gold" style={{fontWeight:700,fontSize:14}}>{fmt(c.price)}</span>
                      <button onClick={() => {
                        const newComp = { id: Date.now() + ci, source: c.source || 'Community', title: c.title, price: c.price, condition: c.condition || 'Good', date: 'community', url: c.url || '' };
                        setItems(prev => prev.map(it => it.id === selected.id ? {...it, comps: [...(it.comps||[]), newComp]} : it));
                        setTimeout(() => recalcMarketFromComps(selected.id), 50);
                        setCommunityComps(prev => prev.filter((_, i) => i !== ci));
                        if (supabaseUserIdRef.current) logEvent(supabaseUserIdRef.current, 'community_comp_used', { itemName: selected.name, compTitle: c.title, price: c.price });
                      }} style={{background:'rgba(212,168,83,0.2)',border:'1px solid rgba(212,168,83,0.3)',borderRadius:8,padding:'4px 10px',fontSize:11,fontWeight:700,color:'#d4a853',cursor:'pointer',whiteSpace:'nowrap'}}>
                        + Add
                      </button>
                    </div>
                  </div>
                ))}
                {communityComps.length > 8 && <p className="text-dim" style={{fontSize:11,textAlign:'center'}}>+ {communityComps.length - 8} more available</p>}
              </div>
            )}
          </div>

          {/* Actions */}
          <div style={{display:'flex',gap:8,marginBottom:12}}>
            <button onClick={() => { const sq = encodeURIComponent((() => { const seen = new Set(); return [selected.name, selected.brand, selected.model].filter(Boolean).join(' ').split(/\s+/).filter(w => { const l = w.toLowerCase(); if (seen.has(l)) return false; seen.add(l); return true; }).join(' '); })()); window.open(`https://www.ebay.com/sch/i.html?_nkw=${sq}&LH_Sold=1&LH_Complete=1`, '_blank'); }} className="gradient-amber" style={{flex:1,border:'none',borderRadius:14,padding:'16px 0',fontSize:14,fontWeight:700,color:'#000',cursor:'pointer'}}>
              Search Market
            </button>
            <button onClick={() => goResearch([selected.name, selected.brand, selected.model].filter(Boolean).join(' ').split(/\s+/).filter((w,i,a) => a.findIndex(x => x.toLowerCase() === w.toLowerCase()) === i).join(' '))} style={{flex:1,border:'1px solid rgba(212,168,83,0.4)',borderRadius:14,padding:'16px 0',fontSize:14,fontWeight:700,color:'#d4a853',cursor:'pointer',background:'rgba(212,168,83,0.08)'}}>
              Deep Research ‚Üí
            </button>
          </div>
          <button onClick={() => setScreen('pricing')} style={{width:'100%',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',fontSize:14,fontWeight:600,color:'#fff',cursor:'pointer',background:'rgba(255,255,255,0.06)',display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginBottom:8}}>
            Refresh Price
          </button>
          <button onClick={() => { initEditForm(selected); setScreen('edit-item'); }} className="glass glass-hover" style={{width:'100%',border:'1px solid rgba(255,255,255,0.12)',borderRadius:14,padding:'14px 0',fontSize:14,fontWeight:600,color:'#fff',cursor:'pointer',background:'rgba(255,255,255,0.06)',display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginBottom:8}}>
            <Icons.Edit size={16}/>Edit Item
          </button>
          <button onClick={() => {
            if (confirm('Delete this item from your inventory?')) {
              const delId = selected.id;
              const delName = selected.name;
              setItems(prev => prev.filter(it => it.id !== delId));
              if (supabaseUserIdRef.current) {
                syncDeleteItem(delId);
                logEvent(supabaseUserIdRef.current, 'item_deleted', { name: delName });
              }
              setScreen('inventory');
            }
          }} style={{width:'100%',background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.25)',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:600,color:'#f87171',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
            Delete Item
          </button>
        </div>
      </div>
    );
  };

  const PricingScreen = () => (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px'}}>
        <button onClick={() => selected ? setScreen('detail') : setScreen('home')} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
        <h1 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Market Analysis</h1>
        <div style={{width:24}}/>
      </div>

      <div style={{padding:'0 24px'}}>
        {/* Item summary */}
        {selected && (
          <div className="glass" style={{borderRadius:14,padding:16,display:'flex',alignItems:'center',gap:14,marginBottom:20}}>
            <div style={{width:48,height:48,borderRadius:10,background:'linear-gradient(135deg,#334155,#1e293b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}}>{selected.emoji}</div>
            <div>
              <p style={{fontWeight:600,color:'#fff',fontSize:14}}>{selected.name}</p>
              <p className="text-dim" style={{fontSize:12,marginTop:2}}>{selected.condition}</p>
            </div>
          </div>
        )}

        {/* Price Range - calculated from real comps */}
        {(() => {
          const comps = selected ? getComps(selected.id) : [];
          const prices = comps.map(c => c.price).filter(p => p > 0);
          const hasComps = prices.length > 0;
          const low = hasComps ? Math.min(...prices) : (selected ? selected.value * 0.85 : 0);
          const high = hasComps ? Math.max(...prices) : (selected ? selected.value * 1.15 : 0);
          const avg = hasComps ? Math.round(prices.reduce((s,p) => s+p, 0) / prices.length) : (selected ? selected.value : 0);
          const confidence = Math.min(95, prices.length * 20 + (prices.length >= 3 ? 15 : 0));
          const markerPos = hasComps && high > low ? Math.round(((avg - low) / (high - low)) * 100) : 50;
          return (
          <div className="glass" style={{borderRadius:16,padding:20,marginBottom:16}}>
            <h3 style={{fontSize:16,fontWeight:700,color:'#fff',marginBottom:16}}>Estimated Market Range</h3>
            {/* Range bar */}
            <div style={{height:8,borderRadius:4,background:'linear-gradient(90deg,#f87171,#d4a853,#4ade80)',marginBottom:20,position:'relative'}}>
              <div style={{position:'absolute',top:-4,left:`${markerPos}%`,transform:'translateX(-50%)',width:16,height:16,borderRadius:8,background:'#fff',border:'3px solid #d4a853',boxShadow:'0 0 12px rgba(212,168,83,0.4)'}}/>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
              {[{l:'Low',p:Math.round(low),c:'#f87171'},{l:'Average',p:avg,c:'#d4a853'},{l:'High',p:Math.round(high),c:'#4ade80'}].map((r,i) => (
                <div key={i} className="glass" style={{borderRadius:12,padding:12,textAlign:'center'}}>
                  <p className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:1}}>{r.l}</p>
                  <p style={{fontSize:18,fontWeight:700,color:r.c,marginTop:6}}>{fmt(r.p)}</p>
                </div>
              ))}
            </div>

            {/* Confidence */}
            <div style={{marginTop:16,paddingTop:16,borderTop:'1px solid rgba(255,255,255,0.08)'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <span className="text-muted" style={{fontSize:13}}>Confidence Score</span>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <div style={{width:80,height:6,borderRadius:3,background:'rgba(255,255,255,0.08)',overflow:'hidden'}}>
                    <div style={{width:`${confidence}%`,height:'100%',borderRadius:3,background:'linear-gradient(90deg,#d4a853,#b8860b)'}}/>
                  </div>
                  <span className="text-gold" style={{fontWeight:700,fontSize:13}}>{confidence}%</span>
                </div>
              </div>
              <p className="text-dim" style={{fontSize:11,marginTop:6}}>{hasComps ? `Based on ${prices.length} comp${prices.length>1?'s':''}` : 'Add comparables to improve accuracy'}</p>
            </div>
          </div>
          );
        })()}

        {/* Smart Search Links on Pricing Screen - category-aware */}
        {selected && (() => {
          const searchTerms = (() => { const seen = new Set(); return [selected.name, selected.brand, selected.model].filter(Boolean).join(' ').split(/\s+/).filter(w => { const l = w.toLowerCase(); if (seen.has(l)) return false; seen.add(l); return true; }).join(' '); })();
          const searches = getMarketplacesForCategory(selected.category, searchTerms);
          return (
            <div className="glass" style={{borderRadius:16,padding:20,marginBottom:20}}>
              <h3 style={{fontSize:16,fontWeight:700,color:'#fff',marginBottom:6}}>Research Prices</h3>
              <p className="text-dim" style={{fontSize:12,marginBottom:14}}>Tap a marketplace to search for similar listings. Find one? Go back and add it as a comparable.</p>
              <div style={{display:'flex',flexWrap:'wrap',gap:8}}>
                {searches.map(s => (
                  <a key={s.name} href={s.url} target="_blank" rel="noopener noreferrer" style={{
                    background:s.bg, border:`1px solid ${s.color}33`, borderRadius:20,
                    padding:'8px 16px', fontSize:13, fontWeight:600, color:s.color,
                    textDecoration:'none', display:'inline-flex', alignItems:'center', gap:4,
                  }}>
                    {s.name} ‚Üó
                  </a>
                ))}
              </div>
            </div>
          );
        })()}

        {/* Comps */}
        <div className="glass" style={{borderRadius:16,padding:20,marginBottom:20}}>
          <h3 style={{fontSize:16,fontWeight:700,color:'#fff',marginBottom:16}}>Comparable Listings</h3>
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {(selected ? getComps(selected.id) : getComps(1)).map(c => (
              <div key={c.id} className="glass glass-hover" style={{borderRadius:12,padding:14,cursor:'pointer'}}>
                <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
                  <span style={{fontWeight:600,color:'#fff',fontSize:13}}>{c.source}</span>
                  <span className="text-gold" style={{fontWeight:700,fontSize:14}}>{fmt(c.price)}</span>
                </div>
                <p className="truncate text-muted" style={{fontSize:12,marginBottom:6}}>{c.title}</p>
                <div style={{display:'flex',justifyContent:'space-between'}}>
                  <span className="text-dim" style={{fontSize:11}}>{c.condition}</span>
                  <span className="text-dim" style={{fontSize:11}}>{c.date}</span>
                </div>
              </div>
            ))}
          </div>
        </div>

        <button onClick={() => alert('Price alerts are coming soon! Check the Alerts tab for inventory insights.')} style={{width:'100%',border:'1px solid rgba(212,168,83,0.3)',borderRadius:14,padding:'16px 0',fontSize:15,fontWeight:600,color:'#94a3b8',cursor:'pointer',background:'rgba(255,255,255,0.03)',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
          <Icons.Bell size={16} color="#94a3b8"/>Set Price Alert <span style={{fontSize:10,background:'rgba(212,168,83,0.15)',color:'#d4a853',padding:'2px 6px',borderRadius:4,fontWeight:700}}>SOON</span>
        </button>
      </div>
    </div>
  );

  const SoldItemsScreen = () => {
    const sold = soldItems
      .filter(i => (soldFilter === 'All' || i.category === soldFilter) && i.name.toLowerCase().includes(soldSearch.toLowerCase()))
      .sort((a,b) => {
        if (soldSort === 'recent') return (b.dateSold || b.createdAt || '').localeCompare(a.dateSold || a.createdAt || '');
        if (soldSort === 'profit') return ((b.earnings - b.cost) - (a.earnings - a.cost));
        if (soldSort === 'fastest') {
          const daysA = a.dateSold && (a.datePurchased || a.createdAt) ? Math.round((new Date(a.dateSold) - new Date(a.datePurchased || a.createdAt)) / (1000*60*60*24)) : 9999;
          const daysB = b.dateSold && (b.datePurchased || b.createdAt) ? Math.round((new Date(b.dateSold) - new Date(b.datePurchased || b.createdAt)) / (1000*60*60*24)) : 9999;
          return daysA - daysB;
        }
        return 0;
      });
    const totalSoldProfit = soldItems.reduce((s,i) => s + (i.earnings - i.cost), 0);
    const avgDaysToSell = (() => {
      const withDates = soldItems.filter(i => i.dateSold && (i.datePurchased || i.createdAt));
      if (withDates.length === 0) return '--';
      const total = withDates.reduce((s,i) => s + Math.round((new Date(i.dateSold) - new Date(i.datePurchased || i.createdAt)) / (1000*60*60*24)), 0);
      return Math.round(total / withDates.length);
    })();
    const getDaysToSell = (item) => {
      if (!item.dateSold || !(item.datePurchased || item.createdAt)) return '--';
      return Math.round((new Date(item.dateSold) - new Date(item.datePurchased || item.createdAt)) / (1000*60*60*24));
    };
    return (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'20px 24px',position:'sticky',top:0,background:'linear-gradient(180deg,#0a0a0f 80%,transparent)',zIndex:20}}>
        <button onClick={() => setScreen('home')} style={{background:'none',border:'none',color:'#fff',cursor:'pointer'}}><Icons.ArrowLeft size={24}/></button>
        <h1 style={{fontSize:18,fontWeight:700,color:'#fff'}}>Sold Items</h1>
        <div style={{width:24}}/>
      </div>

      <div style={{padding:'0 24px'}}>
        {/* Summary stats */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10,marginBottom:16}}>
          <div className="glass" style={{borderRadius:12,padding:12,textAlign:'center'}}>
            <p className="text-dim" style={{fontSize:9,textTransform:'uppercase',letterSpacing:0.8}}>Earnings</p>
            <p style={{fontSize:16,fontWeight:700,color:'#22c55e',marginTop:4}}>{totalEarnings > 0 ? fmt(totalEarnings) : '--'}</p>
          </div>
          <div className="glass" style={{borderRadius:12,padding:12,textAlign:'center'}}>
            <p className="text-dim" style={{fontSize:9,textTransform:'uppercase',letterSpacing:0.8}}>Items Sold</p>
            <p style={{fontSize:16,fontWeight:700,color:'#fff',marginTop:4}}>{soldItems.length}</p>
          </div>
          <div className="glass" style={{borderRadius:12,padding:12,textAlign:'center'}}>
            <p className="text-dim" style={{fontSize:9,textTransform:'uppercase',letterSpacing:0.8}}>Avg Days</p>
            <p style={{fontSize:16,fontWeight:700,color:'#d4a853',marginTop:4}}>{avgDaysToSell}{avgDaysToSell !== '--' ? 'd' : ''}</p>
          </div>
        </div>

        {/* Net profit banner */}
        <div className="glass" style={{borderRadius:12,padding:14,marginBottom:16,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span className="text-muted" style={{fontSize:13}}>Net Profit (all sold)</span>
          <span style={{fontSize:16,fontWeight:700,color:totalSoldProfit>=0?'#4ade80':'#f87171'}}>
            {totalSoldProfit>=0?'+':''}${Math.abs(totalSoldProfit).toLocaleString()}
          </span>
        </div>

        {/* Search */}
        <div className="glass" style={{borderRadius:12,padding:'12px 14px',display:'flex',alignItems:'center',gap:10,marginBottom:14}}>
          <Icons.Search size={16} color="#64748b"/>
          <input value={soldSearch} onChange={e => setSoldSearch(e.target.value)} placeholder="Search sold items..." style={{background:'none',border:'none',outline:'none',color:'#fff',fontSize:14,width:'100%'}}/>
        </div>

        {/* Filters */}
        <div className="scroll-hide" style={{display:'flex',gap:8,overflowX:'auto',marginBottom:12}}>
          {['All', ...categoryOptions.filter(cat => soldItems.some(i => i.category === cat))].map(f => (
            <button key={f} onClick={() => setSoldFilter(f)} style={{padding:'8px 16px',borderRadius:10,fontSize:13,fontWeight:600,whiteSpace:'nowrap',cursor:'pointer',border: soldFilter===f?'none':'1px solid rgba(255,255,255,0.1)',background: soldFilter===f?'linear-gradient(135deg,#d4a853,#b8860b)':'rgba(255,255,255,0.04)',color: soldFilter===f?'#000':'#fff'}}>{f}</button>
          ))}
        </div>

        {/* Sort */}
        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
          <Icons.Filter size={14} color="#64748b"/>
          <select value={soldSort} onChange={e => setSoldSort(e.target.value)} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',color:'#fff',fontSize:13,borderRadius:8,padding:'6px 10px',outline:'none'}}>
            <option value="recent">Most Recent Sale</option>
            <option value="profit">Highest Profit</option>
            <option value="fastest">Fastest Sale</option>
          </select>
        </div>

        {/* Sold items list */}
        {sold.length === 0 ? (
          <div style={{textAlign:'center',padding:'48px 24px'}}>
            <p style={{fontSize:48,marginBottom:12}}>üí∞</p>
            <p style={{fontSize:16,fontWeight:600,color:'#fff',marginBottom:6}}>{soldItems.length === 0 ? 'No sold items yet' : 'No matches found'}</p>
            <p className="text-muted" style={{fontSize:13,lineHeight:1.5}}>{soldItems.length === 0 ? 'Enter earnings on any item to mark it as sold and track your velocity.' : 'Try a different search or filter.'}</p>
          </div>
        ) : (
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {sold.map((item,i) => {
              const profit = item.earnings - item.cost;
              const days = getDaysToSell(item);
              return (
                <div key={item.id} onClick={() => goItem(item.id)} className="glass glass-hover anim-right" style={{borderRadius:14,padding:16,cursor:'pointer',animationDelay:`${i*0.04}s`}}>
                  <div style={{display:'flex',alignItems:'center',gap:14}}>
                    <div style={{width:48,height:48,borderRadius:12,background:'linear-gradient(135deg,#334155,#1e293b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:24,flexShrink:0}}>{item.emoji}</div>
                    <div style={{flex:1,minWidth:0}}>
                      <p className="truncate" style={{fontWeight:600,color:'#fff',fontSize:14}}>{item.name}</p>
                      <div style={{display:'flex',alignItems:'center',gap:8,marginTop:4}}>
                        <span className="text-dim" style={{fontSize:11}}>Cost: {fmt(item.cost)}</span>
                        <span style={{color:'#475569'}}>‚Üí</span>
                        <span style={{fontSize:11,color:'#22c55e',fontWeight:600}}>Sold: {fmt(item.earnings)}</span>
                      </div>
                    </div>
                    <div style={{textAlign:'right',flexShrink:0}}>
                      <p style={{fontWeight:700,fontSize:14,color:profit>=0?'#4ade80':'#f87171'}}>{profit>=0?'+':''}${Math.abs(profit).toLocaleString()}</p>
                      <p className="text-dim" style={{fontSize:11,marginTop:3}}>{days !== '--' ? `${days}d` : '--'}</p>
                    </div>
                  </div>
                  <div style={{display:'flex',gap:8,alignItems:'center',marginTop:8}}>
                    {item.soldPlatform && <span style={{fontSize:10,color:'#d4a853',background:'rgba(212,168,83,0.1)',padding:'2px 8px',borderRadius:6,fontWeight:600}}>via {item.soldPlatform}</span>}
                    {item.dateSold && <span className="text-dim" style={{fontSize:10}}>Sold {new Date(item.dateSold).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</span>}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
    );
  };

  const AlertsScreen = () => {
    const alertColors = {'Below Cost':'#f87171','Underpriced':'#fbbf24','Priced High':'#f97316','Needs Comps':'#3b82f6','Set Market Value':'#8b5cf6','Strong Performer':'#4ade80','New Item Added':'#d4a853'};
    return (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      <div style={{padding:'20px 24px'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
          <h1 style={{fontSize:24,fontWeight:700,color:'#fff'}}>Alerts</h1>
          {alerts.length > 0 && <span style={{background:'rgba(212,168,83,0.15)',color:'#d4a853',fontSize:12,fontWeight:700,padding:'4px 10px',borderRadius:20}}>{alerts.length}</span>}
        </div>
        {alerts.length === 0 ? (
          <div style={{textAlign:'center',padding:'60px 24px'}}>
            <p style={{fontSize:48,marginBottom:12}}>üîî</p>
            <p style={{fontSize:16,fontWeight:600,color:'#fff',marginBottom:6}}>No alerts yet</p>
            <p className="text-muted" style={{fontSize:13,lineHeight:1.5}}>Add items to your inventory and alerts will appear here based on your pricing, market values, and comparables.</p>
          </div>
        ) : (
        <div style={{display:'flex',flexDirection:'column',gap:10}}>
          {alerts.map((a,i) => {
            const Ic = Icons[a.iconKey] || Icons.Bell;
            const accentColor = alertColors[a.type] || '#d4a853';
            return (
              <div key={a.id} onClick={() => { if(a.itemId) { setSelectedId(a.itemId); setScreen('detail'); }}} className="glass glass-hover anim-right" style={{borderRadius:14,padding:16,cursor:'pointer',animationDelay:`${i*0.05}s`,borderLeft:`3px solid ${accentColor}`}}>
                <div style={{display:'flex',alignItems:'flex-start',gap:14}}>
                  <div style={{width:40,height:40,borderRadius:10,background:`${accentColor}18`,display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,fontSize:20}}>{a.emoji||'üì¶'}</div>
                  <div style={{flex:1}}>
                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                      <span style={{fontSize:10,fontWeight:700,textTransform:'uppercase',letterSpacing:0.5,color:accentColor,background:`${accentColor}15`,padding:'2px 8px',borderRadius:6}}>{a.type}</span>
                    </div>
                    <p style={{fontWeight:500,color:'#e2e8f0',fontSize:13,marginTop:6,lineHeight:1.4}}>{a.msg}</p>
                  </div>
                  <Icons.ChevronRight size={16} color={accentColor} style={{flexShrink:0,marginTop:2}}/>
                </div>
              </div>
            );
          })}
        </div>
        )}
      </div>
    </div>
  );
  };

  const ProfileScreen = () => (
    <div className="scroll-hide" style={{height:'100%',overflowY:'auto',paddingBottom:100}}>
      <div style={{padding:'20px 24px'}}>
        <h1 style={{fontSize:24,fontWeight:700,color:'#fff',marginBottom:20}}>Profile</h1>

        {/* User card */}
        <div className="glass" style={{borderRadius:16,padding:24,textAlign:'center',marginBottom:20}}>
          <div className="gradient-amber" style={{width:72,height:72,borderRadius:36,display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,fontWeight:700,color:'#000',margin:'0 auto 14px'}}>{userInitial}</div>
          <h2 style={{fontSize:22,fontWeight:700,color:'#fff'}}>{userName}</h2>
          <p className="text-muted" style={{fontSize:13,marginTop:6}}>{userEmail}</p>
          <button onClick={() => setEditingProfile(true)} style={{background:'none',border:'none',color:'#d4a853',fontSize:13,fontWeight:600,cursor:'pointer',marginTop:8}}>Edit Profile</button>
        </div>

        {/* Stats */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:20}}>
          {[['Member Since', profile?.createdAt ? new Date(profile.createdAt).toLocaleDateString('en-US',{month:'short',year:'numeric'}) : '--'],['Items Tracked',String(items.length)],['Total Value',fmt(totalValue)],['Avg Value',fmt(avgValue)]].map(([k,v],i) => (
            <div key={i} className="glass" style={{borderRadius:12,padding:14,textAlign:'center'}}>
              <p className="text-dim" style={{fontSize:10,textTransform:'uppercase',letterSpacing:1}}>{k}</p>
              <p style={{fontSize:18,fontWeight:700,color:'#fff',marginTop:6}}>{v}</p>
            </div>
          ))}
        </div>

        {/* Data Management */}
        <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:20}}>
          <button onClick={() => {
            const data = { profile, items, exportedAt: new Date().toISOString(), version: '1.0' };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `praperty-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }} className="glass glass-hover" style={{width:'100%',borderRadius:12,padding:'14px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',cursor:'pointer',border:'1px solid rgba(255,255,255,0.08)',background:'rgba(255,255,255,0.04)'}}>
            <div style={{display:'flex',alignItems:'center',gap:12}}>
              <Icons.Download size={18} color="#4ade80"/>
              <div>
                <span style={{fontWeight:600,color:'#fff',fontSize:14,display:'block'}}>Export Backup</span>
                <span className="text-dim" style={{fontSize:11}}>Download all your data as a file</span>
              </div>
            </div>
            <Icons.ChevronRight size={18} color="#475569"/>
          </button>

          <label className="glass glass-hover" style={{width:'100%',borderRadius:12,padding:'14px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',cursor:'pointer',border:'1px solid rgba(255,255,255,0.08)',background:'rgba(255,255,255,0.04)'}}>
            <div style={{display:'flex',alignItems:'center',gap:12}}>
              <Icons.Upload size={18} color="#3b82f6"/>
              <div>
                <span style={{fontWeight:600,color:'#fff',fontSize:14,display:'block'}}>Import Backup</span>
                <span className="text-dim" style={{fontSize:11}}>Restore from a backup file</span>
              </div>
            </div>
            <Icons.ChevronRight size={18} color="#475569"/>
            <input type="file" accept=".json" style={{display:'none'}} onChange={e => {
              const file = e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (ev) => {
                try {
                  const data = JSON.parse(ev.target.result);
                  if (!data.items || !Array.isArray(data.items)) { alert('Invalid backup file.'); return; }
                  const count = data.items.length;
                  if (confirm(`This backup contains ${count} item${count!==1?'s':''}. Import will replace all current data. Continue?`)) {
                    if (data.profile) setProfile(data.profile);
                    setItems(data.items);
                    alert('Backup restored successfully!');
                  }
                } catch(err) { alert('Could not read backup file. Make sure it is a valid Pr√Ñperty export.'); }
              };
              reader.readAsText(file);
              e.target.value = '';
            }}/>
          </label>
        </div>

        {/* Settings */}
        <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:20}}>
          {[['Bell','Notification Preferences'],['Dollar','Default Currency'],['Shield','Privacy & Security'],['Help','Help & Support']].map(([ic,label],i) => {
            const Ic = Icons[ic];
            return (
              <button key={i} onClick={() => alert(label + ' is coming soon!')} className="glass" style={{width:'100%',borderRadius:12,padding:'14px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',cursor:'pointer',border:'1px solid rgba(255,255,255,0.06)',background:'rgba(255,255,255,0.02)',opacity:0.6}}>
                <div style={{display:'flex',alignItems:'center',gap:12}}>
                  <Ic size={18} color="#64748b"/>
                  <span style={{fontWeight:600,color:'#94a3b8',fontSize:14}}>{label}</span>
                </div>
                <span style={{fontSize:9,background:'rgba(212,168,83,0.12)',color:'#d4a853',padding:'2px 6px',borderRadius:4,fontWeight:700}}>SOON</span>
              </button>
            );
          })}
        </div>

        {/* Danger zone */}
        <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:20}}>
          <button onClick={() => setShowClearConfirm(true)} className="glass glass-hover" style={{width:'100%',borderRadius:12,padding:'14px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',cursor:'pointer',border:'1px solid rgba(239,68,68,0.15)',background:'rgba(239,68,68,0.06)'}}>
            <div style={{display:'flex',alignItems:'center',gap:12}}>
              <Icons.Trash2 size={18} color="#f87171"/>
              <span style={{fontWeight:600,color:'#f87171',fontSize:14}}>Clear All Items</span>
            </div>
            <Icons.ChevronRight size={18} color="#475569"/>
          </button>
        </div>

        <button onClick={() => { setShowTutorial(true); setTutorialStep(0); }} className="glass glass-hover" style={{width:'100%',borderRadius:12,padding:'14px 0',border:'1px solid rgba(255,255,255,0.08)',background:'rgba(255,255,255,0.04)',color:'#d4a853',fontSize:15,fontWeight:600,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginBottom:12}}>
          <Icons.Help size={16} color="#d4a853"/>Replay Tutorial
        </button>

        <button onClick={() => {
          if (confirm('Sign out? This will clear your profile but your inventory data stays on this device. You can sign back in by entering your name and email.')) {
            if (supabaseUserIdRef.current) logEvent(supabaseUserIdRef.current, 'user_signout', {});
            localStorage.removeItem('item2value_profile');
            setProfile(null);
            supabaseUserIdRef.current = null;
            setScreen('setup');
          }
        }} style={{width:'100%',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(239,68,68,0.2)',borderRadius:12,padding:'14px 0',color:'#f87171',fontSize:15,fontWeight:600,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
          <Icons.LogOut size={16} color="#f87171"/>Sign Out
        </button>
      </div>

      {/* Edit Profile Modal */}
      {editingProfile && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.7)',backdropFilter:'blur(8px)',zIndex:100,display:'flex',alignItems:'center',justifyContent:'center',padding:24}} onClick={() => setEditingProfile(false)}>
          <div onClick={e => e.stopPropagation()} style={{background:'#1a1a2e',border:'1px solid rgba(255,255,255,0.12)',borderRadius:20,padding:28,maxWidth:340,width:'100%'}}>
            <h3 style={{fontSize:18,fontWeight:700,color:'#fff',marginBottom:20,textAlign:'center'}}>Edit Profile</h3>
            <FormField label="Name" required>
              <input ref={profileNameRef} className="form-input" defaultValue={userName} style={inputStyle}/>
            </FormField>
            <FormField label="Email" required>
              <input ref={profileEmailRef} className="form-input" type="email" defaultValue={userEmail} style={inputStyle}/>
            </FormField>
            <div style={{display:'flex',gap:10,marginTop:8}}>
              <button onClick={() => setEditingProfile(false)} style={{flex:1,padding:'12px 0',borderRadius:12,border:'1px solid rgba(255,255,255,0.15)',background:'rgba(255,255,255,0.06)',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer'}}>Cancel</button>
              <button onClick={() => {
                const name = profileNameRef.current?.value?.trim() || '';
                const email = profileEmailRef.current?.value?.trim() || '';
                if (!name) { alert('Please enter your name.'); return; }
                if (!email) { alert('Please enter your email.'); return; }
                const updatedProfile = {...profile, name, email};
                setProfile(updatedProfile);
                setEditingProfile(false);
                // Re-sync profile to Supabase
                syncProfile(updatedProfile).then(userId => {
                  if (userId) supabaseUserIdRef.current = userId;
                });
              }} className="gradient-amber" style={{flex:1,padding:'12px 0',borderRadius:12,border:'none',fontSize:14,fontWeight:700,color:'#000',cursor:'pointer'}}>Save</button>
            </div>
          </div>
        </div>
      )}

      {/* Clear All Confirmation Modal */}
      {showClearConfirm && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.7)',backdropFilter:'blur(8px)',zIndex:100,display:'flex',alignItems:'center',justifyContent:'center',padding:24}} onClick={() => setShowClearConfirm(false)}>
          <div onClick={e => e.stopPropagation()} style={{background:'#1a1a2e',border:'1px solid rgba(255,255,255,0.12)',borderRadius:20,padding:28,maxWidth:340,width:'100%',textAlign:'center'}}>
            <div style={{width:56,height:56,borderRadius:28,background:'rgba(239,68,68,0.15)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 16px'}}>
              <Icons.AlertTriangle size={28} color="#f87171"/>
            </div>
            <h3 style={{fontSize:18,fontWeight:700,color:'#fff',marginBottom:8}}>Clear All Items?</h3>
            <p style={{fontSize:14,color:'#94a3b8',lineHeight:1.5,marginBottom:24}}>This will permanently delete all items in your inventory. This action cannot be undone.</p>
            <div style={{display:'flex',gap:10}}>
              <button onClick={() => setShowClearConfirm(false)} style={{flex:1,padding:'12px 0',borderRadius:12,border:'1px solid rgba(255,255,255,0.15)',background:'rgba(255,255,255,0.06)',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer'}}>Cancel</button>
              <button onClick={() => { setItems([]); localStorage.removeItem('item2value_items'); setShowClearConfirm(false); }} style={{flex:1,padding:'12px 0',borderRadius:12,border:'none',background:'#ef4444',color:'#fff',fontSize:14,fontWeight:700,cursor:'pointer'}}>Yes, Delete All</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  const renderScreen = () => {
    switch(screen) {
      case 'setup': return SetupScreen();
      case 'home': return HomeScreen();
      case 'scan': return ScanScreen();
      case 'ai': return AIScreen();
      case 'add-item': return AddItemScreen();
      case 'inventory': return InventoryScreen();
      case 'detail': return DetailScreen();
      case 'edit-item': return EditItemScreen();
      case 'pricing': return PricingScreen();
      case 'sold-items': return SoldItemsScreen();
      case 'discover': return DiscoverScreen();
      case 'research': return ResearchScreen();
      case 'alerts': return AlertsScreen();
      case 'profile': return ProfileScreen();
      default: return HomeScreen();
    }
  };

  // After camera scan animation, go to AI screen
  useEffect(() => {
    if (analyzing || aiDone) setScreen('ai');
  }, [analyzing, aiDone]);

  const showTabs = !['scan','add-item','edit-item','setup'].includes(screen);
  const tabs = [
    {id:'home',icon:'Home',label:'Home'},
    {id:'inventory',icon:'Package',label:'Inventory'},
    {id:'scan',icon:'Camera',label:'Scan',primary:true},
    {id:'discover',icon:'Search',label:'Discover'},
    {id:'profile',icon:'User',label:'Profile'},
  ];

  return (
    <div style={{width:'100%',height:'100vh',display:'flex',justifyContent:'center',background:'#06060b'}}>
      <div style={{width:'100%',maxWidth:390,height:'100%',position:'relative',overflow:'hidden',background:'linear-gradient(180deg,#0a0a0f,#0d0d14,#0a0a0f)'}}>
        {renderScreen()}

        {/* Tab Bar */}
        {showTabs && (
          <div style={{position:'absolute',bottom:0,left:0,right:0,background:'linear-gradient(to top,#0a0a0f 70%,transparent)',borderTop:'1px solid rgba(255,255,255,0.06)',padding:'8px 12px 16px',zIndex:30}}>
            <div style={{display:'flex',justifyContent:'space-around',alignItems:'center'}}>
              {tabs.map(tab => {
                const Ic = Icons[tab.icon];
                const active = screen === tab.id || (tab.id === 'home' && ['home','sold-items','alerts'].includes(screen)) || (tab.id === 'inventory' && ['inventory','detail','edit-item','pricing'].includes(screen)) || (tab.id === 'discover' && ['discover','research'].includes(screen));
                return (
                  <button key={tab.id} onClick={() => {
                    if (tab.id === 'scan') { setScanning(false); setAnalyzing(false); setAiDone(false); stopBarcodeScanner(); setScanStatus(''); setScanData(null); }
                    setScreen(tab.id);
                  }} style={{display:'flex',flexDirection:'column',alignItems:'center',gap:4,background:'none',border:'none',cursor:'pointer',padding:'6px 12px',borderRadius:10}}>
                    <div style={{padding:6,borderRadius:8,background: active?'rgba(212,168,83,0.15)':'transparent',position:'relative'}}>
                      <Ic size={20} color={active?'#d4a853':'#475569'}/>
                      {tab.id === 'alerts' && alerts.length > 0 && <div style={{position:'absolute',top:4,right:4,width:8,height:8,borderRadius:4,background:'#f87171',border:'2px solid #0a0a0f'}}/>}
                    </div>
                    <span style={{fontSize:10,fontWeight:600,color: active?'#d4a853':'#475569'}}>{tab.label}</span>
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* Onboarding Tutorial Overlay */}
        {showTutorial && (() => {
          const steps = [
            {
              emoji: 'üëã',
              title: 'Welcome to Pr√Ñperty!',
              body: 'Track your stuff like a portfolio. Know what you own, what it\'s worth, and when to sell.',
              tip: 'Let\'s walk through the basics.',
            },
            {
              emoji: 'üì¶',
              title: 'Add Your First Item',
              body: 'Tap the camera icon in the bottom nav to scan or manually add items. Include photos, brand, and what you paid.',
              tip: 'Tip: Photos make it easy to find comps later.',
            },
            {
              emoji: 'üîç',
              title: 'Research Comparable Prices',
              body: 'Open any item and scroll to "Comparable Listings." Use the quick search links to search eBay, Amazon, TCGPlayer, Chrono24, and 20+ marketplaces matched to your item category.',
              tip: 'The more comps you add, the more accurate your market value becomes.',
            },
            {
              emoji: 'üìä',
              title: 'Track Your Market Value',
              body: 'Your market value updates automatically based on comps you add. Check the Price History chart to see trends over time.',
              tip: 'Your home screen shows total portfolio value at a glance.',
            },
            {
              emoji: 'üí∞',
              title: 'Record Sales & Earnings',
              body: 'Sold something? Open the item, tap the Earnings box, and enter what you got. It auto-calculates your profit and shows up in Total Earnings.',
              tip: 'Track "Date Sold" too, so we can calculate sell velocity.',
            },
            {
              emoji: 'üíæ',
              title: 'Backup Your Data',
              body: 'Go to Profile and tap "Export Backup" to download your data. You can restore it anytime with "Import Backup."',
              tip: 'Your data syncs to the cloud automatically, but backups are extra insurance.',
            },
          ];
          const step = steps[tutorialStep];
          const isLast = tutorialStep === steps.length - 1;
          return (
            <div style={{position:'absolute',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.85)',backdropFilter:'blur(12px)',zIndex:200,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:32}} onClick={e => e.stopPropagation()}>
              {/* Progress dots */}
              <div style={{display:'flex',gap:6,marginBottom:32}}>
                {steps.map((_,i) => (
                  <div key={i} style={{width: i === tutorialStep ? 24 : 8, height:8, borderRadius:4, background: i === tutorialStep ? '#d4a853' : i < tutorialStep ? 'rgba(212,168,83,0.5)' : 'rgba(255,255,255,0.12)', transition:'all 0.3s'}}/>
                ))}
              </div>

              {/* Card */}
              <div className="anim-fade" key={tutorialStep} style={{background:'rgba(255,255,255,0.06)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:24,padding:32,maxWidth:320,width:'100%',textAlign:'center'}}>
                <div style={{fontSize:48,marginBottom:16}}>{step.emoji}</div>
                <h2 style={{fontSize:20,fontWeight:700,color:'#fff',marginBottom:10}}>{step.title}</h2>
                <p style={{fontSize:14,color:'#cbd5e1',lineHeight:1.6,marginBottom:16}}>{step.body}</p>
                <p style={{fontSize:12,color:'#d4a853',fontStyle:'italic'}}>{step.tip}</p>
              </div>

              {/* Buttons */}
              <div style={{display:'flex',gap:12,marginTop:28,width:'100%',maxWidth:320}}>
                {tutorialStep > 0 && (
                  <button onClick={() => setTutorialStep(prev => prev - 1)} style={{flex:1,padding:'14px 0',borderRadius:14,border:'1px solid rgba(255,255,255,0.15)',background:'rgba(255,255,255,0.06)',color:'#fff',fontSize:14,fontWeight:600,cursor:'pointer'}}>Back</button>
                )}
                <button onClick={() => {
                  if (isLast) {
                    setShowTutorial(false);
                    localStorage.setItem('item2value_tutorial_done', 'true');
                  } else {
                    setTutorialStep(prev => prev + 1);
                  }
                }} className="gradient-amber" style={{flex:1,padding:'14px 0',borderRadius:14,border:'none',fontSize:14,fontWeight:700,color:'#000',cursor:'pointer'}}>
                  {isLast ? 'Get Started!' : 'Next'}
                </button>
              </div>

              {/* Skip */}
              {!isLast && (
                <button onClick={() => { setShowTutorial(false); localStorage.setItem('item2value_tutorial_done', 'true'); }} style={{background:'none',border:'none',color:'#475569',fontSize:13,cursor:'pointer',marginTop:16,padding:8}}>
                  Skip tutorial
                </button>
              )}
            </div>
          );
        })()}
      </div>
    </div>
  );
};

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
