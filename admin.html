<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PrÃ„perty Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'DM Sans', system-ui, sans-serif;
    background: #06060b;
    color: #e2e8f0;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }
  h1,h2,h3,h4 { font-family: 'Sora', system-ui, sans-serif; }

  .container { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }

  /* Header */
  .header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 0 32px; border-bottom: 1px solid rgba(255,255,255,0.06);
    margin-bottom: 32px;
  }
  .header h1 { font-size: 24px; font-weight: 700; }
  .header h1 span { background: linear-gradient(135deg, #d4a853, #b8860b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .header .badge {
    background: rgba(212,168,83,0.15); color: #d4a853; font-size: 11px; font-weight: 600;
    padding: 4px 10px; border-radius: 20px; letter-spacing: 1px; text-transform: uppercase;
  }
  .refresh-btn {
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
    color: #94a3b8; border-radius: 10px; padding: 10px 18px; cursor: pointer;
    font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .refresh-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

  /* Stat Cards */
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px; margin-bottom: 32px;
  }
  .stat-card {
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px; padding: 20px; position: relative; overflow: hidden;
  }
  .stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  }
  .stat-card.blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
  .stat-card.gold::before { background: linear-gradient(90deg, #d4a853, #b8860b); }
  .stat-card.green::before { background: linear-gradient(90deg, #22c55e, #4ade80); }
  .stat-card.purple::before { background: linear-gradient(90deg, #a855f7, #c084fc); }
  .stat-card.red::before { background: linear-gradient(90deg, #ef4444, #f87171); }
  .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .stat-value { font-size: 28px; font-weight: 700; font-family: 'Sora', sans-serif; }
  .stat-sub { font-size: 12px; color: #475569; margin-top: 4px; }

  /* Sections */
  .section { margin-bottom: 32px; }
  .section-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px;
  }
  .section-title { font-size: 18px; font-weight: 600; }
  .section-subtitle { font-size: 12px; color: #64748b; }

  /* Tables */
  .table-wrap {
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px; overflow: hidden;
  }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    text-align: left; padding: 14px 16px; font-size: 11px; font-weight: 600;
    color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.02);
  }
  tbody td {
    padding: 14px 16px; font-size: 13px; color: #cbd5e1;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }
  tbody tr:hover { background: rgba(255,255,255,0.03); }
  tbody tr:last-child td { border-bottom: none; }

  .tag {
    display: inline-block; padding: 3px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
  }
  .tag-blue { background: rgba(59,130,246,0.15); color: #60a5fa; }
  .tag-green { background: rgba(34,197,94,0.15); color: #4ade80; }
  .tag-gold { background: rgba(212,168,83,0.15); color: #d4a853; }
  .tag-red { background: rgba(239,68,68,0.15); color: #f87171; }
  .tag-purple { background: rgba(168,85,247,0.15); color: #c084fc; }

  /* Charts */
  .chart-container {
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px; padding: 20px;
  }
  .bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 160px; padding-top: 8px; }
  .bar-col { display: flex; flex-direction: column; align-items: center; flex: 1; }
  .bar {
    width: 100%; border-radius: 6px 6px 0 0; min-height: 4px;
    transition: height 0.6s ease;
  }
  .bar-label { font-size: 10px; color: #64748b; margin-top: 8px; text-align: center; }
  .bar-value { font-size: 10px; color: #94a3b8; margin-bottom: 4px; font-weight: 600; }

  /* Category Breakdown */
  .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
  .cat-card {
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
    border-radius: 12px; padding: 14px; text-align: center;
  }
  .cat-emoji { font-size: 24px; margin-bottom: 6px; }
  .cat-name { font-size: 12px; color: #94a3b8; margin-bottom: 2px; }
  .cat-count { font-size: 18px; font-weight: 700; font-family: 'Sora', sans-serif; }

  /* Event feed */
  .event-feed { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
  .event-item {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04);
    border-radius: 12px;
  }
  .event-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .event-text { font-size: 13px; color: #cbd5e1; flex: 1; }
  .event-time { font-size: 11px; color: #475569; white-space: nowrap; }

  /* Loading */
  .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: #64748b; font-size: 14px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { width: 20px; height: 20px; border: 2px solid rgba(212,168,83,0.2); border-top-color: #d4a853; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px; }

  /* Responsive */
  @media (max-width: 768px) {
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .header h1 { font-size: 20px; }
    .stat-value { font-size: 22px; }
  }
  @media (max-width: 480px) {
    .stats-grid { grid-template-columns: 1fr; }
    .container { padding: 16px 12px; }
  }

  /* Two column layout */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }

  /* Auth gate */
  .auth-gate {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 32px;
  }
  .auth-gate input {
    width: 100%; max-width: 320px; padding: 14px 16px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06);
    color: #fff; font-size: 14px; font-family: 'DM Sans', sans-serif;
    margin-bottom: 12px; outline: none;
  }
  .auth-gate input:focus { border-color: rgba(212,168,83,0.5); }
  .auth-gate button {
    width: 100%; max-width: 320px; padding: 14px; border: none; border-radius: 12px;
    background: linear-gradient(135deg, #d4a853, #b8860b);
    color: #000; font-size: 15px; font-weight: 700; cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
</style>
</head>
<body>
<div id="app"></div>
<script>
const SUPABASE_URL = 'https://tzasuddushojjurbzqfe.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YXN1ZGR1c2hvamp1cmJ6cWZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjU1MTUsImV4cCI6MjA4NjE0MTUxNX0.vKGMXcTkddpCwzH-zRPPzbVNWCvx5UNHNxdtvFZNZIM';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Admin password (simple gate, not Supabase auth)
const ADMIN_PASS = 'praperty2025';

const app = document.getElementById('app');

const fmt = (n) => '$' + Number(n || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
const fmtDate = (d) => {
  if (!d) return '--';
  const dt = new Date(d);
  return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
};
const timeAgo = (d) => {
  if (!d) return '';
  const now = new Date();
  const then = new Date(d);
  const mins = Math.floor((now - then) / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days + 'd ago';
};

const eventColors = {
  user_signup: '#3b82f6',
  app_open: '#64748b',
  item_added: '#22c55e',
  item_deleted: '#ef4444',
  item_sold: '#d4a853',
  comp_added: '#a855f7',
  user_signout: '#f97316',
};
const eventLabels = {
  user_signup: 'New User',
  app_open: 'App Open',
  item_added: 'Item Added',
  item_deleted: 'Item Deleted',
  item_sold: 'Item Sold',
  comp_added: 'Comp Added',
  user_signout: 'Sign Out',
};

let state = { authed: false, loading: true, profiles: [], items: [], events: [] };

function showAuth() {
  app.innerHTML = `
    <div class="auth-gate">
      <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,#d4a853,#b8860b);display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:20px">ðŸ’Ž</div>
      <h2 style="font-size:22px;font-weight:700;margin-bottom:6px">PrÃ„perty Admin</h2>
      <p style="font-size:13px;color:#64748b;margin-bottom:24px">Enter admin password to continue</p>
      <input type="password" id="pass-input" placeholder="Password" onkeydown="if(event.key==='Enter')tryAuth()"/>
      <button onclick="tryAuth()">Sign In</button>
      <p id="auth-error" style="font-size:12px;color:#ef4444;margin-top:12px;display:none">Wrong password</p>
    </div>
  `;
}

function tryAuth() {
  const val = document.getElementById('pass-input').value;
  if (val === ADMIN_PASS) {
    state.authed = true;
    loadData();
  } else {
    document.getElementById('auth-error').style.display = 'block';
  }
}

async function loadData() {
  app.innerHTML = '<div class="loading"><div class="spinner"></div>Loading dashboard data...</div>';

  try {
    const [profilesRes, itemsRes, eventsRes] = await Promise.all([
      sb.from('profiles').select('*').order('created_at', { ascending: false }),
      sb.from('items').select('*').order('created_at', { ascending: false }),
      sb.from('analytics_events').select('*').order('created_at', { ascending: false }).limit(200),
    ]);

    state.profiles = profilesRes.data || [];
    state.items = (itemsRes.data || []).map(it => ({
      ...it,
      photos: typeof it.photos === 'string' ? JSON.parse(it.photos) : (it.photos || []),
      comps: typeof it.comps === 'string' ? JSON.parse(it.comps) : (it.comps || []),
      price_history: typeof it.price_history === 'string' ? JSON.parse(it.price_history) : (it.price_history || []),
    }));
    state.events = eventsRes.data || [];
    state.loading = false;
    render();
  } catch(e) {
    app.innerHTML = '<div class="loading" style="color:#ef4444">Error loading data: ' + e.message + '</div>';
  }
}

function render() {
  const { profiles, items, events } = state;

  // Compute stats
  const totalUsers = profiles.length;
  const totalItems = items.length;
  const totalValue = items.reduce((s, it) => s + (it.value || 0), 0);
  const totalEarnings = items.reduce((s, it) => s + (it.earnings || 0), 0);
  const soldItems = items.filter(it => it.earnings && it.earnings > 0);
  const totalSold = soldItems.length;
  const avgItemsPerUser = totalUsers > 0 ? (totalItems / totalUsers).toFixed(1) : 0;
  const totalProfit = soldItems.reduce((s, it) => s + (it.earnings - (it.cost || 0)), 0);

  // Category breakdown
  const catCounts = {};
  const catEmojis = { Fashion: 'ðŸ‘—', Electronics: 'ðŸ“±', Home: 'ðŸ ', Sports: 'âš½', Collectibles: 'ðŸŽ¨', Automotive: 'ðŸš—', Books: 'ðŸ“š', Toys: 'ðŸ§¸', Tools: 'ðŸ”§', Other: 'ðŸ“¦' };
  items.forEach(it => {
    const cat = it.category || 'Other';
    catCounts[cat] = (catCounts[cat] || 0) + 1;
  });

  // Users table data
  const userItemCounts = {};
  const userValues = {};
  const userEarnings = {};
  items.forEach(it => {
    const uid = it.user_id;
    userItemCounts[uid] = (userItemCounts[uid] || 0) + 1;
    userValues[uid] = (userValues[uid] || 0) + (it.value || 0);
    userEarnings[uid] = (userEarnings[uid] || 0) + (it.earnings || 0);
  });

  // Velocity stats (days to sell)
  const velocities = soldItems.map(it => {
    const sold = it.date_sold ? new Date(it.date_sold) : null;
    const purchased = it.date_purchased ? new Date(it.date_purchased) : (it.created_at ? new Date(it.created_at) : null);
    if (sold && purchased) return Math.max(1, Math.floor((sold - purchased) / 86400000));
    return null;
  }).filter(v => v !== null);
  const avgDaysToSell = velocities.length > 0 ? (velocities.reduce((s,v) => s+v, 0) / velocities.length).toFixed(0) : '--';

  // Events by type count (last 7 days)
  const weekAgo = new Date(Date.now() - 7 * 86400000);
  const recentEvents = events.filter(e => new Date(e.created_at) > weekAgo);
  const eventTypeCounts = {};
  recentEvents.forEach(e => { eventTypeCounts[e.event_type] = (eventTypeCounts[e.event_type] || 0) + 1; });

  // Top items by value
  const topItems = [...items].sort((a, b) => (b.value || 0) - (a.value || 0)).slice(0, 10);

  app.innerHTML = `
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div>
          <h1><span>PrÃ„perty</span> Admin</h1>
          <p style="font-size:12px;color:#475569;margin-top:4px">Real-time analytics dashboard</p>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <span class="badge">Live</span>
          <button class="refresh-btn" onclick="loadData()">â†» Refresh</button>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card blue">
          <div class="stat-label">Total Users</div>
          <div class="stat-value">${totalUsers}</div>
          <div class="stat-sub">${avgItemsPerUser} items/user avg</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-label">Total Items</div>
          <div class="stat-value">${totalItems}</div>
          <div class="stat-sub">${Object.keys(catCounts).length} categories</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">Total Portfolio Value</div>
          <div class="stat-value">${fmt(totalValue)}</div>
          <div class="stat-sub">Across all users</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">Total Earnings</div>
          <div class="stat-value">${fmt(totalEarnings)}</div>
          <div class="stat-sub">${totalSold} items sold</div>
        </div>
        <div class="stat-card red">
          <div class="stat-label">Avg Days to Sell</div>
          <div class="stat-value">${avgDaysToSell}</div>
          <div class="stat-sub">Item velocity</div>
        </div>
      </div>

      <!-- Two Column: Users + Recent Events -->
      <div class="two-col" style="margin-bottom:32px">
        <!-- Users Table -->
        <div class="section">
          <div class="section-header">
            <div>
              <div class="section-title">Users</div>
              <div class="section-subtitle">${totalUsers} registered</div>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>User</th><th>Items</th><th>Value</th><th>Earned</th><th>Joined</th></tr></thead>
              <tbody>
                ${profiles.map(p => `
                  <tr>
                    <td>
                      <div style="font-weight:600;color:#fff">${p.name || 'Unknown'}</div>
                      <div style="font-size:11px;color:#475569">${p.email}</div>
                    </td>
                    <td><span class="tag tag-blue">${userItemCounts[p.id] || 0}</span></td>
                    <td>${fmt(userValues[p.id] || 0)}</td>
                    <td>${(userEarnings[p.id] || 0) > 0 ? '<span class="tag tag-green">' + fmt(userEarnings[p.id]) + '</span>' : '<span style="color:#475569">--</span>'}</td>
                    <td style="font-size:12px;color:#64748b">${fmtDate(p.created_at)}</td>
                  </tr>
                `).join('')}
                ${profiles.length === 0 ? '<tr><td colspan="5" style="text-align:center;color:#475569;padding:32px">No users yet</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Event Feed -->
        <div class="section">
          <div class="section-header">
            <div>
              <div class="section-title">Activity Feed</div>
              <div class="section-subtitle">Last 200 events</div>
            </div>
          </div>
          <div class="event-feed">
            ${events.slice(0, 50).map(e => {
              const meta = e.metadata || {};
              const color = eventColors[e.event_type] || '#64748b';
              const label = eventLabels[e.event_type] || e.event_type;
              let detail = meta.name || meta.itemName || '';
              if (e.event_type === 'item_sold' && meta.earnings) detail += ' for ' + fmt(meta.earnings);
              if (e.event_type === 'comp_added' && meta.compTitle) detail = meta.itemName + ': ' + meta.compTitle;
              return `
                <div class="event-item">
                  <div class="event-dot" style="background:${color}"></div>
                  <div class="event-text">
                    <span style="font-weight:600;color:${color}">${label}</span>
                    ${detail ? '<span style="color:#64748b"> Â· </span><span>' + detail + '</span>' : ''}
                  </div>
                  <div class="event-time">${timeAgo(e.created_at)}</div>
                </div>
              `;
            }).join('')}
            ${events.length === 0 ? '<div style="text-align:center;color:#475569;padding:32px">No events yet</div>' : ''}
          </div>
        </div>
      </div>

      <!-- Event Type Breakdown (last 7 days) -->
      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Events (Last 7 Days)</div>
            <div class="section-subtitle">${recentEvents.length} total events</div>
          </div>
        </div>
        <div class="chart-container">
          <div class="bar-chart">
            ${Object.entries(eventTypeCounts).sort((a,b) => b[1] - a[1]).map(([type, count]) => {
              const maxCount = Math.max(...Object.values(eventTypeCounts), 1);
              const height = Math.max(8, (count / maxCount) * 140);
              const color = eventColors[type] || '#64748b';
              const label = eventLabels[type] || type;
              return `
                <div class="bar-col">
                  <div class="bar-value">${count}</div>
                  <div class="bar" style="height:${height}px;background:${color}"></div>
                  <div class="bar-label">${label}</div>
                </div>
              `;
            }).join('')}
            ${Object.keys(eventTypeCounts).length === 0 ? '<div style="text-align:center;color:#475569;padding:32px;width:100%">No events in the last 7 days</div>' : ''}
          </div>
        </div>
      </div>

      <!-- Two Column: Category Breakdown + Top Items -->
      <div class="two-col" style="margin-bottom:32px">
        <!-- Category Breakdown -->
        <div class="section">
          <div class="section-header">
            <div>
              <div class="section-title">Categories</div>
              <div class="section-subtitle">Item distribution</div>
            </div>
          </div>
          <div class="cat-grid">
            ${Object.entries(catCounts).sort((a,b) => b[1] - a[1]).map(([cat, count]) => `
              <div class="cat-card">
                <div class="cat-emoji">${catEmojis[cat] || 'ðŸ“¦'}</div>
                <div class="cat-name">${cat}</div>
                <div class="cat-count">${count}</div>
              </div>
            `).join('')}
            ${Object.keys(catCounts).length === 0 ? '<div style="color:#475569;padding:20px;text-align:center">No items yet</div>' : ''}
          </div>
        </div>

        <!-- Top Items -->
        <div class="section">
          <div class="section-header">
            <div>
              <div class="section-title">Highest Value Items</div>
              <div class="section-subtitle">Top 10 across all users</div>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th></th><th>Item</th><th>Category</th><th>Cost</th><th>Value</th><th>Status</th></tr></thead>
              <tbody>
                ${topItems.map(it => {
                  const owner = profiles.find(p => p.id === it.user_id);
                  const isSold = it.earnings && it.earnings > 0;
                  return `
                    <tr>
                      <td style="font-size:20px;text-align:center">${it.emoji || 'ðŸ“¦'}</td>
                      <td>
                        <div style="font-weight:600;color:#fff">${it.name}</div>
                        <div style="font-size:11px;color:#475569">${owner ? owner.name : 'Unknown'}</div>
                      </td>
                      <td><span class="tag tag-gold">${it.category || 'Other'}</span></td>
                      <td>${fmt(it.cost)}</td>
                      <td style="font-weight:600;color:#d4a853">${fmt(it.value)}</td>
                      <td>${isSold ? '<span class="tag tag-green">SOLD ' + fmt(it.earnings) + '</span>' : '<span class="tag tag-blue">Active</span>'}</td>
                    </tr>
                  `;
                }).join('')}
                ${topItems.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#475569;padding:32px">No items yet</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- All Items Table -->
      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">All Items</div>
            <div class="section-subtitle">${totalItems} total items across ${totalUsers} users</div>
          </div>
        </div>
        <div class="table-wrap" style="max-height:600px;overflow-y:auto">
          <table>
            <thead><tr><th></th><th>Item</th><th>User</th><th>Category</th><th>Condition</th><th>Cost</th><th>Asking</th><th>Market</th><th>Earnings</th><th>Photos</th><th>Comps</th><th>Added</th></tr></thead>
            <tbody>
              ${items.map(it => {
                const owner = profiles.find(p => p.id === it.user_id);
                const photoCount = (it.photos || []).length;
                const compCount = (it.comps || []).length;
                const isSold = it.earnings && it.earnings > 0;
                return `
                  <tr>
                    <td style="font-size:18px">${it.emoji || 'ðŸ“¦'}</td>
                    <td>
                      <div style="font-weight:600;color:#fff;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${it.name}</div>
                      ${it.brand ? '<div style="font-size:11px;color:#475569">' + it.brand + (it.model ? ' ' + it.model : '') + '</div>' : ''}
                    </td>
                    <td style="font-size:12px">${owner ? owner.name : '<span style="color:#475569">--</span>'}</td>
                    <td><span class="tag tag-gold">${it.category || 'Other'}</span></td>
                    <td style="font-size:12px;color:#94a3b8">${it.condition || '--'}</td>
                    <td>${fmt(it.cost)}</td>
                    <td>${fmt(it.asking)}</td>
                    <td style="font-weight:600;color:#d4a853">${fmt(it.value)}</td>
                    <td>${isSold ? '<span class="tag tag-green">' + fmt(it.earnings) + '</span>' : '<span style="color:#475569">--</span>'}</td>
                    <td style="text-align:center">${photoCount > 0 ? '<span class="tag tag-purple">' + photoCount + '</span>' : '<span style="color:#475569">0</span>'}</td>
                    <td style="text-align:center">${compCount > 0 ? '<span class="tag tag-blue">' + compCount + '</span>' : '<span style="color:#475569">0</span>'}</td>
                    <td style="font-size:11px;color:#64748b;white-space:nowrap">${fmtDate(it.created_at)}</td>
                  </tr>
                `;
              }).join('')}
              ${items.length === 0 ? '<tr><td colspan="12" style="text-align:center;color:#475569;padding:32px">No items yet. Users need to add items in the app.</td></tr>' : ''}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sold Items Detail -->
      ${totalSold > 0 ? `
      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Sold Items Breakdown</div>
            <div class="section-subtitle">${totalSold} items, ${fmt(totalEarnings)} revenue, ${fmt(totalProfit)} profit</div>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th></th><th>Item</th><th>User</th><th>Cost</th><th>Sold For</th><th>Profit</th><th>Margin</th><th>Date Sold</th></tr></thead>
            <tbody>
              ${soldItems.sort((a,b) => (b.earnings || 0) - (a.earnings || 0)).map(it => {
                const owner = profiles.find(p => p.id === it.user_id);
                const profit = (it.earnings || 0) - (it.cost || 0);
                const margin = it.cost > 0 ? ((profit / it.cost) * 100).toFixed(0) : '--';
                return `
                  <tr>
                    <td style="font-size:18px">${it.emoji || 'ðŸ“¦'}</td>
                    <td style="font-weight:600;color:#fff">${it.name}</td>
                    <td style="font-size:12px">${owner ? owner.name : '--'}</td>
                    <td>${fmt(it.cost)}</td>
                    <td><span class="tag tag-green">${fmt(it.earnings)}</span></td>
                    <td style="font-weight:600;color:${profit >= 0 ? '#4ade80' : '#f87171'}">${profit >= 0 ? '+' : ''}${fmt(profit)}</td>
                    <td>${margin !== '--' ? margin + '%' : '--'}</td>
                    <td style="font-size:12px;color:#64748b">${it.date_sold ? fmtDate(it.date_sold) : '--'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      ` : ''}

      <div style="text-align:center;padding:32px 0;color:#334155;font-size:12px">
        PrÃ„perty Admin Dashboard Â· Data refreshes on page load Â· <span onclick="loadData()" style="color:#d4a853;cursor:pointer;text-decoration:underline">Refresh now</span>
      </div>
    </div>
  `;
}

// Init
showAuth();
</script>
</body>
</html>
